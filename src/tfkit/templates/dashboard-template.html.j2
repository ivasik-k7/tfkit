<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <style>
        :root {
            --bg-primary: {{ theme_colors.bg_primary }};
            --bg-secondary: {{ theme_colors.bg_secondary }};
            --bg-tertiary: {{ theme_colors.bg_tertiary }};
            --text-primary: {{ theme_colors.text_primary }};
            --text-secondary: {{ theme_colors.text_secondary }};
            --border: {{ theme_colors.border }};
            --accent: {{ theme_colors.accent }};
            --accent-secondary: {{ theme_colors.accent_secondary }};
            --success: {{ theme_colors.success }};
            --warning: {{ theme_colors.warning }};
            --danger: {{ theme_colors.danger }};
            --info: {{ theme_colors.info }};
            --accent-rgb: 59, 130, 246;
        }


        /* Base Styles for Structure */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .quick-actions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: {{ theme_colors.bg_secondary }}d0;
            border: 1px solid {{ theme_colors.border }};
            border-radius: 50px;
            padding: 12px 20px;
            display: flex;
            gap: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 9999;
            backdrop-filter: blur(10px);
        }
        .quick-action {
            background: {{ theme_colors.bg_primary }};
            border: 1px solid {{ theme_colors.border }};
            color: {{ theme_colors.text_primary }};
            padding: 12px 16px;
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            font-size: 0.9em;
            font-weight: 500;
        }
        .quick-action:hover {
            background: {{ theme_colors.accent }};
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px {{ theme_colors.accent }};
        }
        .quick-action:active {
            transform: translateY(0);
        }
    </style>
    <style>
        /* Command Palette Enhanced Styles */
        .command-palette {
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%) scale(0.95);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 32px 64px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
            width: 90%;
            max-width: 680px;
            max-height: 70vh;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .command-palette.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
        }

        .command-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--bg-secondary);
            position: relative;
        }

        .command-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg,
                    transparent 0%,
                    var(--border) 20%,
                    var(--border) 80%,
                    transparent 100%);
        }

        .command-input {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.3em;
            flex: 1;
            outline: none;
            font-weight: 500;
            padding: 8px 0;
            caret-color: var(--accent);
        }

        .command-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .command-shortcut {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75em;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-weight: 600;
            letter-spacing: 0.5px;
            border: 1px solid var(--border);
            opacity: 0.8;
        }

        .command-list {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
            padding: 8px 0;
            scroll-behavior: smooth;
        }

        .command-category {
            padding: 16px 24px 8px;
            font-size: 0.7em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            position: sticky;
            top: 0;
            z-index: 2;
            border-bottom: 1px solid var(--border);
            margin-bottom: 4px;
            opacity: 0.9;
        }

        .command-item {
            padding: 14px 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            margin: 2px 8px;
            border-radius: 10px;
            position: relative;
            background: transparent;
        }

        .command-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(4px);
            border-color: var(--border);
        }

        .command-item.selected {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            color: white;
            border-color: var(--accent);
            transform: translateX(8px);
            box-shadow: 0 6px 20px rgba(var(--accent-rgb), 0.3);
        }

        .command-item.selected .command-icon {
            color: white;
        }

        .command-item.selected .command-title,
        .command-item.selected .command-description {
            color: white;
        }

        .command-item.selected .command-shortcut-item {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .command-item.selected mark {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .command-icon {
            width: 20px;
            text-align: center;
            color: var(--accent);
            font-size: 1.1em;
            flex-shrink: 0;
            transition: color 0.2s ease;
        }

        .command-content {
            flex: 1;
            min-width: 0;
        }

        .command-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.95em;
            color: var(--text-primary);
            transition: color 0.2s ease;
        }

        .command-description {
            font-size: 0.82em;
            color: var(--text-secondary);
            line-height: 1.4;
            transition: color 0.2s ease;
        }

        .command-shortcut-item {
            background: var(--bg-primary);
            color: var(--text-secondary);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.72em;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-weight: 600;
            letter-spacing: 0.5px;
            border: 1px solid var(--border);
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .command-empty-state {
            padding: 48px 24px;
            text-align: center;
            color: var(--text-secondary);
        }

        .command-empty-state i {
            font-size: 2em;
            margin-bottom: 16px;
            opacity: 0.4;
        }

        .command-empty-hint {
            font-size: 0.85em;
            margin-top: 8px;
            opacity: 0.6;
        }

        /* Modal Styles - Enhanced with Better Animations */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(12px);
            z-index: 10002;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: modalFadeIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            will-change: opacity;
        }

        .modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) both;
            will-change: transform, opacity;
            transform-origin: center center;
        }

        .modal-header {
            padding: 28px 32px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
            position: relative;
        }

        .modal-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg,
                    transparent 0%,
                    var(--border) 15%,
                    var(--border) 85%,
                    transparent 100%);
        }

        .modal-header h3 {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            letter-spacing: -0.01em;
        }

        .modal-close {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1.3em;
            position: relative;
            overflow: hidden;
        }

        .modal-close::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(var(--accent-rgb), 0.1), transparent);
            transition: left 0.6s ease;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
            transform: scale(1.1) rotate(90deg);
        }

        .modal-close:hover::before {
            left: 100%;
        }

        .modal-body {
            padding: 28px 32px;
            overflow-y: auto;
            max-height: calc(85vh - 100px);
            scroll-behavior: smooth;
        }

        /* Help Modal Styles */
        .help-modal h3 {
            color: var(--text-primary);
            margin-bottom: 24px;
            font-size: 1.4em;
            font-weight: 700;
        }

        .shortcut-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 14px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .shortcut-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(6px);
            border-color: var(--accent);
            box-shadow: 0 4px 20px rgba(var(--accent-rgb), 0.15);
        }

        .shortcut-item .keys {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .shortcut-item kbd {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 10px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 0.9em;
            font-weight: 600;
            color: var(--text-primary);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .shortcut-item:hover kbd {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .shortcut-item .description {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.95em;
        }

        /* Search Modal Styles */
        .search-modal {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .search-input {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 14px;
            padding: 18px 20px;
            color: var(--text-primary);
            font-size: 1.1em;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            caret-color: var(--accent);
        }

        .search-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(var(--accent-rgb), 0.15);
            transform: translateY(-2px);
        }

        .search-results {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
        }

        .search-result-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .search-result-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(6px);
            border-color: var(--accent);
            box-shadow: 0 4px 20px rgba(var(--accent-rgb), 0.15);
        }

        .result-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: 12px;
            color: var(--accent);
            font-size: 1.3em;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .search-result-item:hover .result-icon {
            background: var(--accent);
            color: white;
            transform: scale(1.1);
        }

        .result-content {
            flex: 1;
            min-width: 0;
        }

        .result-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            font-size: 1em;
        }

        .result-subtitle {
            font-size: 0.88em;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .result-type {
            font-size: 0.75em;
            color: var(--text-secondary);
            background: var(--bg-tertiary);
            padding: 4px 10px;
            border-radius: 8px;
            display: inline-block;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .no-results {
            text-align: center;
            padding: 60px 24px;
            color: var(--text-secondary);
        }

        .no-results i {
            font-size: 2.5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Settings Modal Styles */
        .settings-modal {
            display: flex;
            flex-direction: column;
            gap: 36px;
        }

        .setting-group h4 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: 700;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-bottom: 14px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .setting-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .setting-item label {
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            font-size: 0.95em;
        }

        .setting-item select,
        .setting-item input[type="text"],
        .setting-item input[type="number"] {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 14px;
            color: var(--text-primary);
            outline: none;
            min-width: 140px;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .setting-item select:focus,
        .setting-item input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(var(--accent-rgb), 0.1);
        }

        .setting-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        /* Enhanced Toast Styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10003;
            display: flex;
            flex-direction: column;
            gap: 14px;
            max-width: 400px;
            pointer-events: none;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            padding: 18px 22px;
            border-radius: 14px;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.25);
            transform: translateX(400px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            gap: 14px;
            pointer-events: auto;
            backdrop-filter: blur(20px);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--danger);
        }

        .toast.warning {
            border-left-color: var(--warning);
        }

        .toast.info {
            border-left-color: var(--info);
        }

        .toast.loading {
            border-left-color: var(--accent);
        }

        .toast.success .toast-content i {
            color: var(--success);
        }

        .toast.error .toast-content i {
            color: var(--danger);
        }

        .toast.warning .toast-content i {
            color: var(--warning);
        }

        .toast.info .toast-content i {
            color: var(--info);
        }

        .toast.loading .toast-content i {
            color: var(--accent);
        }

        .toast-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .toast-content i {
            font-size: 1.3em;
            flex-shrink: 0;
        }

        .toast-content span {
            color: var(--text-primary);
            font-weight: 500;
            line-height: 1.4;
            font-size: 0.95em;
        }

        /* Text Highlighting */
        mark {
            background: rgba(var(--accent-rgb), 0.2);
            color: var(--accent);
            padding: 2px 6px;
            border-radius: 6px;
            font-weight: 700;
            box-shadow: 0 1px 3px rgba(var(--accent-rgb), 0.2);
        }

        /* Enhanced Animations */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }

            to {
                opacity: 1;
                backdrop-filter: blur(12px);
            }
        }

        @keyframes modalSlideIn {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(40px);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Focus Management */
        .command-input:focus {
            box-shadow: none;
        }

        .modal-close:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Scrollbar Styling */
        .command-list::-webkit-scrollbar,
        .modal-body::-webkit-scrollbar,
        .search-results::-webkit-scrollbar {
            width: 8px;
        }

        .command-list::-webkit-scrollbar-track,
        .modal-body::-webkit-scrollbar-track,
        .search-results::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 4px;
            margin: 4px;
        }

        .command-list::-webkit-scrollbar-thumb,
        .modal-body::-webkit-scrollbar-thumb,
        .search-results::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
            border: 2px solid var(--bg-primary);
        }

        .command-list::-webkit-scrollbar-thumb:hover,
        .modal-body::-webkit-scrollbar-thumb:hover,
        .search-results::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .command-palette {
                width: 95%;
                top: 5%;
                max-height: 85vh;
                border-radius: 20px;
            }

            .command-header {
                padding: 20px;
            }

            .command-input {
                font-size: 1.1em;
            }

            .command-item {
                padding: 16px 20px;
                margin: 2px 4px;
            }

            .command-category {
                padding: 14px 20px 8px;
            }

            .modal-content {
                margin: 10px;
                max-height: 90vh;
                border-radius: 24px;
            }

            .modal-header {
                padding: 24px;
            }

            .modal-body {
                padding: 24px;
            }

            .toast-container {
                right: 10px;
                left: 10px;
                max-width: none;
            }

            .setting-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .setting-item select {
                min-width: 100%;
            }

            .shortcut-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
        }

        @media (max-width: 480px) {
            .command-palette {
                border-radius: 16px;
            }

            .command-header {
                padding: 16px;
            }

            .command-item {
                padding: 14px 16px;
            }

            .command-category {
                padding: 12px 16px 6px;
            }

            .modal-content {
                border-radius: 20px;
            }

            .modal-header {
                padding: 20px;
            }

            .modal-body {
                padding: 20px;
            }
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            .command-palette {
                border-width: 2px;
            }

            .command-item.selected {
                border-width: 3px;
            }

            .toast {
                border-width: 2px;
            }

            .modal-content {
                border-width: 2px;
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {

            .command-palette,
            .toast,
            .modal-content,
            .command-item,
            .shortcut-item,
            .search-result-item,
            .setting-item {
                transition: none;
                animation: none;
            }

            .command-item:hover,
            .command-item.selected {
                transform: none;
            }

            .modal-overlay {
                animation: none;
            }
        }
    </style>
    <style>
        :root {
            --color-accent: {{ theme_colors.accent }};           /* Primary interaction color (e.g., #007bff) */
            --color-accent-secondary: #0056b3;                    /* A variation of the accent color - manually set for better gradient contrast */

            --color-bg-primary: {{ theme_colors.bg_primary }};   /* Main background color */
            --color-bg-secondary: {{ theme_colors.bg_secondary }}; /* Card/sidebar background */
            --color-bg-tertiary: #2a3447;                         /* Darker detail background - replacing hardcoded #16202e, #1a2333 */

            --color-text-primary: {{ theme_colors.text_primary }}; /* Main body text color */
            --color-text-secondary: {{ theme_colors.text_secondary }}; /* Secondary/muted text */

            --color-border: {{ theme_colors.border }};           /* Border color */

            /* Status Colors */
            --color-success: {{ theme_colors.success }};         /* Green */
            --color-danger: {{ theme_colors.danger }};           /* Red - replacing hardcoded #cc2929 */
            --color-warning: {{ theme_colors.warning }};         /* Yellow/Amber - replacing hardcoded #a87109 */
            --color-info: {{ theme_colors.info }};               /* Blue/Cyan - replacing hardcoded #078c9d */
            
            /* RGB Helper for Shadows (Must be defined manually or injected by template logic) */
            /* Assuming accent color is a shade of blue for this example: */
            --rgb-accent: 0, 123, 255; 
            --rgb-danger: 239, 68, 68; /* RGB for use in flow-high shadow opacity */

            /* --- 2. Typography & Spacing --- */
            --font-primary: 'Exo 2', sans-serif;
            --font-title: 'Orbitron', sans-serif;

            --space-sm: 1rem;     /* 16px */
            --space-md: 1.5rem;   /* 24px */
            --space-lg: 2.5rem;   /* 40px */
            --space-xl: 3rem;     /* 48px */

            /* --- 3. Design Elements (Mixins/Variables) --- */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 18px;

            --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 8px 20px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 12px 30px rgba(0, 0, 0, 0.7);

            --transition-fast: all 0.2s ease;
            --transition-default: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);

            /* --- 4. Layout Variables --- */
            --header-height: 65px;
            --footer-height: 40px;
        }

        /* ####################################################################### */
        /* #                                 BASE LAYOUT                         # */
        /* ####################################################################### */

        /* Reset for a full-height app experience */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: var(--font-primary);
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            overflow: hidden; /* Prevent body scroll, handle scroll in content-area */
        }

        /* Main wrapper to enforce fixed header/footer and flexible middle */
        .app-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Main Content Area: Takes remaining space and enables flexible layout */
        .main-content {
            display: flex;
            flex: 1; /* Occupies all space between header and footer */
            overflow: hidden; /* Important: ensures children (sidebar/content-area) handle their own scrolling */
        }

        /* Content Area: Should be scrollable */
        .content-area {
            flex: 1;
            padding: var(--space-xl);
            overflow-y: auto; /* **INTERNAL SCROLLING HERE** */
            background: var(--color-bg-primary);
            /* Offset for fixed header */
            padding-top: calc(var(--header-height) + var(--space-xl)); 
        }

        /* ####################################################################### */
        /* #                              HEADER & FOOTER                        # */
        /* ####################################################################### */

        .app-header-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--color-bg-secondary)d0; /* Semi-transparent background */
            backdrop-filter: blur(10px); /* Frosted glass effect */
            border-bottom: 1px solid var(--color-border)40;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            z-index: 2000;
            font-family: var(--font-primary);
            box-sizing: border-box; /* Include padding/border in height calculation */
        }

        .header-branding {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .app-title-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-icon {
            font-size: 1.8em;
            color: var(--color-accent);
            filter: drop-shadow(0 0 4px var(--color-accent)40); 
        }

        .app-title {
            font-family: var(--font-title);
            font-size: 1.5em;
            font-weight: 700;
            color: var(--color-text-primary);
            letter-spacing: 1px;
            background: linear-gradient(90deg, var(--color-text-primary) 0%, var(--color-accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-footer-container {
            width: 100%;
            min-height: var(--footer-height);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;

            /* New styles to match your other footer */
            background: linear-gradient(90deg, rgba(0,0,0,0.02), transparent);
            border-top: 1px solid var(--color-border);
            border-radius: 12px 12px 0 0;

            box-shadow: 0 -6px 18px rgba(0,0,0,0.08);
            color: var(--text-secondary);

            font-size: 0.9rem;
            gap: 12px;
            box-sizing: border-box;

            backdrop-filter: blur(6px); /* Optional: Glassy look */
            z-index: 1000;
        }

        /* Footer meta info matching your component style */
        .footer-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .footer-meta span {
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Version styling to match `.footer-left .version` */
        .footer-meta .version {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95em;
        }

        /* Harmonized footer links */
        .footer-link,
        .app-footer-container .footer-link {
            color: var(--text-secondary);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 8px;
            transition: all 0.15s ease;
            font-weight: 600;
        }

        .footer-link:hover,
        .app-footer-container .footer-link:hover {
            color: var(--accent);
            background: var(--bg-tertiary);
            transform: translateY(-1px);
        }


        /* ####################################################################### */
        /* #                                 SIDEBAR                             # */
        /* ####################################################################### */

        .sidebar {
            width: 300px;
            min-width: 280px;
            background: linear-gradient(180deg, var(--color-bg-secondary), var(--color-bg-primary));
            border-right: 1px solid var(--color-border);
            padding: var(--space-lg) var(--space-md);
            overflow-y: auto; /* **INTERNAL SCROLLING HERE** */
            position: relative;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.4);
            /* Calculate remaining height (100vh - header - footer) */
            height: calc(100vh - var(--header-height) - var(--footer-height));
            /* Adjust top position to sit below the fixed header */
            margin-top: var(--header-height); 
            box-sizing: border-box;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            background: linear-gradient(180deg, transparent, var(--color-accent-secondary), transparent);
            opacity: 0.7;
        }

        .nav-section {
            margin-bottom: var(--space-xl);
        }

        .nav-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-md);
            font-weight: 700;
            letter-spacing: 1.5px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            opacity: 0.8;
        }

        .nav-title::before {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--color-border));
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            padding: 1.1rem 1.5rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 0.75rem;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: var(--color-accent);
            transform: scaleY(0);
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 0 6px 6px 0;
        }

        .nav-item:hover {
            background: var(--color-bg-tertiary);
            transform: translateX(10px);
            border-color: var(--color-border);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .nav-item:hover::before {
            transform: scaleY(1);
            background: var(--color-accent-secondary);
        }

        .nav-item.active {
            background: linear-gradient(90deg, var(--color-accent) 0%, var(--color-accent-secondary) 100%);
            transform: translateX(12px);
            border-color: var(--color-accent);
            box-shadow: 0 8px 25px rgba(var(--rgb-accent), 0.4);
            color: white;
            font-weight: 600;
        }

        .nav-item.active::before {
            transform: scaleY(1);
            background: white;
        }

        .nav-item i {
            font-size: 1.4rem;
            width: 24px;
            text-align: center;
            transition: all 0.3s ease;
            color: var(--color-text-secondary);
        }

        .nav-item.active i {
            color: white;
            transform: scale(1.1) rotate(5deg);
        }

        /* ####################################################################### */
        /* #                                 BUTTONS                             # */
        /* ####################################################################### */

        .btn {
            padding: 10px 18px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-family: var(--font-primary);
            line-height: 1.2;
        }
        .btn-icon-text i {
            font-size: 1em;
        }

        .btn:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 12px 30px rgba(var(--rgb-accent), 0.7);
            filter: brightness(1.1);
        }

        /* Primary Button - Use the accent color for prominence */
        .btn-primary {
            background: var(--color-accent);
            border: 1px solid var(--color-accent);
            color: var(--color-bg-primary); 
            box-shadow: 0 4px 12px var(--color-accent)40;
        }
        .btn-primary:hover {
            background: var(--color-accent)e0;
            border-color: var(--color-accent)e0;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px var(--color-accent)60;
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 4px 12px var(--color-accent)40;
        }

        /* Secondary Button - Outline/Inverse style */
        .btn-secondary {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }
        .btn-secondary:hover {
            background: var(--color-accent)10;
            border-color: var(--color-accent);
            color: var(--color-accent);
            transform: translateY(-1px);
        }
        .btn-secondary:active {
            transform: translateY(0);
        }

        /* Outline Button */
        .btn-outline {
            background: transparent;
            border: 2px solid var(--color-border);
            color: var(--color-text-secondary);
            box-shadow: none;
            background-color: var(--color-bg-secondary);
        }
        .btn-outline:hover {
            border-color: var(--color-accent);
            color: var(--color-accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(var(--rgb-accent), 0.3);
        }

        /* ####################################################################### */
        /* #                            DASHBOARD CARDS                          # */
        /* ####################################################################### */

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .stat-card {
            background: linear-gradient(135deg, var(--color-bg-secondary), var(--color-bg-tertiary));
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            text-align: center;
            transition: var(--transition-default);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--color-accent), var(--color-accent-secondary));
            transform: scaleX(0);
            transition: transform 0.5s ease-in-out;
            transform-origin: left;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-icon {
            font-size: 3rem;
            margin-bottom: var(--space-sm);
            background: linear-gradient(135deg, var(--color-accent), var(--color-accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 5px rgba(var(--rgb-accent), 0.4));
        }

        .stat-value {
            font-size: 3.2rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--color-text-primary), var(--color-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: var(--space-sm);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-trend {
            margin-top: var(--space-sm);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .stat-trend.up { color: var(--color-success); }
        .stat-trend.down { color: var(--color-danger); }
        .stat-trend.stable { color: var(--color-info); }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }

        .chart-container {
            background: linear-gradient(135deg, var(--color-bg-secondary), var(--color-bg-tertiary));
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            transition: var(--transition-default);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }

        .chart-title {
            font-size: 1.5rem;
            margin-bottom: var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-weight: 700;
            color: var(--color-text-primary);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.75rem;
        }

        .chart-title i {
            font-size: 1.6rem;
            background: linear-gradient(135deg, var(--color-accent), var(--color-accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        /* Nodes Grid */

        #criticalNodes {
            display: masonry;
            column-gap: 1.75rem;
            padding: var(--space-md);
            margin-top: var(--space-md);
        }

        .nodes-grid {
            display: grid;
            /* Use a responsive grid with minimum width for flexibility */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: var(--space-lg);
            padding: var(--space-md);
        }

        .nodes-section {
            break-inside: avoid;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            padding: var(--space-lg);
            margin-bottom: 1.75rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.25);
            transition: 0.25s ease;
        }

        .nodes-section:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.35);
        }

        .section-header {
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 2px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .section-count {
            padding: 0.5rem 1.1rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 700;
            background: linear-gradient(
                135deg,
                var(--color-accent),
                var(--color-accent-secondary)
            );
            color: white;
            box-shadow: 0 3px 12px rgba(var(--rgb-accent), 0.35);
        }

        .nodes-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Node cards remain unchanged, but here's improved polishing */
        .node-item {
            background: var(--color-bg-primary);
            padding: 1.4rem;
            border-radius: var(--radius-md);
            border-left: 5px solid var(--color-accent);
            border: 1px solid var(--color-border);
            transition: 0.25s ease;
            box-shadow: 0 4px 14px rgba(0,0,0,0.25);
        }

        .node-item:hover {
            transform: translateX(6px);
            background: var(--color-bg-tertiary);
            box-shadow: 0 8px 22px rgba(0,0,0,0.35);
        }

        .node-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .node-info {
            flex: 1;
        }

        .node-name {
            font-weight: 700;
            margin-bottom: 0.75rem;
            word-break: break-word;
            color: var(--color-text-primary);
            font-size: 1.1rem;
        }

        .node-meta {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .node-tag {
            background: var(--color-bg-tertiary);
            color: var(--color-text-secondary);
            padding: 0.4rem 0.8rem;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 600;
            border: 1px solid var(--color-border);
        }

        .risk-badge {
            padding: 0.6rem 1rem;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 800;
            min-width: 60px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .risk-high { 
            background: linear-gradient(135deg, var(--color-danger), #cc2929);
            color: white;
        }
        .risk-moderate { 
            background: linear-gradient(135deg, var(--color-warning), #a87109);
            color: var(--color-bg-primary);
        }
        .risk-low { 
            background: linear-gradient(135deg, var(--color-info), #078c9d);
            color: white;
        }
        .risk-safe { 
            background: linear-gradient(135deg, var(--color-success), #047857);
            color: white;
        }

        /* ####################################################################### */
        /* #                          FLOW PATHS & COMPONENTS                    # */
        /* ####################################################################### */

        .flow-path-item {
            background: linear-gradient(135deg, var(--color-bg-secondary), var(--color-bg-tertiary)); 
            padding: var(--space-lg);
            border-radius: var(--radius-md); 
            border: 1px solid var(--color-border);
            margin-bottom: var(--space-xl);
            transition: var(--transition-default);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        .flow-path-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        /* Risk Indicators using a subtle glow/accent */
        .flow-path-item.flow-high { border: 1px solid var(--color-danger); box-shadow: 0 0 15px rgba(var(--rgb-danger), 0.3); }
        .flow-path-item.flow-moderate { border: 1px solid var(--color-warning); }
        .flow-path-item.flow-low { border: 1px solid var(--color-info); }
        .flow-path-item.flow-safe { border: 1px solid var(--color-success); }

        /* Path Header */
        .flow-path-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--color-bg-tertiary); 
        }

        .flow-path-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .flow-path-title i {
            background: linear-gradient(45deg, var(--color-accent), var(--color-accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.8rem;
        }

        .flow-path-metrics {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .flow-metric-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .flow-metric-badge.flow-high { background: var(--color-danger); }
        .flow-metric-badge.flow-moderate { background: var(--color-warning); color: var(--color-bg-primary); }
        .flow-metric-badge.flow-low { background: var(--color-info); }
        .flow-metric-badge.flow-safe { background: var(--color-success); }

        .flow-metric-text {
            font-size: 0.95rem;
            color: var(--color-text-secondary);
        }
        .flow-metric-text i { margin-right: 0.5rem; color: var(--color-accent); }

        /* --- Flow Node Visualization --- */

        .flow-card-container {
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow-x: auto;
            padding-bottom: var(--space-sm);
        }

        .flow-node-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            width: 200px;
            padding: 1.5rem var(--space-sm);
            background: var(--color-bg-primary);
            border-radius: var(--radius-sm);
            border: 1px solid var(--color-border);
            transition: all 0.3s ease;
            position: relative;
            z-index: 10;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .flow-node-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border-color: var(--color-accent-secondary);
        }

        /* Icon (Top indicator for flow) */
        .node-icon {
            font-size: 2rem;
            margin-bottom: var(--space-sm);
            transition: color 0.3s ease, transform 0.3s ease;
        }

        .flow-node-card:hover .node-icon {
            transform: scale(1.1);
        }

        /* Node Risk Coloring (Drives the color of the text and icon) */
        .flow-node-card.node-high .node-icon { color: var(--color-danger); }
        .flow-node-card.node-moderate .node-icon { color: var(--color-warning); }
        .flow-node-card.node-low .node-icon { color: var(--color-info); }
        .flow-node-card.node-safe .node-icon { color: var(--color-success); }

        /* Node Label (Text below the icon) */
        .node-label {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--color-text-primary);
            text-align: center;
            word-break: break-word;
            line-height: 1.4;
            max-width: 100%;
        }

        /* --- Connector Styling (Visualizing the flow between cards) --- */

        .flow-connector {
            flex: 1;
            height: 3px;
            background: var(--color-border);
            position: relative;
            margin: 0 var(--space-sm); 
            z-index: 5;
            transition: background 0.4s ease;
            min-width: 50px;
        }

        /* Connector Arrow Head (Pure CSS diamond shape) */
        .flow-connector::after {
            content: '';
            position: absolute;
            top: -6px;
            right: -10px;
            width: 15px;
            height: 15px;
            background: inherit; 
            transform: rotate(45deg);
            border-radius: 2px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 7;
        }

        /* Color the connector and arrow based on the risk of the originating node */
        .flow-node-card.node-high + .flow-connector,
        .flow-node-card.node-high + .flow-connector::after { background: var(--color-danger); }

        .flow-node-card.node-moderate + .flow-connector,
        .flow-node-card.node-moderate + .flow-connector::after { background: var(--color-warning); }

        .flow-node-card.node-low + .flow-connector,
        .flow-node-card.node-low + .flow-connector::after { background: var(--color-info); }

        .flow-node-card.node-safe + .flow-connector,
        .flow-node-card.node-safe + .flow-connector::after { background: var(--color-success); }


        /* Component Cards */
        .component-card {
            background: linear-gradient(135deg, var(--color-bg-secondary), var(--color-bg-tertiary));
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            margin-bottom: var(--space-md);
            transition: var(--transition-default);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .component-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }

        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 2px solid var(--color-border);
        }

        .component-title {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            font-weight: 700;
            color: var(--color-text-primary);
        }

        .component-size {
            background: linear-gradient(135deg, var(--color-accent), var(--color-accent-secondary));
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 25px;
            font-size: var(--space-sm);
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(var(--rgb-accent), 0.4);
        }

        .component-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .component-metric {
            text-align: center;
            background: var(--color-bg-primary);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            transition: all 0.3s ease;
        }

        .component-metric:hover {
            box-shadow: 0 4px 15px rgba(var(--rgb-accent), 0.15);
        }

        .metric-label {
            color: var(--color-text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-value {
            font-weight: 800;
            font-size: 1.4rem;
            color: var(--color-text-primary);
        }

        /* Network Container */
        .network-container {
            background: linear-gradient(135deg, var(--color-bg-secondary), var(--color-bg-tertiary));
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            height: 500px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .network-controls {
            position: absolute;
            top: var(--space-md);
            right: var(--space-md);
            z-index: 10;
            display: flex;
            gap: 0.75rem;
            background: rgba(var(--color-bg-primary), 0.8);
            backdrop-filter: blur(5px);
            border-radius: var(--radius-md);
            padding: 0.5rem;
            border: 1px solid var(--color-border);
        }

        .network-control {
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .network-control:hover {
            background: var(--color-accent);
            color: white;
            transform: scale(1.08);
            box-shadow: 0 4px 15px rgba(var(--rgb-accent), 0.5);
        }

        /* Tab Content Management */
        .tab-content {
            display: none;
            animation: fadeIn 0.6s cubic-bezier(0.39, 0.575, 0.565, 1);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* New Metrics and Insights Components */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .metric-card {
            background: linear-gradient(135deg, var(--color-bg-secondary), var(--color-bg-tertiary));
            padding: var(--space-md);
            border-radius: 16px;
            border: 1px solid var(--color-border);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .metric-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: 1.25rem;
        }

        .metric-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--color-accent), var(--color-accent-secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.4rem;
            box-shadow: 0 4px 10px rgba(var(--rgb-accent), 0.4);
        }

        .metric-title {
            font-weight: 700;
            color: var(--color-text-primary);
            font-size: 1.1rem;
        }

        .metric-value-large {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--color-text-primary), var(--color-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .metric-description {
            color: var(--color-text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Grid */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
            margin-top: var(--space-lg);
        }

        /* Card */
        .insight-card {
            background: linear-gradient(145deg, var(--color-bg-secondary), var(--color-bg-tertiary));
            padding: var(--space-md);
            border-radius: 16px;
            border: 1px solid var(--color-border);
            transition: all 0.25s ease;
            position: relative;
        }

        .insight-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.25);
        }

        /* Header */
        .insight-header {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-bottom: 1rem;
        }

        /* Icon Bubble */
        .insight-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.25rem;
            transition: transform 0.25s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        .insight-card:hover .insight-icon {
            transform: scale(1.08);
        }

        /* Title */
        .insight-title {
            font-weight: 700;
            color: var(--color-text-primary);
            font-size: 1.15rem;
        }

        /* Severity badge */
        .insight-severity {
            margin-top: 2px;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 6px;
            width: fit-content;
            letter-spacing: 0.5px;
        }

        .insight-severity.high {
            background: rgba(255,70,70,0.12);
            color: var(--color-danger);
        }

        .insight-severity.medium {
            background: rgba(255,180,40,0.15);
            color: var(--color-warning);
        }

        .insight-severity.good {
            background: rgba(40,200,120,0.15);
            color: var(--color-success);
        }

        /* Text content */
        .insight-content {
            color: var(--color-text-secondary);
            font-size: 0.97rem;
            line-height: 1.55;
        }


        .insight-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 0.75rem;
        }

        /* Provider Analysis */
        .provider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .provider-card {
            background: linear-gradient(135deg, var(--color-bg-secondary), var(--color-bg-tertiary));
            padding: var(--space-md);
            border-radius: 16px;
            border: 1px solid var(--color-border);
            transition: all 0.3s ease;
        }

        .provider-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .provider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .provider-name {
            font-weight: 700;
            color: var(--color-text-primary);
            font-size: 1.1rem;
        }

        .provider-count {
            background: var(--color-accent);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
        }

        /* ####################################################################### */
        /* #                           RESPONSIVE DESIGN                         # */
        /* ####################################################################### */

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid var(--color-border);
                order: -1;
                /* Sidebar in mobile should be full width and scrollable horizontally, or collapse entirely. 
                We'll keep it visible but adjust height for a compact nav area. */
                height: auto; 
                max-height: 200px;
                margin-top: var(--header-height);
                overflow-y: hidden;
            }

            .content-area {
                padding-top: var(--space-xl); /* Reset offset, since header is now full width and content flows below */
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .charts-grid, .nodes-grid, .metrics-grid, .insights-grid, .provider-grid {
                grid-template-columns: 1fr;
            }
            
            .flow-path-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-sm);
            }
            
            .flow-path-metrics {
                flex-wrap: wrap;
            }

            .app-header-container {
                flex-direction: column;
                gap: var(--space-sm);
                text-align: center;
                height: auto;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .content-area {
                padding: 1.5rem;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .nodes-grid {
                grid-template-columns: 1fr;
            }

            .component-metrics {
                grid-template-columns: 1fr;
            }
        }

        /* ####################################################################### */
        /* #                              UTILITY                                # */
        /* ####################################################################### */

        /* Loading states */
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .skeleton {
            background: linear-gradient(90deg, var(--color-bg-tertiary) 25%, var(--color-bg-secondary) 50%, var(--color-bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--color-bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-bg-tertiary);
            border-radius: 5px;
            border: 2px solid var(--color-bg-secondary);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-accent);
        }
    </style>
</head>

<body>
    <div class="grid-background"></div>    
    <!-- Backdrop -->
    <div class="backdrop" id="backdrop"></div>

    <div class="toast-container" id="toastContainer"></div>

    <!-- Command Palette -->
    <div class="command-palette" id="commandPalette">
        <div class="command-header">
            <i class="fas fa-search"></i>
            <input type="text" class="command-input" id="commandInput" placeholder="Search commands..." />
            <div class="command-shortcut">ESC</div>
        </div>
        <div class="command-list" id="commandList">
            <!-- Commands will be populated dynamically -->
        </div>
    </div>

    <div class="quick-actions" id="quickActions">
        <div class="quick-action" data-action="command">
            <i class="fas fa-terminal"></i>
            <span>Command</span>
        </div>
        <div class="quick-action" data-action="fullscreen">
            <i class="fas fa-expand"></i>
            <span>Fullscreen</span>
        </div>
        <div class="quick-action" data-action="help">
            <i class="fas fa-question-circle"></i>
            <span>Help</span>
        </div>
    </div>

    <div class="app-wrapper">
        
        <header class="app-header-container">
            <div class="header-branding">
                <div class="app-title-group">
                    <i class="fas fa-chart-network app-icon"></i>
                    <span class="app-title">Terraform Analytics Dashboard</span>
                </div>
            </div>
        </header>

        <div class="main-content">
            <nav class="sidebar">
                <div class="nav-section">
                    <div class="nav-title">Dashboard Overview</div>
                    <div class="nav-item active" data-tab="overview">
                        <i class="fas fa-tachometer-alt-fast"></i>
                        <span>Overview Dashboard</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Graph Analysis</div>
                    <div class="nav-item" data-tab="nodes">
                        <i class="fas fa-sitemap"></i>
                        <span>Critical Nodes</span>
                    </div>
                    <div class="nav-item" data-tab="paths">
                        <i class="fas fa-route"></i>
                        <span>Dependency Paths</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Advanced Metrics</div>
                    <div class="nav-item" data-tab="metrics">
                        <i class="fas fa-chart-line"></i>
                        <span>Advanced Metrics</span>
                    </div>
                    <div class="nav-item" data-tab="risk">
                        <i class="fas fa-shield-alt"></i>
                        <span>Risk Analysis</span>
                    </div>
                    <div class="nav-item" data-tab="performance">
                        <i class="fas fa-rocket"></i>
                        <span>Performance</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Architecture Insights</div>
                    <div class="nav-item" data-tab="providers">
                        <i class="fas fa-plug"></i>
                        <span>Provider Analysis</span>
                    </div>
                    <div class="nav-item" data-tab="modules">
                        <i class="fas fa-cube"></i>
                        <span>Module Analysis</span>
                    </div>
                    <div class="nav-item" data-tab="optimization">
                        <i class="fas fa-magic"></i>
                        <span>Optimization</span>
                    </div>
                </div>
            </nav>

            <main class="content-area">
                <!-- Overview Tab -->
                <div id="overview" class="tab-content active">
                    <div class="stats-grid" id="statsGrid"></div>
                    
                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-cubes"></i>
                                Resource Type Distribution
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="typeChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-exclamation-triangle"></i>
                                Risk Distribution
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="riskChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-brain"></i>
                                Complexity Analysis
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="complexityChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-sitemap"></i>
                                Node State Distribution
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="stateChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-link"></i>
                                Link Type Distribution
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="linkTypeChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-layer-group"></i>
                                Module Distribution
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="moduleChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Critical Nodes Tab -->
                <div id="nodes" class="tab-content">
                    <div class="nodes-grid" id="criticalNodes"></div>
                </div>

                <!-- Dependency Paths Tab -->
                <div id="paths" class="tab-content">
                    <div id="pathsContainer"></div>
                </div>

                <!-- Components Tab -->
                <div id="components" class="tab-content">
                    <div id="componentsContainer"></div>
                </div>

                <!-- Advanced Metrics Tab -->
                <div id="metrics" class="tab-content">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-icon">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="metric-title">Cyclomatic Complexity</div>
                            </div>
                            <div class="metric-value-large" id="cyclomaticComplexity">71</div>
                            <div class="metric-description">
                                Measures the complexity of the dependency graph structure
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-icon">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                <div class="metric-title">Cognitive Complexity</div>
                            </div>
                            <div class="metric-value-large" id="cognitiveComplexity">116.6</div>
                            <div class="metric-description">
                                Measures how difficult the infrastructure is to understand
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-icon">
                                    <i class="fas fa-tools"></i>
                                </div>
                                <div class="metric-title">Maintainability Index</div>
                            </div>
                            <div class="metric-value-large" id="maintainabilityIndex">73.7%</div>
                            <div class="metric-description">
                                Overall maintainability score of the infrastructure
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-header">
                                <div class="metric-icon">
                                    <i class="fas fa-coins"></i>
                                </div>
                                <div class="metric-title">Technical Debt</div>
                            </div>
                            <div class="metric-value-large" id="technicalDebt">67.2%</div>
                            <div class="metric-description">
                                Accumulated technical debt in the infrastructure
                            </div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-chart-line"></i>
                                Node Centrality Metrics
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="centralityChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-wave-square"></i>
                                Degree Distribution
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="degreeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Analysis Tab -->
                <div id="risk" class="tab-content">
                    <div class="chart-container">
                        <div class="chart-title">
                            <i class="fas fa-radar"></i>
                            Risk Heatmap Analysis
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="riskHeatmap"></canvas>
                        </div>
                    </div>

                    <div class="insights-grid" id="riskInsights"></div>
                </div>

                <!-- Performance Tab -->
                <div id="performance" class="tab-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <div class="stat-value">2.18</div>
                            <div class="stat-label">Avg Path Length</div>
                            <div class="stat-trend stable">
                                <i class="fas fa-minus"></i> Optimal
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-memory"></i>
                            </div>
                            <div class="stat-value">0.192</div>
                            <div class="stat-label">Clustering Coefficient</div>
                            <div class="stat-trend up">
                                <i class="fas fa-arrow-up"></i> Good
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-microchip"></i>
                            </div>
                            <div class="stat-value">0.286</div>
                            <div class="stat-label">Transitivity</div>
                            <div class="stat-trend stable">
                                <i class="fas fa-minus"></i> Normal
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-network-wired"></i>
                            </div>
                            <div class="stat-value">0.029</div>
                            <div class="stat-label">Graph Density</div>
                            <div class="stat-trend down">
                                <i class="fas fa-arrow-down"></i> Sparse
                            </div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-chart-bar"></i>
                                Degree Distribution by Type
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="degreeByTypeChart"></canvas>
                            </div>
                        </div>
                        <div class="chart-container">
                            <div class="chart-title">
                                <i class="fas fa-project-diagram"></i>
                                Component Size Distribution
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="componentSizeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Provider Analysis Tab -->
                <div id="providers" class="tab-content">
                    <div class="provider-grid" id="providerGrid"></div>
                    
                    <div class="chart-container" style="margin-top: 2rem;">
                        <div class="chart-title">
                            <i class="fas fa-plug"></i>
                            Provider Coupling Analysis
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="providerCouplingChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Module Analysis Tab -->
                <div id="modules" class="tab-content">
                    <div class="nodes-grid" id="moduleAnalysis"></div>
                    
                    <div class="chart-container" style="margin-top: 2rem;">
                        <div class="chart-title">
                            <i class="fas fa-cube"></i>
                            Module Quality Metrics
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="moduleQualityChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Optimization Tab -->
                <div id="optimization" class="tab-content">
                    <div class="insights-grid" id="optimizationInsights"></div>
                    
                    <div class="chart-container" style="margin-top: 2rem;">
                        <div class="chart-title">
                            <i class="fas fa-magic"></i>
                            Architecture Quality Score
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="architectureQualityChart"></canvas>
                        </div>
                    </div>
                </div>
            </main>
        </div>
        
        <footer class="app-footer-container">
            <div class="footer-meta">
                <span class="version">tfkit <span style="opacity:0.8; font-weight:500">(v{{ version | default('0.0.0') }})</span></span>
                <span class="footer-links">
                    <a href="https://tfkit.netlify.app/" target="_blank" title="Homepage" class="footer-link"><i class="fas fa-home"></i> Homepage</a>
                    <a href="https://github.com/ivasik-k7/tfkit" target="_blank" title="GitHub" class="footer-link"><i class="fab fa-github"></i> GitHub</a>
                </span>
            </div>
            <div class="footer-actions">
                <a class="btn btn-outline" href="https://github.com/ivasik-k7/tfkit/issues" target="_blank" title="Report Issue">
                    <i class="fas fa-bug"></i> Report Issue
                </a>
            </div>
        </footer>
    </div>

    <script>
        class CommandPalette {
            constructor(rawData, options = {}) {
                this.config = {
                    enableBacktickKey: true,
                    searchDebounce: 150,
                    hotkeyModifier: 'ctrlKey',
                    ...options
                };

                this.backdrop = document.getElementById('backdrop');
                this.commandPalette = document.getElementById('commandPalette');
                this.commandInput = document.getElementById('commandInput');
                this.commandList = document.getElementById('commandList');
                this.toastContainer = document.getElementById('toastContainer');
                this.quickActions = document.getElementById('quickActions');

                if (!this.commandPalette || !this.backdrop || !this.commandInput || !this.commandList) {
                    console.error('Command palette essential elements not found in DOM');
                    this.showErrorToast('Command palette initialization failed: Missing DOM elements');
                    return;
                }

                this.selectedCommandIndex = 0;
                this.isOpen = false;
                this._debounceTimer = null;
                this.filteredCommands = [];
                this.isFullscreen = false;

                console.log(rawData)

                // Initialize data
                this.data = rawData
                // Initialize dashboard instance if it doesn't exist
                if (typeof window.dashboardInstance === 'undefined') {
                    window.dashboardInstance = this.createDashboardInstance();
                }

                this.commands = [
                    {
                        id: 'export-data',
                        title: 'Export Data',
                        description: 'Export all dashboard data as JSON',
                        icon: 'fas fa-download',
                        shortcut: 'Ctrl+E',
                        category: 'Data',
                        action: () => this.executeAction('export'),
                        keywords: ['export', 'download', 'save', 'json']
                    },
                    {
                        id: 'toggle-fullscreen',
                        title: 'Toggle Fullscreen',
                        description: 'Enter or exit fullscreen mode',
                        icon: 'fas fa-expand',
                        shortcut: 'F11',
                        category: 'View',
                        action: () => this.executeAction('fullscreen'),
                        keywords: ['fullscreen', 'full', 'screen', 'maximize']
                    },
                    {
                        id: 'show-help',
                        title: 'Show Help',
                        description: 'Display keyboard shortcuts and tips',
                        icon: 'fas fa-question-circle',
                        shortcut: 'F1',
                        category: 'Help',
                        action: () => this.executeAction('help'),
                        keywords: ['help', 'documentation', 'guide', 'tips']
                    },
                    {
                        id: 'search-data',
                        title: 'Search Data',
                        description: 'Search through your dashboard data',
                        icon: 'fas fa-search',
                        shortcut: 'Ctrl+F',
                        category: 'Data',
                        action: () => this.executeAction('search'),
                        keywords: ['search', 'find', 'query', 'filter']
                    },
                    {
                        id: 'settings',
                        title: 'Open Settings',
                        description: 'Configure application settings',
                        icon: 'fas fa-cog',
                        shortcut: 'Ctrl+,',
                        category: 'System',
                        action: () => this.executeAction('settings'),
                        keywords: ['settings', 'configure', 'preferences', 'options']
                    }
                ];

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setupQuickActions();
                this.showSuccessToast('Command palette ready. Press Ctrl+K or ` to open.');
            }

            setupEventListeners() {
                document.addEventListener('keydown', this.handleKeyboard.bind(this));
                this.commandInput.addEventListener('input', this.debounceFilter.bind(this));
                this.commandInput.addEventListener('keydown', this.handleCommandNavigation.bind(this));
                this.backdrop.addEventListener('click', this.hideCommandPalette.bind(this));
                
                this.commandPalette.addEventListener('click', (e) => e.stopPropagation());
            }

            setupQuickActions() {
                if (!this.quickActions) return;

                this.quickActions.addEventListener('click', (e) => {
                    const actionButton = e.target.closest('.quick-action');
                    if (!actionButton) return;

                    const action = actionButton.dataset.action;
                    this.handleQuickAction(action);
                });
            }

            handleQuickAction(action) {
                switch (action) {
                    case 'command':
                        this.toggleCommandPalette();
                        break;
                    case 'fullscreen':
                        this.executeAction('fullscreen');
                        break;
                    case 'help':
                        this.executeAction('help');
                        break;
                }
            }

            handleKeyboard(event) {
                // Don't handle keyboard events when palette is open and user is typing
                if (this.isOpen && event.key !== 'Escape') {
                    return;
                }

                const isModifierPressed = this.checkModifierKey(event);

                switch (event.key) {
                    case 'Escape':
                        if (this.isOpen) {
                            event.preventDefault();
                            this.hideCommandPalette();
                        }
                        break;

                    case 'F1':
                        event.preventDefault();
                        this.executeAction('help');
                        break;

                    case 'F11':
                        event.preventDefault();
                        this.executeAction('fullscreen');
                        break;

                    case 'k':
                        if (isModifierPressed) {
                            event.preventDefault();
                            this.toggleCommandPalette();
                        }
                        break;

                    case '`':
                        if (this.config.enableBacktickKey && !event.ctrlKey && !event.metaKey && !event.altKey) {
                            event.preventDefault();
                            this.toggleCommandPalette();
                        }
                        break;

                    case 'e':
                        if (isModifierPressed) {
                            event.preventDefault();
                            this.executeAction('export');
                        }
                        break;

                    case 'f':
                        if (isModifierPressed) {
                            event.preventDefault();
                            this.executeAction('search');
                        }
                        break;

                    case ',':
                        if (isModifierPressed) {
                            event.preventDefault();
                            this.executeAction('settings');
                        }
                        break;
                }
            }

            checkModifierKey(event) {
                switch (this.config.hotkeyModifier) {
                    case 'ctrlKey':
                        return event.ctrlKey && !event.metaKey;
                    case 'metaKey':
                        return event.metaKey && !event.ctrlKey;
                    case 'both':
                        return event.ctrlKey || event.metaKey;
                    default:
                        return event.ctrlKey || event.metaKey;
                }
            }

            toggleCommandPalette() {
                this.isOpen ? this.hideCommandPalette() : this.showCommandPalette();
            }

            showCommandPalette() {
                if (this.isOpen) return;
                
                this.isOpen = true;
                document.body.style.overflow = 'hidden';

                this.backdrop.classList.add('show');
                this.commandPalette.classList.add('show');
                this.commandInput.value = '';
                this.selectedCommandIndex = 0;

                // Force reflow for animation
                this.commandPalette.offsetHeight;

                requestAnimationFrame(() => {
                    this.commandInput.focus();
                    this.filterCommands();
                });
            }

            hideCommandPalette() {
                if (!this.isOpen) return;
                
                this.isOpen = false;
                document.body.style.overflow = '';

                // Add closing animation
                this.commandPalette.style.transform = 'translateX(-50%) scale(0.95)';
                this.commandPalette.style.opacity = '0';
                
                setTimeout(() => {
                    this.backdrop.classList.remove('show');
                    this.commandPalette.classList.remove('show');
                    this.commandInput.value = '';
                    this.selectedCommandIndex = 0;
                    this.filteredCommands = [];
                    
                    // Reset transforms
                    this.commandPalette.style.transform = '';
                    this.commandPalette.style.opacity = '';
                }, 200);
            }

            debounceFilter() {
                clearTimeout(this._debounceTimer);
                this._debounceTimer = setTimeout(() => {
                    this.filterCommands();
                }, this.config.searchDebounce);
            }

            filterCommands() {
                const query = this.commandInput.value.toLowerCase().trim();
                
                this.filteredCommands = query === '' ? this.commands : this.commands.filter(cmd =>
                    cmd.title.toLowerCase().includes(query) ||
                    cmd.description.toLowerCase().includes(query) ||
                    (cmd.keywords && cmd.keywords.some(keyword => 
                        keyword.toLowerCase().includes(query)
                    )) ||
                    cmd.category.toLowerCase().includes(query)
                );

                this.renderCommands(this.filteredCommands);
            }

            renderCommands(commands) {
                this.commandList.innerHTML = '';
                this.selectedCommandIndex = 0;
                this.filteredCommands = commands;

                if (commands.length === 0) {
                    this.commandList.innerHTML = `
                        <div class="command-empty-state">
                            <i class="fas fa-search"></i>
                            <div>No commands found</div>
                            <div class="command-empty-hint">Try different keywords</div>
                        </div>
                    `;
                    return;
                }

                const groupedCommands = this.groupByCategory(commands);
                let itemIndex = 0; // Track the actual DOM index
                
                Object.keys(groupedCommands).forEach(category => {
                    const categoryHeader = document.createElement('div');
                    categoryHeader.className = 'command-category';
                    categoryHeader.textContent = category;
                    this.commandList.appendChild(categoryHeader);

                    groupedCommands[category].forEach((command) => {
                        const item = document.createElement('div');
                        item.className = `command-item ${itemIndex === 0 ? 'selected' : ''}`;
                        item.setAttribute('role', 'option');
                        item.setAttribute('aria-selected', itemIndex === 0);
                        item.setAttribute('data-index', itemIndex);
                        
                        item.innerHTML = `
                            <div class="command-icon">
                                <i class="${command.icon}"></i>
                            </div>
                            <div class="command-content">
                                <div class="command-title">${this.highlightText(command.title, this.commandInput.value)}</div>
                                <div class="command-description">${command.description}</div>
                            </div>
                            <div class="command-shortcut-item">${command.shortcut}</div>
                        `;

                        item.addEventListener('click', () => this.executeCommand(command));
                        item.addEventListener('mouseenter', () => {
                            this.selectedCommandIndex = itemIndex;
                            this.updateSelection();
                        });

                        this.commandList.appendChild(item);
                        itemIndex++;
                    });
                });
            }

            groupByCategory(commands) {
                return commands.reduce((groups, command) => {
                    const category = command.category || 'General';
                    if (!groups[category]) groups[category] = [];
                    groups[category].push(command);
                    return groups;
                }, {});
            }

            highlightText(text, query) {
                if (!query.trim()) return text;
                const regex = new RegExp(`(${this.escapeRegex(query)})`, 'gi');
                return text.replace(regex, '<mark>$1</mark>');
            }

            escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }

            handleCommandNavigation(event) {
                const items = this.commandList.querySelectorAll('.command-item');
                if (items.length === 0) return;

                switch (event.key) {
                    case 'ArrowDown':
                        event.preventDefault();
                        this.selectedCommandIndex = Math.min(this.selectedCommandIndex + 1, items.length - 1);
                        this.updateSelection();
                        break;
                    case 'ArrowUp':
                        event.preventDefault();
                        this.selectedCommandIndex = Math.max(this.selectedCommandIndex - 1, 0);
                        this.updateSelection();
                        break;
                    case 'Enter':
                        event.preventDefault();
                        const selectedCommand = this.filteredCommands[this.selectedCommandIndex];
                        if (selectedCommand) {
                            this.executeCommand(selectedCommand);
                        }
                        break;
                    case 'Tab':
                        event.preventDefault();
                        if (event.shiftKey) {
                            this.selectedCommandIndex = Math.max(this.selectedCommandIndex - 1, 0);
                        } else {
                            this.selectedCommandIndex = Math.min(this.selectedCommandIndex + 1, items.length - 1);
                        }
                        this.updateSelection();
                        break;
                }
            }

            updateSelection() {
                const items = this.commandList.querySelectorAll('.command-item');
                items.forEach((item, index) => {
                    const isSelected = index === this.selectedCommandIndex;
                    item.classList.toggle('selected', isSelected);
                    item.setAttribute('aria-selected', isSelected);
                });

                const selectedItem = items[this.selectedCommandIndex];
                if (selectedItem) {
                    selectedItem.scrollIntoView({ 
                        block: 'nearest', 
                        behavior: 'smooth',
                        inline: 'nearest'
                    });
                }
            }

            executeCommand(command) {
                try {
                    command.action();
                    this.showSuccessToast(`Executed: ${command.title}`);
                    this.hideCommandPalette();
                } catch (error) {
                    console.error('Error executing command:', error);
                    this.showErrorToast(`Failed to execute: ${command.title}`);
                }
            }

            executeAction(action) {
                if (typeof window.dashboardInstance === 'undefined') {
                    this.showErrorToast('Dashboard instance not available');
                    return;
                }

                const actionMap = {
                    'export': 'exportData',
                    'fullscreen': 'toggleFullscreen',
                    'help': 'showHelp',
                    'search': 'showSearch',
                    'settings': 'showSettings'
                };

                const methodName = actionMap[action];
                if (methodName && typeof window.dashboardInstance[methodName] === 'function') {
                    try {
                        const result = window.dashboardInstance[methodName]();
                        
                        // Handle async actions
                        if (result instanceof Promise) {
                            this.showLoadingToast(`Processing ${action}...`);
                            result.then(message => {
                                this.showSuccessToast(message || `Action completed: ${action}`);
                            }).catch(error => {
                                console.error(`Error executing ${action}:`, error);
                                this.showErrorToast(`Failed to execute: ${action}`);
                            });
                        } else {
                            this.showSuccessToast(result || `Action completed: ${action}`);
                        }
                    } catch (error) {
                        console.error(`Error executing ${action}:`, error);
                        this.showErrorToast(`Failed to execute: ${action}`);
                    }
                } else {
                    this.showErrorToast(`Action not available: ${action}`);
                }
            }

            createDashboardInstance() {
                return {
                    exportData: () => {
                        const dataStr = JSON.stringify(this.data, null, 2);
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(dataBlob);
                        link.download = `analytics-export-${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(link.href);
                        
                        return `Exported analytics data`;
                    },

                    toggleFullscreen: () => {
                        if (!document.fullscreenElement) {
                            document.documentElement.requestFullscreen().catch(err => {
                                console.error('Error attempting to enable fullscreen:', err);
                            });
                            this.isFullscreen = true;
                            return 'Entered fullscreen mode';
                        } else {
                            document.exitFullscreen();
                            this.isFullscreen = false;
                            return 'Exited fullscreen mode';
                        }
                    },

                    showHelp: () => {
                        const helpContent = `
                            <div class="help-modal">
                                <h3>Keyboard Shortcuts</h3>
                                <div class="shortcut-list">
                                    <div class="shortcut-item">
                                        <span class="keys"><kbd>Ctrl</kbd> + <kbd>K</kbd></span>
                                        <span class="description">Open Command Palette</span>
                                    </div>
                                    <div class="shortcut-item">
                                        <span class="keys"><kbd>Ctrl</kbd> + <kbd>E</kbd></span>
                                        <span class="description">Export Data</span>
                                    </div>
                                    <div class="shortcut-item">
                                        <span class="keys"><kbd>F11</kbd></span>
                                        <span class="description">Toggle Fullscreen</span>
                                    </div>
                                    <div class="shortcut-item">
                                        <span class="keys"><kbd>Ctrl</kbd> + <kbd>F</kbd></span>
                                        <span class="description">Search Data</span>
                                    </div>
                                    <div class="shortcut-item">
                                        <span class="keys"><kbd>Ctrl</kbd> + <kbd>,</kbd></span>
                                        <span class="description">Open Settings</span>
                                    </div>
                                    <div class="shortcut-item">
                                        <span class="keys"><kbd>F1</kbd></span>
                                        <span class="description">Show Help</span>
                                    </div>
                                </div>
                            </div>
                        `;

                        this.showModal('Help & Shortcuts', helpContent);
                        return 'Help dialog opened';
                    },

                    showSearch: () => {
                        const searchHTML = `
                            <div class="search-modal">
                                <input type="text" id="globalSearch" placeholder="Search nodes, types, risks, components..." class="search-input">
                                <div id="searchResults" class="search-results"></div>
                            </div>
                        `;

                        this.showModal('Search Analytics Data', searchHTML, () => {
                            const searchInput = document.getElementById('globalSearch');
                            const searchResults = document.getElementById('searchResults');
                            
                            searchInput.focus();
                            
                            // Perform initial empty search to show placeholder
                            this.performSearch('', searchResults);
                            
                            searchInput.addEventListener('input', (e) => {
                                this.performSearch(e.target.value, searchResults);
                            });
                        });
                        
                        return 'Search dialog opened';
                    },

                    showSettings: () => {
                        const settingsHTML = `
                            <div class="settings-modal">
                                <div class="setting-group">
                                    <h4>Appearance</h4>
                                    <div class="setting-item">
                                        <label>Theme:</label>
                                        <select id="themeSelect">
                                            <option value="light">Light</option>
                                            <option value="dark" selected>Dark</option>
                                            <option value="auto">Auto</option>
                                        </select>
                                    </div>
                                    <div class="setting-item">
                                        <label>
                                            <input type="checkbox" id="notificationsToggle" checked>
                                            Enable Notifications
                                        </label>
                                    </div>
                                </div>
                                <div class="setting-group">
                                    <h4>Behavior</h4>
                                    <div class="setting-item">
                                        <label>Command Palette Hotkey:</label>
                                        <select id="hotkeySelect">
                                            <option value="ctrlKey">Ctrl+K</option>
                                            <option value="metaKey">Cmd+K</option>
                                            <option value="both">Both</option>
                                        </select>
                                    </div>
                                    <div class="setting-item">
                                        <label>
                                            <input type="checkbox" id="backtickToggle" checked>
                                            Enable Backtick (` + '`' + `) Key
                                        </label>
                                    </div>
                                </div>
                            </div>
                        `;

                        this.showModal('Settings', settingsHTML, () => {
                            // Initialize settings values
                            document.getElementById('themeSelect').value = this.data.settings.theme;
                            document.getElementById('notificationsToggle').checked = this.data.settings.notifications;
                            document.getElementById('hotkeySelect').value = this.config.hotkeyModifier;
                            document.getElementById('backtickToggle').checked = this.config.enableBacktickKey;

                            // Add event listeners
                            document.getElementById('themeSelect').addEventListener('change', (e) => {
                                this.data.settings.theme = e.target.value;
                                this.applyTheme(e.target.value);
                            });

                            document.getElementById('notificationsToggle').addEventListener('change', (e) => {
                                this.data.settings.notifications = e.target.checked;
                                this.showSuccessToast(`Notifications ${e.target.checked ? 'enabled' : 'disabled'}`);
                            });

                            document.getElementById('hotkeySelect').addEventListener('change', (e) => {
                                this.config.hotkeyModifier = e.target.value;
                                this.showSuccessToast(`Hotkey preference updated`);
                            });

                            document.getElementById('backtickToggle').addEventListener('change', (e) => {
                                this.config.enableBacktickKey = e.target.checked;
                                this.showSuccessToast(`Backtick key ${e.target.checked ? 'enabled' : 'disabled'}`);
                            });
                        });
                        
                        return 'Settings dialog opened';
                    }
                };
            }

            performSearch(query, resultsContainer) {
                if (!query.trim()) {
                    resultsContainer.innerHTML = '<div class="no-results">Enter search terms to find data</div>';
                    return;
                }

                const searchTerm = query.toLowerCase();
                const allResults = [];

                if (this.data) {
                    if (this.data.node_metrics) {
                        Object.keys(this.data.node_metrics).forEach(nodeId => {
                            if (nodeId.toLowerCase().includes(searchTerm)) {
                                const node = this.data.node_metrics[nodeId];
                                allResults.push({
                                    type: 'Node',
                                    title: nodeId,
                                    subtitle: `Type: ${this.getNodeType(nodeId)} | Risk: ${node.risk_level || 'unknown'}`,
                                    icon: 'fas fa-sitemap',
                                    data: node
                                });
                            }
                        });
                    }

                    if (this.data.hub_nodes) {
                        this.data.hub_nodes.forEach(node => {
                            if (node.toLowerCase().includes(searchTerm)) {
                                allResults.push({
                                    type: 'Hub Node',
                                    title: node,
                                    subtitle: 'Highly connected central node',
                                    icon: 'fas fa-hub',
                                    data: { node }
                                });
                            }
                        });
                    }

                    if (this.data.bottleneck_nodes) {
                        this.data.bottleneck_nodes.forEach(node => {
                            if (node.toLowerCase().includes(searchTerm)) {
                                allResults.push({
                                    type: 'Bottleneck',
                                    title: node,
                                    subtitle: 'Critical performance bottleneck',
                                    icon: 'fas fa-hourglass-half',
                                    data: { node }
                                });
                            }
                        });
                    }

                    if (this.data.high_risk_nodes) {
                        this.data.high_risk_nodes.forEach(([node, score]) => {
                            if (node.toLowerCase().includes(searchTerm)) {
                                allResults.push({
                                    type: 'High Risk',
                                    title: node,
                                    subtitle: `Risk Score: ${score.toFixed(1)}`,
                                    icon: 'fas fa-exclamation-triangle',
                                    data: { node, score }
                                });
                            }
                        });
                    }

                    if (this.data.components) {
                        Object.entries(this.data.components).forEach(([id, component]) => {
                            if (id.toLowerCase().includes(searchTerm) || 
                                component.component_type?.toLowerCase().includes(searchTerm)) {
                                allResults.push({
                                    type: 'Component',
                                    title: `Component ${id}`,
                                    subtitle: `Size: ${component.size} nodes | Type: ${component.component_type}`,
                                    icon: 'fas fa-puzzle-piece',
                                    data: component
                                });
                            }
                        });
                    }

                    if (this.data.risk_distribution) {
                        Object.keys(this.data.risk_distribution).forEach(riskLevel => {
                            if (riskLevel.toLowerCase().includes(searchTerm)) {
                                allResults.push({
                                    type: 'Risk Level',
                                    title: `${riskLevel} Risk`,
                                    subtitle: `${this.data.risk_distribution[riskLevel]} nodes`,
                                    icon: 'fas fa-shield-alt',
                                    data: { riskLevel, count: this.data.risk_distribution[riskLevel] }
                                });
                            }
                        });
                    }

                    if (this.data.type_distribution) {
                        Object.keys(this.data.type_distribution).forEach(nodeType => {
                            if (nodeType.toLowerCase().includes(searchTerm)) {
                                allResults.push({
                                    type: 'Node Type',
                                    title: `${nodeType} Nodes`,
                                    subtitle: `${this.data.type_distribution[nodeType]} total`,
                                    icon: 'fas fa-tag',
                                    data: { nodeType, count: this.data.type_distribution[nodeType] }
                                });
                            }
                        });
                    }
                }

                if (allResults.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-search"></i>
                            <div>No results found for "${query}"</div>
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = allResults.map(result => `
                        <div class="search-result-item" data-type="${result.type}">
                            <div class="result-icon">
                                <i class="${result.icon}"></i>
                            </div>
                            <div class="result-content">
                                <div class="result-title">${result.title}</div>
                                <div class="result-subtitle">${result.subtitle}</div>
                                <div class="result-type">${result.type}</div>
                            </div>
                        </div>
                    `).join('');
                }
            }

            getNodeType(nodeId) {
                if (nodeId.startsWith('var.')) return 'Variable';
                if (nodeId.startsWith('local.')) return 'Local';
                if (nodeId.startsWith('output.')) return 'Output';
                if (nodeId.startsWith('data.')) return 'Data Source';
                if (nodeId.startsWith('module.')) return 'Module';
                if (nodeId.includes('aws_')) return 'AWS Resource';
                if (nodeId.includes('google_')) return 'Google Resource';
                if (nodeId.includes('azure_')) return 'Azure Resource';
                return 'Resource';
            }

            applyTheme(theme) {
                document.body.setAttribute('data-theme', theme);
                this.showSuccessToast(`Theme changed to ${theme}`);
            }

            showModal(title, content, onOpen = null) {
                // Remove existing modal if any
                const existingModal = document.getElementById('commandModal');
                if (existingModal) {
                    existingModal.remove();
                }

                const modal = document.createElement('div');
                modal.id = 'commandModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>${title}</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Add event listeners with better handling
                const closeModal = () => {
                    modal.style.opacity = '0';
                    modal.style.backdropFilter = 'blur(0px)';
                    modal.querySelector('.modal-content').style.transform = 'scale(0.9) translateY(20px)';
                    
                    setTimeout(() => {
                        if (modal.parentNode) {
                            modal.parentNode.removeChild(modal);
                        }
                    }, 300);
                };

                modal.querySelector('.modal-close').addEventListener('click', closeModal);

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });

                // Escape key to close
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);

                // Call onOpen callback if provided
                if (onOpen && typeof onOpen === 'function') {
                    setTimeout(onOpen, 50);
                }
            }

            showSuccessToast(message) {
                this.showToast(message, 'success');
            }

            showErrorToast(message) {
                this.showToast(message, 'error');
            }

            showLoadingToast(message) {
                this.showToast(message, 'loading');
            }

            showToast(message, type = 'info') {
                if (!this.toastContainer) {
                    console.log(`[${type.toUpperCase()}] ${message}`);
                    return;
                }

                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    loading: 'spinner fa-spin',
                    info: 'info-circle'
                };

                toast.innerHTML = `
                    <div class="toast-content">
                        <i class="fas fa-${icons[type]}"></i>
                        <span>${message}</span>
                    </div>
                `;

                this.toastContainer.appendChild(toast);

                // Trigger animation
                setTimeout(() => toast.classList.add('show'), 10);

                // Auto-remove after 3 seconds (except loading toasts)
                if (type !== 'loading') {
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.classList.remove('show');
                            setTimeout(() => {
                                if (toast.parentNode) {
                                    toast.parentNode.removeChild(toast);
                                }
                            }, 300);
                        }
                    }, 3000);
                }

                return toast;
            }

            addCommand(command) {
                if (!command.id || !command.title || !command.action) {
                    console.error('Invalid command structure');
                    return;
                }
                
                this.commands.push({
                    category: 'Custom',
                    keywords: [],
                    ...command
                });
            }

            removeCommand(commandId) {
                this.commands = this.commands.filter(cmd => cmd.id !== commandId);
            }

            updateConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
            }
        }
    </script>
    <script>
    </script>
    <script>
        // Enhanced AnalyticsManager with comprehensive data analysis
        class AnalyticsManager {
            constructor(data) {
                this.data = data;
                this.charts = new Map();
                this.currentTheme = this.getThemeColors();
                this.networkInstance = null;
                this.debounceTimers = new Map();
                this.currentTab = 'overview';
                this.init();
            }

            getThemeColors() {
                const style = getComputedStyle(document.documentElement);
                return {
                    bgPrimary: style.getPropertyValue('--bg-primary').trim(),
                    bgSecondary: style.getPropertyValue('--bg-secondary').trim(),
                    bgTertiary: style.getPropertyValue('--bg-tertiary').trim(),
                    textPrimary: style.getPropertyValue('--text-primary').trim(),
                    textSecondary: style.getPropertyValue('--text-secondary').trim(),
                    accent: style.getPropertyValue('--accent').trim(),
                    accentSecondary: style.getPropertyValue('--accent-secondary').trim(),
                    success: style.getPropertyValue('--success').trim(),
                    warning: style.getPropertyValue('--warning').trim(),
                    danger: style.getPropertyValue('--danger').trim(),
                    info: style.getPropertyValue('--info').trim(),
                    border: style.getPropertyValue('--border').trim()
                };
            }

            init() {
                this.setupEventListeners();
                this.renderStats();
                this.createCharts();
                this.renderCriticalNodes();
                this.renderLongestPaths();
                this.createAdvancedMetrics();
                this.createRiskHeatmap();
                this.renderProviderAnalysis();
                this.renderModuleAnalysis();
                this.renderOptimizationInsights();
                
                this.setupLazyLoading();
            }

            setupEventListeners() {
                // Fixed sidebar navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tabName = e.currentTarget.dataset.tab;
                        this.switchTab(tabName);
                    });
                });

                // Network controls
                document.getElementById('zoomIn')?.addEventListener('click', () => this.zoomNetwork(1.2));
                document.getElementById('zoomOut')?.addEventListener('click', () => this.zoomNetwork(0.8));
                document.getElementById('resetView')?.addEventListener('click', () => this.resetNetworkView());
                document.getElementById('fullscreen')?.addEventListener('click', () => this.toggleFullscreen());

                // Export functionality
                document.getElementById('exportBtn')?.addEventListener('click', () => this.exportData());
                document.getElementById('refreshBtn')?.addEventListener('click', () => this.refreshData());

                // Window resize with debounce
                window.addEventListener('resize', this.debounce(() => this.handleResize(), 250));
            }

            setupLazyLoading() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const tabId = entry.target.id;
                            if (tabId === 'network' && !this.networkInstance) {
                                this.createNetworkGraph();
                            }
                        }
                    });
                }, { threshold: 0.1 });

                document.querySelectorAll('.tab-content').forEach(tab => {
                    observer.observe(tab);
                });
            }

            debounce(func, wait) {
                return (...args) => {
                    const key = func.toString();
                    clearTimeout(this.debounceTimers.get(key));
                    this.debounceTimers.set(key, setTimeout(() => func.apply(this, args), wait));
                };
            }

            switchTab(tabName) {
                // Update navigation items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.tab === tabName) {
                        item.classList.add('active');
                    }
                });

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                const targetTab = document.getElementById(tabName);
                if (targetTab) {
                    targetTab.classList.add('active');
                    this.currentTab = tabName;
                }


                // Refresh charts on tab switch for proper rendering
                setTimeout(() => {
                    this.handleResize();
                }, 100);
            }

            renderStats() {
                const stats = [
                    { 
                        label: 'Total Nodes', 
                        value: this.data.total_nodes, 
                        icon: 'fas fa-cube',
                        trend: 'stable'
                    },
                    { 
                        label: 'Total Edges', 
                        value: this.data.total_edges, 
                        icon: 'fas fa-link',
                        trend: 'up'
                    },
                    { 
                        label: 'Components', 
                        value: this.data.total_components, 
                        icon: 'fas fa-puzzle-piece',
                        trend: 'stable'
                    },
                    { 
                        label: 'Graph Density', 
                        value: this.data.graph_density.toFixed(4), 
                        icon: 'fas fa-circle-nodes',
                        trend: 'low'
                    },
                    { 
                        label: 'Network Diameter', 
                        value: this.data.diameter, 
                        icon: 'fas fa-arrows-alt-h',
                        trend: 'stable'
                    },
                    { 
                        label: 'Technical Debt', 
                        value: `${this.data.technical_debt_score.toFixed(1)}%`, 
                        icon: 'fas fa-coins',
                        trend: this.data.technical_debt_score > 70 ? 'high' : 'moderate'
                    },
                    { 
                        label: 'Maintainability', 
                        value: `${this.data.maintainability_index.toFixed(1)}%`, 
                        icon: 'fas fa-tools',
                        trend: this.data.maintainability_index > 80 ? 'good' : 'warning'
                    },
                    { 
                        label: 'Avg Path Length', 
                        value: this.data.avg_path_length.toFixed(2), 
                        icon: 'fas fa-road',
                        trend: 'stable'
                    }
                ];

                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = stats.map(stat => `
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="${stat.icon}"></i>
                        </div>
                        <div class="stat-value">${stat.value}</div>
                        <div class="stat-label">${stat.label}</div>
                        <div class="stat-trend ${stat.trend}">
                            <i class="fas fa-${this.getTrendIcon(stat.trend)}"></i>
                            ${this.getTrendText(stat.trend)}
                        </div>
                    </div>
                `).join('');
            }

            getTrendIcon(trend) {
                const icons = {
                    up: 'arrow-up',
                    down: 'arrow-down',
                    stable: 'minus',
                    high: 'exclamation-triangle',
                    moderate: 'info-circle',
                    good: 'check-circle',
                    warning: 'exclamation-circle',
                    low: 'arrow-down'
                };
                return icons[trend] || 'minus';
            }

            getTrendText(trend) {
                const texts = {
                    up: 'Increasing',
                    down: 'Decreasing',
                    stable: 'Stable',
                    high: 'High',
                    moderate: 'Moderate',
                    good: 'Good',
                    warning: 'Warning',
                    low: 'Low'
                };
                return texts[trend] || 'Stable';
            }

            createCharts() {
                this.createDistributionChart('typeChart', 'Type Distribution', this.data.type_distribution, [
                    this.currentTheme.accent,
                    this.currentTheme.success,
                    this.currentTheme.warning,
                    this.currentTheme.danger,
                    this.currentTheme.accentSecondary,
                    this.currentTheme.info,
                    '#2dd4bf',
                    '#fb923c'
                ]);

                this.createDistributionChart('riskChart', 'Risk Distribution', this.data.risk_distribution, [
                    this.currentTheme.danger,
                    this.currentTheme.warning,
                    this.currentTheme.success,
                    this.currentTheme.accentSecondary
                ]);

                this.createDistributionChart('complexityChart', 'Complexity Distribution', this.data.complexity_distribution, [
                    this.currentTheme.success,
                    '#34d399',
                    this.currentTheme.warning,
                    this.currentTheme.danger
                ]);

                this.createDistributionChart('stateChart', 'State Distribution', this.data.state_distribution, [
                    this.currentTheme.accent,
                    this.currentTheme.accentSecondary,
                    '#f472b6',
                    this.currentTheme.warning,
                    this.currentTheme.danger,
                    this.currentTheme.success,
                    '#2dd4bf'
                ]);

                this.createDistributionChart('linkTypeChart', 'Link Type Distribution', this.data.link_type_distribution, [
                    this.currentTheme.accent,
                    this.currentTheme.success,
                    this.currentTheme.warning,
                    this.currentTheme.info,
                    this.currentTheme.accentSecondary,
                    '#2dd4bf'
                ]);

                this.createDistributionChart('moduleChart', 'Module Distribution', this.data.module_distribution, [
                    this.currentTheme.accent,
                    this.currentTheme.accentSecondary
                ]);
            }

            createDistributionChart(canvasId, title, data, colors) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                
                if (this.charts.has(canvasId)) {
                    this.charts.get(canvasId).destroy();
                }

                const chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data),
                        datasets: [{
                            data: Object.values(data),
                            backgroundColor: colors,
                            borderColor: this.currentTheme.bgSecondary,
                            borderWidth: 3,
                            borderRadius: 6,
                            spacing: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: this.currentTheme.textPrimary,
                                    font: { size: 11 },
                                    padding: 15,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '60%',
                        animation: {
                            animateScale: true,
                            animateRotate: true,
                            duration: 800
                        }
                    }
                });

                this.charts.set(canvasId, chart);
            }

            getNodeTypeIcon(nodeType) {
                switch (nodeType) {
                    case 'resource':
                        return 'fas fa-server';
                    case 'variable':
                        return 'fas fa-variable'; // Font Awesome 6
                    case 'local':
                        return 'fas fa-code-branch';
                    case 'output':
                        return 'fas fa-sign-out-alt';
                    case 'data':
                        return 'fas fa-database';
                    case 'module':
                        return 'fas fa-cube';
                    default:
                        return 'fas fa-asterisk';
                }
            }


        // --- REWORKED renderCriticalNodes ---
            renderCriticalNodes() {
                const container = document.getElementById('criticalNodes');

                // Mapped fas icons to replace emojis
                const sections = [
                    {
                        title: 'High Risk Nodes',
                        icon: 'fas fa-exclamation-triangle', // Replaced 
                        nodes: this.data.high_risk_nodes || [],
                        getRiskClass: (risk) => risk > 15 ? 'risk-high' : risk > 10 ? 'risk-moderate' : 'risk-low'
                    },
                    {
                        title: 'Hub Nodes (High Degree)',
                        icon: 'fas fa-share-alt', // Replaced 
                        nodes: this.data.hub_nodes || []
                    },
                    {
                        title: 'Bottleneck Nodes (High Betweenness)',
                        icon: 'fas fa-compress-alt', // Replaced 
                        nodes: this.data.bottleneck_nodes || []
                    },
                    {
                        title: 'Bridge Nodes (Key Connectors)',
                        icon: 'fas fa-route', // Replaced 
                        nodes: this.data.bridge_nodes || []
                    },
                    {
                        title: 'Authority Nodes (High In-Degree)',
                        icon: 'fas fa-star', // Replaced /
                        nodes: this.data.authority_nodes || []
                    },
                    {
                        title: 'Leaf Nodes (No Dependencies)',
                        icon: 'fas fa-terminal', // Replaced 
                        nodes: this.data.leaf_nodes || []
                    }
                ];

                container.innerHTML = sections.map(section => {
                    // Skip sections with no nodes unless it's a critical category
                    if (section.nodes.length === 0 && section.title !== 'High Risk Nodes') {
                        return '';
                    }

                    return `
                        <div class="nodes-section">
                            <div class="section-header">
                                <div class="section-title">
                                    <i class="${section.icon} section-icon"></i>
                                    ${section.title}
                                </div>
                                <div class="section-count">${section.nodes.length}</div>
                            </div>
                            <div class="nodes-list">
                                ${this.renderNodeList(section.nodes, section.getRiskClass)}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderNodeList(nodes, riskClassFn) {
                if (!nodes || nodes.length === 0) {
                    return '<div class="node-item node-empty">No critical nodes in this category.</div>';
                }

                const displayNodes = nodes.slice(0, 10); // Display slightly more, up to 10

                return displayNodes.map(node => {
                    const nodeName = Array.isArray(node) ? node[0] : node;
                    const riskScore = Array.isArray(node) ? node[1] : null;

                    let riskBadge = '';
                    let nodeRiskClass = '';
                    
                    if (riskScore !== null) {
                        // Determine risk class for coloring
                        if (riskScore > 15) {
                            nodeRiskClass = 'risk-high';
                            riskBadge = `<div class="risk-badge risk-high" title="Risk Score">${Math.round(riskScore)}</div>`;
                        } else if (riskScore > 10) {
                            nodeRiskClass = 'risk-moderate';
                            riskBadge = `<div class="risk-badge risk-moderate" title="Risk Score">${Math.round(riskScore)}</div>`;
                        } else if (riskScore > 5) {
                            nodeRiskClass = 'risk-low';
                            riskBadge = `<div class="risk-badge risk-low" title="Risk Score">${Math.round(riskScore)}</div>`;
                        } else {
                            nodeRiskClass = 'risk-safe';
                        }
                    }
                    
                    const nodeType = this.getNodeType(nodeName);
                    const nodeTags = this.getNodeTags(nodeName, nodeType);
                    const typeIcon = this.getNodeTypeIcon(nodeType);

                    return `
                        <div class="node-item ${nodeRiskClass}" title="${nodeName}">
                            <i class="${typeIcon} node-type-icon"></i>
                            <div class="node-content">
                                <div class="node-info">
                                    <div class="node-name">${this.formatNodeName(nodeName)}</div>
                                    <div class="node-meta">
                                        ${nodeTags.map(tag => `<span class="node-tag">${tag}</span>`).join('')}
                                    </div>
                                </div>
                                ${riskBadge}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            getNodeType(nodeName) {
                if (nodeName.startsWith('var.')) return 'variable';
                if (nodeName.startsWith('local.')) return 'local';
                if (nodeName.startsWith('aws.')) return 'resource';
                if (nodeName.startsWith('output.')) return 'output';
                if (nodeName.startsWith('data.')) return 'data';
                if (nodeName.startsWith('module.')) return 'module';
                return 'other';
            }

            getNodeTags(nodeName, nodeType) {
                const tags = [nodeType];
                
                if (this.data.hub_nodes.includes(nodeName)) tags.push('hub');
                if (this.data.bottleneck_nodes.includes(nodeName)) tags.push('bottleneck');
                if (this.data.bridge_nodes.includes(nodeName)) tags.push('bridge');
                if (this.data.authority_nodes.includes(nodeName)) tags.push('authority');
                if (this.data.leaf_nodes.includes(nodeName)) tags.push('leaf');
                
                return tags.slice(0, 3);
            }

            formatNodeName(name) {
                if (name.length > 50) {
                    return name.substring(0, 47) + '...';
                }
                return name;
            }

            renderLongestPaths() {
                const container = document.getElementById('pathsContainer');
                if (!container || !this.data || !this.data.longest_paths) {
                    if (container) container.innerHTML = '<p class="info-message">No critical paths found or data is loading.</p>';
                    return;
                }
                
                // Using the full list for visualization
                const paths = this.data.longest_paths;

                container.innerHTML = paths.map((path, index) => {
                    const riskLevel = path.risk_level ? path.risk_level.toLowerCase() : 'safe';
                    const riskClass = `flow-${riskLevel}`;
                    
                    const pathNodes = path.path || [];
                    if (pathNodes.length === 0) return '';

                    const startNodeName = this.formatNodeName(pathNodes[0]);
                    const endNodeName = this.formatNodeName(pathNodes[pathNodes.length - 1]);

                    return `
                        <div class="flow-path-item ${riskClass}">
                            <div class="flow-path-header">
                                <div class="flow-path-title">
                                    <i class="fas fa-sitemap"></i>
                                    <span>Path ${index + 1}: ${startNodeName} &rarr; ${endNodeName}</span>
                                </div>
                                <div class="flow-path-metrics">
                                    <span class="flow-metric-badge ${riskClass}">Risk: ${path.risk_level || 'Safe'}</span>
                                    <span class="flow-metric-text"><i class="fas fa-ruler-horizontal"></i> Length: ${path.length || 0}</span>
                                    <span class="flow-metric-text"><i class="fas fa-chart-line"></i> Score: ${path.risk_score ? path.risk_score.toFixed(1) : '0.0'}</span>
                                </div>
                            </div>
                            
                            <div class="flow-card-container">
                                ${pathNodes.map((node, i) => {
                                    const nodeDetail = (this.data.nodes && this.data.nodes[node]) || { risk_level: 'safe' };
                                    const nodeRiskClass = `node-${nodeDetail.risk_level.toLowerCase()}`;
                                    const nodeName = this.formatNodeName(node);
                                    const isEnd = i === pathNodes.length - 1;
                                    const isStart = i === 0;

                                    return `
                                        <div class="flow-node-card ${nodeRiskClass}">
                                            <div class="node-icon">
                                                <i class="fas fa-${isStart ? 'arrow-alt-circle-right' : isEnd ? 'flag-checkered' : 'dot-circle'}"></i>
                                            </div>
                                            <span class="node-label">${nodeName}</span>
                                        </div>
                                        ${!isEnd ? '<div class="flow-connector"></div>' : ''}
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            createAdvancedMetrics() {
                // Set metric values
                document.getElementById('cyclomaticComplexity').textContent = this.data.cyclomatic_complexity;
                document.getElementById('cognitiveComplexity').textContent = this.data.cognitive_complexity.toFixed(1);
                document.getElementById('maintainabilityIndex').textContent = `${this.data.maintainability_index.toFixed(1)}%`;
                document.getElementById('technicalDebt').textContent = `${this.data.technical_debt_score.toFixed(1)}%`;

                this.createCentralityChart();
                this.createDegreeChart();
                this.createDegreeByTypeChart();
                this.createComponentSizeChart();
            }

            createCentralityChart() {
                const ctx = document.getElementById('centralityChart').getContext('2d');
                
                const sampleNodes = Object.values(this.data.node_metrics).slice(0, 8);
                const labels = sampleNodes.map(node => this.formatNodeName(node.node_id));
                
                const centralityData = {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Betweenness Centrality',
                            data: sampleNodes.map(node => node.betweenness_centrality * 1000),
                            borderColor: this.currentTheme.accent,
                            backgroundColor: this.currentTheme.accent + '20',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Closeness Centrality',
                            data: sampleNodes.map(node => node.closeness_centrality * 100),
                            borderColor: this.currentTheme.success,
                            backgroundColor: this.currentTheme.success + '20',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                };

                new Chart(ctx, {
                    type: 'line',
                    data: centralityData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: this.currentTheme.textPrimary }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textSecondary }
                            },
                            y: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textSecondary }
                            }
                        }
                    }
                });
            }

            createDegreeChart() {
                const ctx = document.getElementById('degreeChart').getContext('2d');
                
                const degreeData = {
                    labels: ['Minimal', 'Low', 'Medium', 'High'],
                    datasets: [{
                        label: 'Node Count',
                        data: [
                            this.data.complexity_distribution.minimal,
                            this.data.complexity_distribution.low,
                            this.data.complexity_distribution.medium,
                            this.data.complexity_distribution.high
                        ],
                        backgroundColor: [
                            this.currentTheme.success,
                            this.currentTheme.info,
                            this.currentTheme.warning,
                            this.currentTheme.danger
                        ],
                        borderColor: this.currentTheme.bgSecondary,
                        borderWidth: 2
                    }]
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: degreeData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textPrimary }
                            },
                            y: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textSecondary }
                            }
                        }
                    }
                });
            }

            createDegreeByTypeChart() {
                const ctx = document.getElementById('degreeByTypeChart').getContext('2d');
                
                const degreeData = {
                    labels: ['Resource', 'Local', 'Variable'],
                    datasets: [{
                        label: 'Average Degree',
                        data: [
                            this.data.avg_resource_degree,
                            this.data.avg_local_degree,
                            this.data.avg_variable_degree
                        ],
                        backgroundColor: [
                            this.currentTheme.accent,
                            this.currentTheme.success,
                            this.currentTheme.warning
                        ],
                        borderColor: this.currentTheme.bgSecondary,
                        borderWidth: 2
                    }]
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: degreeData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textPrimary }
                            },
                            y: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textSecondary }
                            }
                        }
                    }
                });
            }

            createComponentSizeChart() {
                const ctx = document.getElementById('componentSizeChart').getContext('2d');
                
                const componentSizes = Object.values(this.data.components).map(comp => comp.size);
                const sizeData = {
                    labels: componentSizes.map((_, i) => `Component ${i}`),
                    datasets: [{
                        label: 'Component Size',
                        data: componentSizes,
                        backgroundColor: this.currentTheme.accent,
                        borderColor: this.currentTheme.bgSecondary,
                        borderWidth: 2
                    }]
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: sizeData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textPrimary }
                            },
                            y: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textSecondary }
                            }
                        }
                    }
                });
            }

            createRiskHeatmap() {
                const ctx = document.getElementById('riskHeatmap').getContext('2d');
                
                const riskData = {
                    labels: ['Safe', 'Low', 'Moderate', 'High'],
                    datasets: [{
                        data: [
                            this.data.risk_distribution.safe,
                            this.data.risk_distribution.low,
                            this.data.risk_distribution.moderate,
                            this.data.risk_distribution.high
                        ],
                        backgroundColor: [
                            this.currentTheme.success,
                            this.currentTheme.info,
                            this.currentTheme.warning,
                            this.currentTheme.danger
                        ]
                    }]
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: riskData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textPrimary }
                            },
                            y: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textSecondary }
                            }
                        }
                    }
                });

                // Render risk insights
                this.renderRiskInsights();
            }

            renderRiskInsights() {
                const container = document.getElementById('riskInsights');

                const insights = [
                    {
                        title: 'High Risk Nodes',
                        description: `${this.data.high_risk_nodes.length} nodes show elevated or critical risk.`,
                        severity: 'high',
                        icon: 'fas fa-fire-flame-curved'
                    },
                    {
                        title: 'Bottleneck Analysis',
                        description: `${this.data.bottleneck_nodes.length} bottleneck nodes may restrict flow or performance.`,
                        severity: 'medium',
                        icon: 'fas fa-diagram-project'
                    },
                    {
                        title: 'Architecture Quality',
                        description: `Quality Score: ${this.data.architecture_quality_score.toFixed(1)}%`,
                        severity: 'good',
                        icon: 'fas fa-shield-halved'
                    }
                ];

                container.innerHTML = insights.map(insight => `
                    <div class="insight-card insight-${insight.severity}">
                        <div class="insight-header">
                            <div class="insight-icon">
                                <i class="${insight.icon}"></i>
                            </div>
                            <div>
                                <div class="insight-title">${insight.title}</div>
                                <div class="insight-severity ${insight.severity}">
                                    ${insight.severity.toUpperCase()}
                                </div>
                            </div>
                        </div>
                        <div class="insight-content">${insight.description}</div>
                    </div>
                `).join('');
            }

            getSeverityColor(severity) {
                return {
                    high: this.currentTheme.danger,
                    medium: this.currentTheme.warning,
                    good: this.currentTheme.success,
                    low: this.currentTheme.info
                }[severity] || this.currentTheme.info;
            }


            renderProviderAnalysis() {
                const container = document.getElementById('providerGrid');
                const providers = Object.entries(this.data.provider_distribution);

                container.innerHTML = providers.map(([provider, count]) => `
                    <div class="provider-card">
                        <div class="provider-header">
                            <div class="provider-name">${provider}</div>
                            <div class="provider-count">${count}</div>
                        </div>
                        <div class="metric-description">
                            ${this.getProviderDescription(provider)}
                        </div>
                    </div>
                `).join('');

                this.createProviderCouplingChart();
            }

            getProviderDescription(provider) {
                const descriptions = {
                    'aws': 'Primary AWS provider for main resources',
                    'aws.secondary': 'Secondary AWS provider for cross-region resources',
                    'random': 'Random provider for generating unique values',
                    'null': 'Null provider for orchestration tasks'
                };
                return descriptions[provider] || 'Terraform provider';
            }

            createProviderCouplingChart() {
                const ctx = document.getElementById('providerCouplingChart').getContext('2d');
                
                const couplingData = {
                    labels: Object.keys(this.data.provider_coupling),
                    datasets: [{
                        label: 'Coupling Strength',
                        data: Object.values(this.data.provider_coupling),
                        backgroundColor: this.currentTheme.accent,
                        borderColor: this.currentTheme.bgSecondary,
                        borderWidth: 2
                    }]
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: couplingData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textPrimary }
                            },
                            y: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textSecondary }
                            }
                        }
                    }
                });
            }

            renderModuleAnalysis() {
                const container = document.getElementById('moduleAnalysis');
                const modules = Object.values(this.data.module_analysis);

                container.innerHTML = modules.map(module => `
                    <div class="nodes-section">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="fas fa-cube"></i>
                                ${module.module_name}
                            </div>
                            <div class="section-count">${module.node_count} nodes</div>
                        </div>
                        <div class="component-metrics">
                            <div class="component-metric">
                                <div class="metric-label">Resources</div>
                                <div class="metric-value">${module.resource_count}</div>
                            </div>
                            <div class="component-metric">
                                <div class="metric-label">Cohesion</div>
                                <div class="metric-value">${module.cohesion.toFixed(3)}</div>
                            </div>
                            <div class="component-metric">
                                <div class="metric-label">Coupling</div>
                                <div class="metric-value">${module.coupling.toFixed(3)}</div>
                            </div>
                            <div class="component-metric">
                                <div class="metric-label">Reusability</div>
                                <div class="metric-value">${(module.reusability_score * 100).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                `).join('');

                this.createModuleQualityChart();
            }

            createModuleQualityChart() {
                const ctx = document.getElementById('moduleQualityChart').getContext('2d');
                const modules = Object.values(this.data.module_analysis);

                const moduleData = {
                    labels: modules.map(m => m.module_name),
                    datasets: [
                        {
                            label: 'Cohesion',
                            data: modules.map(m => m.cohesion * 100),
                            backgroundColor: this.currentTheme.success
                        },
                        {
                            label: 'Reusability',
                            data: modules.map(m => m.reusability_score * 100),
                            backgroundColor: this.currentTheme.accent
                        }
                    ]
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: moduleData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: this.currentTheme.textPrimary }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textPrimary }
                            },
                            y: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textSecondary }
                            }
                        }
                    }
                });
            }

            renderOptimizationInsights() {
                const container = document.getElementById('optimizationInsights');
                
                const insights = this.data.optimization_opportunities.map(opp => `
                    <div class="insight-card">
                        <div class="insight-header">
                            <div class="insight-icon" style="background: ${this.getSeverityColor(opp.severity)}">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div class="insight-title">${opp.type.replace(/_/g, ' ').toUpperCase()}</div>
                        </div>
                        <div class="insight-content">
                            <strong>${opp.description}</strong><br>
                            ${opp.suggestion}
                        </div>
                        <div class="insight-actions">
                            <span class="node-tag">${opp.severity}</span>
                        </div>
                    </div>
                `).join('');

                const refactoring = this.data.refactoring_suggestions.map(suggestion => `
                    <div class="insight-card">
                        <div class="insight-header">
                            <div class="insight-icon" style="background: ${this.getPriorityColor(suggestion.priority)}">
                                <i class="fas fa-hammer"></i>
                            </div>
                            <div class="insight-title">${suggestion.type.replace(/_/g, ' ').toUpperCase()}</div>
                        </div>
                        <div class="insight-content">
                            <strong>${suggestion.description}</strong><br>
                            ${suggestion.suggestion}
                        </div>
                        <div class="insight-actions">
                            <span class="node-tag">${suggestion.priority}</span>
                            <span class="node-tag">${suggestion.estimated_effort}</span>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = insights + refactoring;

                this.createArchitectureQualityChart();
            }

            getPriorityColor(priority) {
                const colors = {
                    high: this.currentTheme.danger,
                    medium: this.currentTheme.warning,
                    low: this.currentTheme.info
                };
                return colors[priority] || this.currentTheme.info;
            }

            createArchitectureQualityChart() {
                const ctx = document.getElementById('architectureQualityChart').getContext('2d');
                
                const qualityData = {
                    labels: ['Architecture Quality'],
                    datasets: [
                        {
                            label: 'Current Score',
                            data: [this.data.architecture_quality_score],
                            backgroundColor: this.currentTheme.accent,
                            borderColor: this.currentTheme.bgSecondary,
                            borderWidth: 2
                        },
                        {
                            label: 'Target Score',
                            data: [90],
                            backgroundColor: this.currentTheme.success + '80',
                            borderColor: this.currentTheme.success,
                            borderWidth: 2
                        }
                    ]
                };

                new Chart(ctx, {
                    type: 'bar',
                    data: qualityData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: this.currentTheme.textPrimary }
                            }
                        },
                        scales: {
                            x: {
                                min: 0,
                                max: 100,
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textSecondary }
                            },
                            y: {
                                grid: { color: this.currentTheme.border + '50' },
                                ticks: { color: this.currentTheme.textPrimary }
                            }
                        }
                    }
                });
            }

            zoomNetwork(factor) {
                if (this.networkInstance) {
                    this.networkInstance.zoom *= factor;
                    console.log(`Zoom level: ${this.networkInstance.zoom}`);
                }
            }

            resetNetworkView() {
                if (this.networkInstance) {
                    this.networkInstance.zoom = 1;
                    console.log('View reset');
                }
            }

            toggleFullscreen() {
                const container = document.querySelector('.network-container');
                if (!document.fullscreenElement) {
                    container.requestFullscreen().catch(err => {
                        console.log(`Error attempting to enable fullscreen: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen();
                }
            }

            exportData() {
                const dataStr = JSON.stringify(this.data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'terraform-analytics.json';
                link.click();
                URL.revokeObjectURL(url);
            }

            refreshData() {
                document.body.classList.add('loading');
                
                setTimeout(() => {
                    document.body.classList.remove('loading');
                    console.log('Data refreshed');
                }, 1000);
            }

            handleResize() {
                this.charts.forEach(chart => {
                    chart.resize();
                });
            }

            destroy() {
                this.charts.forEach(chart => chart.destroy());
                this.charts.clear();
                this.debounceTimers.clear();
                
                if (this.networkInstance) {
                    this.networkInstance = null;
                }
            }
        }

        // Initialize the dashboard with your complete dataset
        document.addEventListener('DOMContentLoaded', () => {
            // Replace with your complete dataset
            const analyticsData = {}; // Your complete JSON data here
            
            window.analyticsManager = new AnalyticsManager(analyticsData);
        });

        window.addEventListener('beforeunload', () => {
            if (window.analyticsManager) {
                window.analyticsManager.destroy();
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            try {
                const analyticsData = {{ analytics_data| safe }}

                const commandPalette = new CommandPalette(analyticsData);
                const analyticsManager = new AnalyticsManager(analyticsData);

                window.commandPalette = commandPalette;
                window.analyticsManager = analyticsManager;

                console.log('Command palette initialized successfully');
            } catch (error) {
                console.error('Failed to initialize command palette:', error);

                document.getElementById('statsGrid').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value"></div>
                        <div class="stat-label">Data Loading Error</div>
                    </div>
                `;
            }
        });
    </script>
</body>

</html>