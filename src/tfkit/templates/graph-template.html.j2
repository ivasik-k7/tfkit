<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }} - Graph View</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Exo+2:wght@300;400;500;600&display=swap"
        rel="stylesheet" />
    <!-- prettier-ignore -->
    <style>
    {% set colors = theme_colors %}
    /* Command Palette Styles */
    .backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 10000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
    }
    .backdrop.show {
        opacity: 1;
        visibility: visible;
    }
    .command-palette {
        position: fixed;
        top: 20%;
        left: 50%;
        transform: translateX(-50%) scale(0.9);
        background: {{ colors.bg_secondary }};
        border: 1px solid {{ colors.border }};
        border-radius: 12px;
        box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        width: 90%;
        max-width: 600px;
        z-index: 10001;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
    }
    .command-palette.show {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) scale(1);
    }
    .command-header {
        padding: 20px;
        border-bottom: 1px solid {{ colors.border }};
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .command-input {
        background: none;
        border: none;
        color: {{ colors.text_primary }};
        font-size: 1.1em;
        flex: 1;
        outline: none;
        font-family: 'Exo 2', sans-serif;
    }
    .command-input::placeholder {
        color: {{ colors.text_secondary }};
    }
    .command-shortcut {
        background: {{ colors.bg_primary }};
        color: {{ colors.text_secondary }};
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.8em;
        font-family: monospace;
    }
    .command-list {
        max-height: 400px;
        overflow-y: auto;
    }
    .command-item {
        padding: 16px 20px;
        border-bottom: 1px solid {{ colors.border }};
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: background 0.2s ease;
    }
    .command-item:hover,
    .command-item.selected {
        background: {{ colors.bg_tertiary }};
    }
    .command-item:last-child {
        border-bottom: none;
    }
    .command-icon {
        width: 20px;
        text-align: center;
        color: {{ colors.accent }};
    }
    .command-content {
        flex: 1;
    }
    .command-title {
        font-weight: 600;
        margin-bottom: 4px;
        color: {{ colors.text_primary }};
    }
    .command-description {
        font-size: 0.85em;
        color: {{ colors.text_secondary }};
    }
    .command-shortcut-item {
        background: {{ colors.bg_primary }};
        color: {{ colors.text_secondary }};
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.8em;
        font-family: monospace;
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10001;
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-width: 400px;
        pointer-events: none;
    }
    .toast {
        background: {{ colors.bg_secondary }};
        border: 1px solid {{ colors.border }};
        border-left: 4px solid {{ colors.accent }};
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        transform: translateX(400px);
        transition: transform 0.3s ease;
        display: flex;
        align-items: center;
        gap: 12px;
        pointer-events: auto;
    }
    .toast.show {
        transform: translateX(0);
    }
    .toast.success { border-left-color: {{ colors.success }}; }
    .toast.error { border-left-color: {{ colors.danger }}; }
    .toast.warning { border-left-color: {{ colors.warning }}; }
    .toast.info { border-left-color: {{ colors.info }}; }
    .toast-icon {
        font-size: 1.2em;
        color: {{ colors.accent }};
    }
    .toast.success .toast-icon { color: {{ colors.success }}; }
    .toast.error .toast-icon { color: {{ colors.danger }}; }
    .toast.warning .toast-icon { color: {{ colors.warning }}; }
    .toast.info .toast-icon { color: {{ colors.info }}; }
    .toast-content {
        flex: 1;
    }
    .toast-title {
        font-weight: 600;
        margin-bottom: 4px;
        color: {{ colors.text_primary }};
    }
    .toast-message {
        font-size: 0.9em;
        color: {{ colors.text_secondary }};
    }
    .toast-close {
        background: none;
        border: none;
        color: {{ colors.text_secondary }};
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    .toast-close:hover {
        background: {{ colors.bg_tertiary }};
        color: {{ colors.text_primary }};
    }

    /* Quick Action Bar */
    .quick-actions {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: {{ colors.bg_secondary }}d0;
        border: 1px solid {{ colors.border }};
        border-radius: 50px;
        padding: 12px 20px;
        display: flex;
        gap: 8px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        z-index: 9999;
        backdrop-filter: blur(10px);
    }
    .quick-action {
        background: {{ colors.bg_primary }};
        border: 1px solid {{ colors.border }};
        color: {{ colors.text_primary }};
        padding: 12px 16px;
        border-radius: 25px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        font-size: 0.9em;
        font-weight: 500;
    }
    .quick-action:hover {
        background: {{ colors.accent }};
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px {{ colors.accent }};
    }
    .quick-action:active {
        transform: translateY(0);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: 'Exo 2', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        background: {{ colors.bg_primary }};
        color: {{ colors.text_primary }};
        overflow: hidden;
    }
    #graph-container {
        width: 100vw;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: {{ colors.bg_primary }};
        overflow: hidden;
    }

    /* --- ENHANCED GRID BACKGROUND --- */
    #grid-pattern {
        fill: url(#grid);
    }

    /* --- WATERMARK --- */
    #watermark {
        position: absolute;
        bottom: 16px;
        left: 20px;
        font-size: 0.75em;
        color: {{ colors.text_secondary }}80;
        user-select: none;
        z-index: 1000;
        font-family: 'Exo 2', sans-serif;
    }
    .watermark-content {
        display: flex;
        align-items: center;
        gap: 20px;
        background: {{ colors.bg_secondary }}60;
        backdrop-filter: blur(8px);
        border: 1px solid {{ colors.border }}20;
        border-radius: 12px;
        padding: 12px 16px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .watermark-content:hover {
        background: {{ colors.bg_secondary }}80;
        border-color: {{ colors.accent }}30;
        transform: translateY(-2px);
        box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    }
    .watermark-brand {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        color: {{ colors.text_primary }};
    }
    .watermark-brand i {
        color: {{ colors.accent }};
        font-size: 1.1em;
        filter: drop-shadow(0 2px 4px {{ colors.accent }}30);
    }
    .brand-text {
        font-family: 'Orbitron', sans-serif;
        letter-spacing: 0.5px;
        background: linear-gradient(135deg, {{ colors.text_primary }} 0%, {{ colors.accent }} 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .version {
        font-size: 0.85em;
        color: {{ colors.text_secondary }};
        background: {{ colors.bg_primary }}30;
        padding: 2px 8px;
        border-radius: 8px;
        border: 1px solid {{ colors.border }}20;
        font-family: 'Exo 2', monospace;
    }
    .watermark-links {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .watermark-link {
        display: flex;
        align-items: center;
        gap: 6px;
        color: {{ colors.text_secondary }} !important;
        text-decoration: none;
        padding: 6px 10px;
        border-radius: 8px;
        transition: all 0.3s ease;
        font-weight: 500;
        border: 1px solid transparent;
    }
    .watermark-link:hover {
        color: {{ colors.accent }} !important;
        background: {{ colors.accent }}15;
        border-color: {{ colors.accent }}20;
        transform: translateY(-1px);
        text-decoration: none !important;
    }
    .watermark-link i {
        font-size: 0.9em;
        transition: all 0.3s ease;
    }
    .watermark-link:hover i {
        transform: scale(1.1);
        filter: drop-shadow(0 2px 4px {{ colors.accent }}30);
    }

    /* Pulse animation for brand icon */
    @keyframes pulse-glow {
        0%, 100% { 
        opacity: 1;
        filter: drop-shadow(0 2px 4px {{ colors.accent }}30);
        }
        50% { 
        opacity: 0.8;
        filter: drop-shadow(0 2px 8px {{ colors.accent }}50);
        }
    }
    .watermark-brand i {
        animation: pulse-glow 3s ease-in-out infinite;
    }
    .watermark-content:hover .watermark-brand i {
        animation: pulse-glow 1s ease-in-out infinite;
    }

    /* --- MODERN DASHBOARD HUD --- */
    .dashboard-hud {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
        font-family: 'Exo 2', sans-serif;
        width: 320px;
        opacity: 0.95;
        transition: opacity 0.3s ease;
    }
    .dashboard-hud:hover {
        opacity: 1;
    }
    .info-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 16px;
    }
    .info-card {
        background: {{ colors.bg_secondary }}90;
        backdrop-filter: blur(8px);
        border: 1px solid {{ colors.border }}20;
        padding: 16px;
        border-radius: 8px;
        transition: all 0.2s ease;
        text-align: center;
    }
    .info-card:hover {
        background: {{ colors.bg_secondary }};
        border-color: {{ colors.accent }}30;
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .info-value {
        font-size: 1.8em;
        font-weight: 600;
        color: {{ colors.text_primary }};
        font-family: 'Orbitron', sans-serif;
        line-height: 1;
        margin-bottom: 6px;
    }
    .info-label {
        font-size: 0.75em;
        color: {{ colors.text_secondary }};
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }
    .state-section {
        background: {{ colors.bg_secondary }}80;
        backdrop-filter: blur(8px);
        border: 1px solid {{ colors.border }}20;
        border-radius: 12px;
        padding: 20px;
        margin-top: 12px;
    }
    .state-title {
        font-size: 0.75em;
        color: {{ colors.text_secondary }};
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
    }
    .state-flow {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .state-item {
        background: {{ colors.bg_primary }}08;
        border-radius: 10px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }
    .state-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        transition: all 0.2s ease;
    }
    .state-item:hover {
        transform: translateX(4px);
        background: {{ colors.bg_primary }}12;
    }
    .state-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
    }
    .state-name {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 0.85em;
        color: {{ colors.text_primary }};
    }
    .state-icon {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9em;
    }
    .state-count {
        font-family: 'Orbitron', sans-serif;
        font-weight: 600;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        background: {{ colors.bg_primary }}15;
        color: {{ colors.text_primary }};
    }
    .state-info {
        display: flex;
        align-items: center;
        gap: 12px;
        padding-left: 32px;
    }
    .state-metric {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.75em;
        color: {{ colors.text_secondary }};
    }
    .state-metric i {
        font-size: 0.9em;
        opacity: 0.7;
    }

    /* Enhanced state styles for all new states */
    .state-active {
        background: linear-gradient(135deg, #22c55e20, #22c55e10);
        color: #22c55e;
        border-color: #22c55e40;
    }
    .state-hub {
        background: linear-gradient(135deg, #3b82f620, #3b82f610);
        color: #3b82f6;
        border-color: #3b82f640;
    }
    .state-bridge {
        background: linear-gradient(135deg, #06b6d420, #06b6d410);
        color: #06b6d4;
        border-color: #06b6d440;
    }
    .state-aggregator {
        background: linear-gradient(135deg, #8b5cf620, #8b5cf610);
        color: #8b5cf6;
        border-color: #8b5cf640;
    }
    .state-configuration {
        background: linear-gradient(135deg, #6b728020, #6b728010);
        color: #6b7280;
        border-color: #6b728040;
    }
    .state-config_provider {
        background: linear-gradient(135deg, #84cc1620, #84cc1610);
        color: #84cc16;
        border-color: #84cc1640;
    }
    .state-config_consumer {
        background: linear-gradient(135deg, #10b98120, #10b98110);
        color: #10b981;
        border-color: #10b98140;
    }
    .state-external {
        background: linear-gradient(135deg, #a855f720, #a855f710);
        color: #a855f7;
        border-color: #a855f740;
    }
    .state-dependency {
        background: linear-gradient(135deg, #3b82f620, #3b82f610);
        color: #3b82f6;
        border-color: #3b82f640;
    }
    .state-derived {
        background: linear-gradient(135deg, #06b6d420, #06b6d410);
        color: #06b6d4;
        border-color: #06b6d440;
    }
    .state-leaf {
        background: linear-gradient(135deg, #10b98120, #10b98110);
        color: #10b981;
        border-color: #10b98140;
    }
    .state-orphan {
        background: linear-gradient(135deg, #f59e0b20, #f59e0b10);
        color: #f59e0b;
        border-color: #f59e0b40;
    }
    .state-unused {
        background: linear-gradient(135deg, #6b728020, #6b728010);
        color: #6b7280;
        border-color: #6b728040;
    }
    .state-obsolete {
        background: linear-gradient(135deg, #9ca3af20, #9ca3af10);
        color: #9ca3af;
        border-color: #9ca3af40;
    }
    .state-stale {
        background: linear-gradient(135deg, #f59e0b20, #f59e0b10);
        color: #f59e0b;
        border-color: #f59e0b40;
    }
    .state-invalid {
        background: linear-gradient(135deg, #ef444420, #ef444410);
        color: #ef4444;
        border-color: #ef444440;
    }
    .state-unresolved {
        background: linear-gradient(135deg, #f8717120, #f8717110);
        color: #f87171;
        border-color: #f8717140;
    }
    .state-transient {
        background: linear-gradient(135deg, #a78bfa20, #a78bfa10);
        color: #a78bfa;
        border-color: #a78bfa40;
    }
    .state-ephemeral {
        background: linear-gradient(135deg, #c4b5fd20, #c4b5fd10);
        color: #c4b5fd;
        border-color: #c4b5fd40;
    }
    .state-shared {
        background: linear-gradient(135deg, #06b6d420, #06b6d410);
        color: #06b6d4;
        border-color: #06b6d440;
    }
    .state-unknown {
        background: linear-gradient(135deg, #9ca3af20, #9ca3af10);
        color: #9ca3af;
        border-color: #9ca3af40;
    }

    .controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: {{ colors.bg_secondary }}d0;
        border: 1px solid {{ colors.border }};
        border-radius: 12px;
        padding: 12px 20px;
        display: flex;
        gap: 8px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 1000;
    }
    .control-btn {
        background: {{ colors.bg_primary }};
        border: 1px solid {{ colors.border }};
        color: {{ colors.text_primary }};
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85em;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 500;
    }
    .control-btn:hover {
        background: {{ colors.accent }};
        border-color: {{ colors.accent }};
        color: {{ colors.bg_primary }};
        transform: translateY(-1px);
    }
    .control-btn:active {
        transform: translateY(0);
    }

    /* Configuration Viewer - Updated to match Dashboard HUD */
    .config-viewer {
        position: absolute;
        top: 20px;
        left: 360px;
        background: {{ colors.bg_secondary }}d0;
        backdrop-filter: blur(8px);
        border: 1px solid {{ colors.border }}20;
        border-radius: 12px;
        z-index: 1000;
        width: 300px;
        max-height: calc(100vh - 40px);
        overflow: hidden;
        transition: all 0.2s ease;
        font-family: 'Exo 2', sans-serif;
        opacity: 0.95;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    .config-viewer:hover {
        opacity: 1;
        background: {{ colors.bg_secondary }};
        border-color: {{ colors.accent }}30;
        transform: translateY(-1px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }
    .config-header {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 15px;
        cursor: pointer;
        user-select: none;
        border-bottom: 1px solid {{ colors.border }}20;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }
    .config-header:hover {
        background: {{ colors.bg_primary }}08;
    }
    .config-icon-wrapper {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        background: linear-gradient(135deg, {{ colors.accent }}20 0%, {{ colors.accent }}10 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        flex-shrink: 0;
        transition: all 0.2s ease;
    }
    .config-header:hover .config-icon-wrapper {
        transform: scale(1.05);
        box-shadow: 0 4px 16px {{ colors.accent }}20;
    }
    .config-icon-wrapper i {
        color: {{ colors.accent }};
        font-size: 1.4em;
    }
    .config-header-content {
        flex: 1;
        min-width: 0;
    }
    .config-title {
        color: {{ colors.text_primary }};
        font-size: 1.1em;
        font-weight: 700;
        font-family: 'Orbitron', sans-serif;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }
    .config-subtitle {
        font-size: 0.8em;
        color: {{ colors.text_secondary }};
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .config-subtitle span {
        color: {{ colors.accent }};
        font-weight: 700;
        font-family: 'Orbitron', sans-serif;
    }
    .config-toggle {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: {{ colors.bg_primary }}20;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s ease;
    }
    .config-header:hover .config-toggle {
        background: {{ colors.accent }}15;
        transform: scale(1.1);
    }
    .config-chevron {
        color: {{ colors.text_secondary }};
        transition: all 0.2s ease;
        font-size: 0.9em;
    }
    .config-toggle:hover .config-chevron {
        color: {{ colors.accent }};
    }
    .config-chevron.rotated {
        transform: rotate(180deg);
        color: {{ colors.accent }};
    }
    .config-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    .config-content.expanded {
        max-height: calc(100vh - 140px);
        overflow-y: auto;
    }

    /* Config File Item */
    .config-file {
        border-bottom: 1px solid {{ colors.border }}10;
        transition: all 0.2s ease;
    }
    .config-file:last-child {
        border-bottom: none;
    }
    .config-file-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px 20px;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
        position: relative;
    }
    .config-file-header:hover {
        background: {{ colors.bg_primary }}08;
        transform: translateX(4px);
    }
    .config-file-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: linear-gradient(135deg, {{ colors.info }}20 0%, {{ colors.info }}10 100%);
        color: {{ colors.info }};
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1em;
        flex-shrink: 0;
        transition: all 0.2s ease;
    }
    .config-file-header:hover .config-file-icon {
        transform: scale(1.1);
        box-shadow: 0 4px 12px {{ colors.info }}20;
    }
    .config-file-info {
        flex: 1;
        min-width: 0;
    }
    .config-file-name {
        font-weight: 700;
        color: {{ colors.text_primary }};
        font-size: 0.9em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 4px;
        font-family: 'Exo 2', monospace;
    }
    .config-file-path {
        font-size: 0.75em;
        color: {{ colors.text_secondary }};
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .config-file-path i {
        font-size: 0.9em;
        color: {{ colors.accent }};
    }
    .config-file-chevron {
        color: {{ colors.text_secondary }};
        transition: all 0.2s ease;
        font-size: 0.85em;
        flex-shrink: 0;
    }
    .config-file-header:hover .config-file-chevron {
        color: {{ colors.accent }};
    }
    .config-file-chevron.rotated {
        transform: rotate(90deg);
        color: {{ colors.accent }};
    }
    .config-file-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: {{ colors.bg_primary }}05;
    }
    .config-file-body.expanded {
        max-height: 500px;
        overflow-y: auto;
    }
    .config-variables {
        padding: 16px 20px;
        display: grid;
        gap: 12px;
    }

    /* Variable Card */
    .config-var {
        background: {{ colors.bg_secondary }}60;
        border: 1px solid {{ colors.border }}20;
        border-left: 3px solid {{ colors.accent }}50;
        border-radius: 8px;
        padding: 12px 16px;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }
    .config-var:hover {
        background: {{ colors.bg_secondary }}80;
        border-left-color: {{ colors.accent }};
        border-color: {{ colors.accent }}30;
        transform: translateX(4px);
        box-shadow: 0 4px 12px {{ colors.accent }}10;
    }
    .config-var-key {
        font-family: 'Exo 2', monospace;
        font-size: 0.85em;
        font-weight: 700;
        color: {{ colors.text_primary }};
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .config-var-key i {
        font-size: 0.85em;
        color: {{ colors.accent }};
    }
    .config-var-value {
        font-family: 'Exo 2', monospace;
        font-size: 0.8em;
        color: {{ colors.text_secondary }};
        padding: 8px 12px;
        background: {{ colors.bg_primary }}30;
        border-radius: 6px;
        word-break: break-word;
        white-space: pre-wrap;
        border: 1px solid {{ colors.border }}10;
        line-height: 1.6;
    }
    .config-var-type {
        display: inline-flex;
        align-items: center;
        font-size: 0.7em;
        padding: 3px 8px;
        border-radius: 6px;
        background: {{ colors.accent }}15;
        color: {{ colors.accent }};
        margin-left: auto;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid {{ colors.accent }}20;
    }

    /* Type-specific colors */
    .config-var-type.type-string {
        background: {{ colors.success }}15;
        color: {{ colors.success }};
        border-color: {{ colors.success }}20;
    }
    .config-var-type.type-number {
        background: {{ colors.info }}15;
        color: {{ colors.info }};
        border-color: {{ colors.info }}20;
    }
    .config-var-type.type-boolean {
        background: {{ colors.warning }}15;
        color: {{ colors.warning }};
        border-color: {{ colors.warning }}20;
    }
    .config-var-type.type-object {
        background: {{ colors.accent }}15;
        color: {{ colors.accent }};
        border-color: {{ colors.accent }}20;
    }
    .config-var-type.type-array {
        background: #8b5cf615;
        color: #8b5cf6;
        border-color: #8b5cf620;
    }

    /* Empty State */
    .config-empty {
        padding: 60px 30px;
        text-align: center;
        color: {{ colors.text_secondary }};
    }
    .config-empty i {
        font-size: 3em;
        color: {{ colors.text_secondary }}30;
        margin-bottom: 16px;
        display: block;
        opacity: 0.5;
    }
    .config-empty div {
        font-size: 0.9em;
        font-weight: 500;
    }

    .scale-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: {{ colors.bg_secondary }}d0;
        border: 1px solid {{ colors.border }};
        border-radius: 12px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 1000;
    }
    .scale-btn {
        background: {{ colors.bg_primary }};
        border: 1px solid {{ colors.border }};
        color: {{ colors.text_primary }};
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1em;
        transition: all 0.2s ease;
    }
    .scale-btn:hover {
        background: {{ colors.accent }};
        border-color: {{ colors.accent }};
        color: {{ colors.bg_primary }};
        transform: translateY(-1px);
    }
    .scale-btn:active {
        transform: translateY(0);
    }

    /* --- ENHANCED ANALYTICAL LEGEND --- */
    .legend {
        position: absolute;
        top: 20px;
        right: 20px;
        background: {{ colors.bg_secondary }}d0;
        border: 1px solid {{ colors.border }};
        border-radius: 12px;
        padding: 16px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 1000;
        width: 320px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
        transition: all 0.3s ease;
        font-family: 'Exo 2', sans-serif;
    }
    .legend-header {
        display: flex;
        align-items: center;
        gap: 10px;
        color: {{ colors.text_primary }};
        font-size: 1.1em;
        font-weight: 600;
        margin-bottom: 16px;
        font-family: 'Orbitron', sans-serif;
        letter-spacing: 0.5px;
    }
    .legend-header i {
        color: {{ colors.accent }};
        font-size: 1.2em;
    }
    .legend-section {
        background: {{ colors.bg_primary }}08;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
    }
    .legend-section-title {
        font-size: 0.85em;
        color: {{ colors.text_secondary }};
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        user-select: none;
        margin-bottom: 12px;
    }
    .legend-section-title i {
        color: {{ colors.accent }};
    }
    .legend-section-title:hover {
        color: {{ colors.text_primary }};
    }

    /* Metric Cards */
    .metric-card {
        background: {{ colors.bg_primary }}10;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        transition: all 0.2s ease;
    }
    .metric-card:hover {
        background: {{ colors.bg_primary }}15;
        transform: translateY(-2px);
    }
    .metric-value {
        font-size: 1.8em;
        font-weight: 700;
        color: {{ colors.text_primary }};
        font-family: 'Orbitron', sans-serif;
        line-height: 1;
        margin-bottom: 4px;
    }
    .metric-label {
        font-size: 0.7em;
        color: {{ colors.text_secondary }};
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    #metrics-section {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
    }

    /* Analysis Rows */
    .analysis-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: {{ colors.bg_primary }}08;
        margin-bottom: 8px;
    }
    .analysis-row:hover {
        background: {{ colors.bg_primary }}15;
        transform: translateX(4px);
    }
    .analysis-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: {{ colors.accent }}15;
        color: {{ colors.accent }};
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1em;
    }
    .analysis-content {
        flex: 1;
    }
    .analysis-title {
        font-weight: 600;
        color: {{ colors.text_primary }};
        font-size: 0.9em;
        margin-bottom: 2px;
    }
    .analysis-desc {
        font-size: 0.75em;
        color: {{ colors.text_secondary }};
    }
    .analysis-action {
        color: {{ colors.text_secondary }};
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    .analysis-row:hover .analysis-action {
        color: {{ colors.accent }};
        background: {{ colors.accent }}15;
    }

    /* Filter Chips */
    .filter-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .filter-chip {
        background: {{ colors.bg_primary }}10;
        border: 1px solid {{ colors.border }}40;
        color: {{ colors.text_secondary }};
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .filter-chip:hover {
        background: {{ colors.accent }}15;
        border-color: {{ colors.accent }}40;
        color: {{ colors.accent }};
        transform: translateY(-1px);
    }
    .filter-chip i {
        font-size: 0.9em;
    }

    .node {
        cursor: pointer;
    }
    .node-shape {
        transition: all 0.3s ease;
        stroke-width: 2px;
        stroke-dasharray: none;
        fill-opacity: 0.9;
    }
    .node-shape.module {
        stroke-dasharray: 3,2;
    }
    .node-shape.resource {
        filter: url(#resource-glow);
    }
    .node text {
        font-size: 10px;
        fill: {{ colors.text_primary }};
        text-shadow: 0 1px 3px {{ colors.bg_primary }},
        0 2px 6px rgba(0,0,0,0.3);
        pointer-events: none;
        font-weight: 500;
        transition: all 0.3s ease;
        letter-spacing: 0.02em;
    }
    .node-icon {
        font-family: "Font Awesome 6 Free";
        font-weight: 900;
        font-size: 10px;
        fill: {{ colors.bg_primary }};
        pointer-events: none;
        text-anchor: middle;
        dominant-baseline: central;
        text-rendering: optimizeLegibility;
    }
    .node text.node-icon {
        font-family: "Font Awesome 6 Free", sans-serif;
        font-weight: 900;
        fill: {{ colors.bg_primary }};
    }
    .node:hover .node-shape {
        stroke-width: 3px;
        filter: drop-shadow(0 0 8px currentColor);
    }
    .node:hover text {
        font-weight: 600;
    }

    @keyframes flowAnimation {
        to {
        stroke-dashoffset: -20;
        }
    }
    .link {
        stroke: {{ colors.text_secondary }}40;
        stroke-opacity: 0.4;
        stroke-width: 1.5;
        transition: all 0.3s ease;
        stroke-linecap: round;
    }
    .link.highlight {
        stroke: {{ colors.accent }};
        stroke-opacity: 0.8;
        stroke-width: 2;
        stroke-dasharray: 5, 8;
        animation: flowAnimation 1.5s linear infinite;
    }
    .link-arrow {
        fill: none;
        stroke: {{ colors.text_secondary }};
        stroke-width: 1.5;
        stroke-linecap: round;
        stroke-linejoin: round;
    }

    /* --- ENHANCED TOOLTIP - MULTI-THEME SUPPORT --- */
    .node-tooltip {
        position: fixed; /* Changed from absolute to fixed */
        background: linear-gradient(135deg, {{ colors.bg_secondary }}ee 0%, {{ colors.bg_tertiary }}dd 100%);
        border: 1px solid {{ colors.accent }}60;
        backdrop-filter: blur(12px) saturate(180%);
        box-shadow:
            0 0 25px {{ colors.accent }}20,
            0 8px 40px rgba(0,0,0,0.3),
            inset 0 1px 0 {{ colors.accent }}15;
        font-family: 'Exo 2', monospace;
        border-radius: 12px;
        padding: 16px;
        font-size: 0.85em;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        z-index: 1001;
        max-width: min(400px, 90vw); /* Responsive max width */
        transform: translateY(10px);
        max-height: 80vh; /* Maximum 80% of viewport height */
        overflow-y: hidden; /* Will be set to auto if needed */
    }

    .node-tooltip.show {
        opacity: 1;
        transform: translateY(0);
    }

    /* Scrollable tooltip for very long content */
    .node-tooltip.scrollable {
        overflow-y: auto;
        pointer-events: auto; /* Allow scrolling when tooltip is scrollable */
    }

    .node-tooltip.scrollable::-webkit-scrollbar {
        width: 6px;
    }

    .node-tooltip.scrollable::-webkit-scrollbar-track {
        background: {{ colors.bg_primary }}15;
        border-radius: 3px;
        margin: 4px 0;
    }

    .node-tooltip.scrollable::-webkit-scrollbar-thumb {
        background: {{ colors.accent }}30;
        border-radius: 3px;
        transition: background 0.2s ease;
    }

    .node-tooltip.scrollable::-webkit-scrollbar-thumb:hover {
        background: {{ colors.accent }}50;
    }

    .tooltip-stat-compact {
        display: flex;
        gap: 8px;
        margin-top: 8px;
    }

    .dep-item {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 8px;
        border-radius: 8px;
        flex: 1;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .dep-active {
        background: linear-gradient(135deg, {{ colors.bg_primary }}20, {{ colors.bg_secondary }}15);
        border-color: {{ colors.border }}30;
    }

    .dep-inactive {
        background: {{ colors.bg_primary }}10;
        border-color: {{ colors.border }}20;
        opacity: 0.6;
    }

    .dep-item i {
        width: 12px;
        text-align: center;
    }

    .dep-active i {
        color: {{ colors.accent }};
    }

    .dep-inactive i {
        color: {{ colors.text_secondary }};
    }

    .dep-label {
        font-size: 11px;
        font-weight: 600;
        color: {{ colors.text_secondary }};
        flex: 1;
    }

    .dep-count {
        font-size: 12px;
        font-weight: 700;
        padding: 2px 6px;
        border-radius: 6px;
        min-width: 20px;
        text-align: center;
        font-family: 'Exo 2', monospace;
    }

    .dep-count-active {
        background: {{ colors.accent }};
        color: {{ colors.bg_primary }};
        box-shadow: 0 2px 4px {{ colors.accent }}30;
    }

    .dep-inactive .dep-count {
        background: {{ colors.bg_primary }}40;
        color: {{ colors.text_secondary }};
    }

    /* Dependency status */
    .dep-status {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-top: 8px;
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        border: 1px solid;
    }

    .dep-isolated {
        background: {{ colors.warning }}15;
        border-color: {{ colors.warning }}30;
        color: {{ colors.warning }};
    }

    .dep-terminal {
        background: {{ colors.success }}15;
        border-color: {{ colors.success }}30;
        color: {{ colors.success }};
    }

    .dep-source {
        background: {{ colors.info }}15;
        border-color: {{ colors.info }}30;
        color: {{ colors.info }};
    }

    .dep-connected {
        background: {{ colors.accent }}15;
        border-color: {{ colors.accent }}30;
        color: {{ colors.accent }};
    }

    /* Badge count in label */

    .tov-badge {
        font-size: 10px;
        padding: 3px 6px;
        border-radius: 6px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 3px;
        border: 1px solid;
        font-family: 'Exo 2', sans-serif;
    }

    .dep-badge {
        color: #3b82f6;
        border-color: #3b82f640;
        background: #3b82f615;
    }

    .sensitive-badge {
        color: #f59e0b;
        border-color: #f59e0b40;
        background: #f59e0b15;
    }

    .count-badge {
        color: #8b5cf6;
        border-color: #8b5cf640;
        background: #8b5cf615;
    }

    .depth-badge {
        color: #06b6d4;
        border-color: #06b6d440;
        background: #06b6d415;
    }

    .tov-badge-count {
        background: {{ colors.accent }};
        color: {{ colors.bg_primary }};
        font-size: 10px;
        font-weight: 700;
        padding: 1px 6px;
        border-radius: 8px;
        margin-left: 6px;
        font-family: 'Exo 2', monospace;
    }

    /* Enhanced icon spacing in labels */
    .tooltip-label i {
        width: 14px;
        text-align: center;
        opacity: 0.8;
    }
        
    /* Hover effects */
    .dep-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .dep-active:hover {
        border-color: {{ colors.accent }}50;
    }

    /* Compact tooltip sections for better space usage */
    .tooltip-section {
        margin-top: 12px;
        padding-top: 12px;
    }

    .tooltip-section:first-child {
        margin-top: 0;
        padding-top: 0;
    }

    .node-info-title {
        font-weight: 700;
        color: {{ colors.accent }};
        margin-bottom: 8px;
        font-size: 1.1em;
        border-bottom: 1px solid {{ colors.accent }}30;
        padding-bottom: 6px;
        font-family: 'Orbitron', sans-serif;
        letter-spacing: 0.5px;
    }


    .tooltip-label {
        font-size: 0.75em;
        color: {{ colors.text_secondary }};
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .tooltip-stat {
        display: flex;
        justify-content: space-between;
        gap: 15px;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid {{ colors.border }}20;
        font-size: 0.9em;
    }

    .tooltip-stat span:first-child {
        color: {{ colors.text_secondary }};
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .tooltip-stat span:last-child {
        color: {{ colors.text_primary }};
        font-weight: 600;
        font-family: 'Exo 2', monospace;
    }

    .tooltip-value {
        font-size: 0.85em;
        color: {{ colors.text_primary }};
        font-family: 'Exo 2', monospace;
        line-height: 1.4;
    }

    /* Badge styles */
    .badge-incoming, .badge-outgoing, .badge-references {
        font-size: 0.85em;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: 600;
        font-family: 'Exo 2', sans-serif;
    }

    .badge-incoming {
        background: {{ colors.success }}20;
        color: {{ colors.success }};
    }

    .badge-outgoing {
        background: {{ colors.warning }}20;
        color: {{ colors.warning }};
    }

    .badge-references {
        background: {{ colors.info }}20;
        color: {{ colors.info }};
    }

    /* Source file styles */
    .source-file {
        font-family: 'Exo 2', monospace;
        font-size: 0.85em;
        color: {{ colors.accent }};
        cursor: pointer;
    }

    .source-line {
        font-family: monospace;
        background: {{ colors.bg_primary }}40;
        padding: 1px 4px;
        border-radius: 4px;
        color: {{ colors.text_primary }};
    }

    /* State-specific tooltip colors */
    .node-state.active { color: #22c55e; border-color: #22c55e40; background: #22c55e15; }
    .node-state.hub { color: #3b82f6; border-color: #3b82f640; background: #3b82f615; }
    .node-state.bridge { color: #06b6d4; border-color: #06b6d440; background: #06b6d415; }
    .node-state.aggregator { color: #8b5cf6; border-color: #8b5cf640; background: #8b5cf615; }
    .node-state.configuration { color: #6b7280; border-color: #6b728040; background: #6b728015; }
    .node-state.config_provider { color: #84cc16; border-color: #84cc1640; background: #84cc1615; }
    .node-state.config_consumer { color: #10b981; border-color: #10b98140; background: #10b98115; }
    .node-state.external { color: #a855f7; border-color: #a855f740; background: #a855f715; }
    .node-state.dependency { color: #3b82f6; border-color: #3b82f640; background: #3b82f615; }
    .node-state.derived { color: #06b6d4; border-color: #06b6d440; background: #06b6d415; }
    .node-state.leaf { color: #10b981; border-color: #10b98140; background: #10b98115; }
    .node-state.orphan { color: #f59e0b; border-color: #f59e0b40; background: #f59e0b15; }
    .node-state.unused { color: #6b7280; border-color: #6b728040; background: #6b728015; }
    .node-state.obsolete { color: #9ca3af; border-color: #9ca3af40; background: #9ca3af15; }
    .node-state.stale { color: #f59e0b; border-color: #f59e0b40; background: #f59e0b15; }
    .node-state.invalid { color: #ef4444; border-color: #ef444440; background: #ef444415; }
    .node-state.unresolved { color: #f87171; border-color: #f8717140; background: #f8717115; }
    .node-state.transient { color: #a78bfa; border-color: #a78bfa40; background: #a78bfa15; }
    .node-state.ephemeral { color: #c4b5fd; border-color: #c4b5fd40; background: #c4b5fd15; }
    .node-state.shared { color: #06b6d4; border-color: #06b6d440; background: #06b6d415; }
    .node-state.unknown { color: #9ca3af; border-color: #9ca3af40; background: #9ca3af15; }

    /* Responsive design */
    @media (max-width: 768px) {
        .node-tooltip {
            max-width: 280px;
            font-size: 0.8em;
            padding: 12px;
        }
    }

    .terraform-object-viewer {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 10000;
        display: none;
        font-family: 'Exo 2', monospace;
        pointer-events: none;
    }

    .terraform-object-viewer.tov-visible {
        display: block;
        pointer-events: auto;
    }

    .tov-tooltip {
        position: absolute;
        background: linear-gradient(135deg, {{ colors.bg_secondary }} 0%, {{ colors.bg_tertiary }} 100%);
        border: 1.5px solid {{ colors.accent }}80;
        backdrop-filter: blur(16px) saturate(200%);
        box-shadow:
            0 0 35px {{ colors.accent }}30,
            0 12px 60px rgba(0,0,0,0.4),
            inset 0 1px 0 {{ colors.accent }}20,
            inset 0 -1px 0 {{ colors.border }}20;
        border-radius: 16px;
        max-width: 480px;
        min-width: 380px;
        overflow: hidden;
        transform: scale(0.92);
        opacity: 0;
        transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .terraform-object-viewer.tov-visible .tov-tooltip {
        transform: scale(1);
        opacity: 1;
    }

    .tov-header {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 12px;
        border-bottom: 1px solid {{ colors.border }}30;
        background: {{ colors.bg_primary }}20;
    }

    .tov-icon {
        font-size: 16px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .tov-title-group {
        flex: 1;
        min-width: 0;
    }

    .tov-subtitle {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 10px
    }

    /* Title truncation */
    .tov-title {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }

    .tov-content {
        padding: 12px;
        max-height: 500px;
        overflow-y: auto;
    }

    .tov-content::-webkit-scrollbar {
        width: 4px;
    }

    .tov-content::-webkit-scrollbar-track {
        background: {{ colors.bg_primary }}15;
        border-radius: 2px;
    }

    .tov-content::-webkit-scrollbar-thumb {
        background: {{ colors.accent }}30;
        border-radius: 2px;
    }

    .tov-footer {
        padding: 8px 12px;
        border-top: 1px solid {{ colors.border }}30;
        background: {{ colors.bg_primary }}20;
    }

    .tov-actions {
        display: flex;
        gap: 6px;
        justify-content: flex-end;
    }

    .tov-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border: 1px solid {{ colors.text_secondary }}40;
        border-radius: 6px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: transparent;
        color: {{ colors.text_secondary }};
    }

    .tov-btn:hover {
        background: {{ colors.accent }};
        border-color: {{ colors.accent }};
        color: {{ colors.bg_primary }};
        transform: translateY(-1px);
    }

    /* Use your existing tooltip styles */
    .tooltip-section {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid {{ colors.border }}30;
    }

    .tooltip-section:first-child {
        margin-top: 0;
        padding-top: 0;
        border-top: none;
    }

    .tooltip-label {
        font-size: 11px;
        color: {{ colors.text_secondary }};
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .tooltip-stat {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid {{ colors.border }}20;
        font-size: 12px;
    }

    .tooltip-stat:first-child {
        margin-top: 0;
        padding-top: 0;
        border-top: none;
    }

    .tooltip-stat span:first-child {
        color: {{ colors.text_secondary }};
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 4px;
        white-space: nowrap;
    }

    .tooltip-stat span:last-child {
        color: {{ colors.text_primary }};
        font-weight: 600;
        font-family: 'Exo 2', monospace;
        text-align: right;
        word-break: break-word;
    }

    .tov-code {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        background: linear-gradient(135deg, {{ colors.bg_primary }}50, {{ colors.bg_secondary }}30);
        padding: 3px 8px;
        border-radius: 6px;
        font-size: 12px;
        color: {{ colors.text_primary }};
        border: 1px solid {{ colors.border }}30;
        font-weight: 600;
    }


    /* Use your existing badge and state styles */
    .badge-incoming, .badge-outgoing {
        font-size: 10px;
        padding: 1px 6px;
        border-radius: 8px;
        font-weight: 600;
        font-family: 'Exo 2', sans-serif;
    }

    .badge-incoming {
        background: {{ colors.success }}20;
        color: {{ colors.success }};
    }

    .badge-outgoing {
        background: {{ colors.warning }}20;
        color: {{ colors.warning }};
    }

    .source-file {
        font-family: 'Exo 2', monospace;
        font-size: 10px;
        color: {{ colors.accent }};
    }

    .source-line {
        font-family: monospace;
        background: {{ colors.bg_primary }}40;
        padding: 1px 4px;
        border-radius: 3px;
        color: {{ colors.text_primary }};
        font-size: 10px;
    }

    .node-state {
        font-size: 11px;
        padding: 5px 10px;
        border-radius: 8px;
        display: inline-block;
        font-weight: 700;
        border: 1.5px solid;
        background: {{ colors.bg_primary }}30;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .tov-type {
        font-size: 11px;
        padding: 5px 10px;
        border-radius: 8px;
        display: inline-block;
        font-weight: 700;
        border: 1.5px solid;
        background: {{ colors.bg_primary }}30;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Terraform Object Type Color Definitions */
    .tov-type.terraform { color: #7c3aed; border-color: #7c3aed60; background: #7c3aed20; }
    .tov-type.provider { color: #06b6d4; border-color: #06b6d460; background: #06b6d420; }
    .tov-type.variable { color: #f59e0b; border-color: #f59e0b60; background: #f59e0b20; }
    .tov-type.local { color: #10b981; border-color: #10b98160; background: #10b98120; }
    .tov-type.module { color: #8b5cf6; border-color: #8b5cf660; background: #8b5cf620; }
    .tov-type.data { color: #3b82f6; border-color: #3b82f660; background: #3b82f620; }
    .tov-type.resource { color: #ef4444; border-color: #ef444460; background: #ef444420; }
    .tov-type.output { color: #84cc16; border-color: #84cc1660; background: #84cc1620; }
    .tov-type.input { color: #f97316; border-color: #f9731660; background: #f9731620; }
    .tov-type.import { color: #a855f7; border-color: #a855f760; background: #a855f720; }
    .tov-type.check { color: #ec4899; border-color: #ec489960; background: #ec489920; }
    .tov-type.assertion { color: #d946ef; border-color: #d946ef60; background: #d946ef20; }

    /* Provider-specific types */
    .tov-type.aws { color: #ff9900; border-color: #ff990060; background: #ff990020; }
    .tov-type.azure { color: #0078d4; border-color: #0078d460; background: #0078d420; }
    .tov-type.google { color: #4285f4; border-color: #4285f460; background: #4285f420; }
    .tov-type.kubernetes { color: #326ce5; border-color: #326ce560; background: #326ce520; }
    .tov-type.docker { color: #2496ed; border-color: #2496ed60; background: #2496ed20; }
    .tov-type.null { color: #6b7280; border-color: #6b728060; background: #6b728020; }
    .tov-type.random { color: #8b5cf6; border-color: #8b5cf660; background: #8b5cf620; }
    .tov-type.tls { color: #10b981; border-color: #10b98160; background: #10b98120; }
    .tov-type.time { color: #f59e0b; border-color: #f59e0b60; background: #f59e0b20; }

    /* Resource category types */
    .tov-type.compute { color: #ef4444; border-color: #ef444460; background: #ef444420; }
    .tov-type.storage { color: #3b82f6; border-color: #3b82f660; background: #3b82f620; }
    .tov-type.network { color: #8b5cf6; border-color: #8b5cf660; background: #8b5cf620; }
    .tov-type.database { color: #10b981; border-color: #10b98160; background: #10b98120; }
    .tov-type.security { color: #f59e0b; border-color: #f59e0b60; background: #f59e0b20; }
    .tov-type.iam { color: #ec4899; border-color: #ec489960; background: #ec489920; }
    .tov-type.monitoring { color: #06b6d4; border-color: #06b6d460; background: #06b6d420; }
    .tov-type.container { color: #84cc16; border-color: #84cc1660; background: #84cc1620; }

    /* Special types */
    .tov-type.root { color: #7c3aed; border-color: #7c3aed60; background: #7c3aed20; }
    .tov-type.child { color: #06b6d4; border-color: #06b6d460; background: #06b6d420; }
    .tov-type.nested { color: #8b5cf6; border-color: #8b5cf660; background: #8b5cf620; }
    .tov-type.external { color: #f59e0b; border-color: #f59e0b60; background: #f59e0b20; }
    .tov-type.deprecated { color: #6b7280; border-color: #6b728060; background: #6b728020; }
    .tov-type.experimental { color: #ec4899; border-color: #ec489960; background: #ec489920; }

    /* Your existing state color definitions (updated to match new styling) */
    .node-state.active { color: #22c55e; border-color: #22c55e60; background: #22c55e20; }
    .node-state.hub { color: #3b82f6; border-color: #3b82f660; background: #3b82f620; }
    .node-state.bridge { color: #06b6d4; border-color: #06b6d460; background: #06b6d420; }
    .node-state.aggregator { color: #8b5cf6; border-color: #8b5cf660; background: #8b5cf620; }
    .node-state.configuration { color: #6b7280; border-color: #6b728060; background: #6b728020; }
    .node-state.config_provider { color: #84cc16; border-color: #84cc1660; background: #84cc1620; }
    .node-state.config_consumer { color: #10b981; border-color: #10b98160; background: #10b98120; }
    .node-state.external { color: #a855f7; border-color: #a855f760; background: #a855f720; }
    .node-state.dependency { color: #3b82f6; border-color: #3b82f660; background: #3b82f620; }
    .node-state.derived { color: #06b6d4; border-color: #06b6d460; background: #06b6d420; }
    .node-state.leaf { color: #10b981; border-color: #10b98160; background: #10b98120; }
    .node-state.orphan { color: #f59e0b; border-color: #f59e0b60; background: #f59e0b20; }
    .node-state.unused { color: #6b7280; border-color: #6b728060; background: #6b728020; }
    .node-state.obsolete { color: #9ca3af; border-color: #9ca3af60; background: #9ca3af20; }
    .node-state.stale { color: #f59e0b; border-color: #f59e0b60; background: #f59e0b20; }
    .node-state.invalid { color: #ef4444; border-color: #ef444460; background: #ef444420; }
    .node-state.unresolved { color: #f87171; border-color: #f8717160; background: #f8717120; }
    .node-state.transient { color: #a78bfa; border-color: #a78bfa60; background: #a78bfa20; }
    .node-state.ephemeral { color: #c4b5fd; border-color: #c4b5fd60; background: #c4b5fd20; }
    .node-state.shared { color: #06b6d4; border-color: #06b6d460; background: #06b6d420; }
    .node-state.unknown { color: #9ca3af; border-color: #9ca3af60; background: #9ca3af20; }

    .node-state:hover, .tov-type:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transition: all 0.2s ease;
    }

    /* Compact version for tight spaces */
    .tov-type.compact, .node-state.compact {
        font-size: 9px;
        padding: 3px 6px;
        border-radius: 6px;
        letter-spacing: 0.3px;
    }

    /* Large version for emphasis */
    .tov-type.large, .node-state.large {
        font-size: 13px;
        padding: 6px 12px;
        border-radius: 10px;
        letter-spacing: 0.8px;
    }

    /* Performance optimizations */
    .performance-optimized {
        transform: translate3d(0, 0, 0);
        backface-visibility: hidden;
        perspective: 1000px;
    }

    /* Custom scrollbar */
    .config-content::-webkit-scrollbar,
    .config-file-body::-webkit-scrollbar,
    .command-list::-webkit-scrollbar {
        width: 6px;
    }
    .config-content::-webkit-scrollbar-track,
    .config-file-body::-webkit-scrollbar-track,
    .command-list::-webkit-scrollbar-track {
        background: {{ colors.bg_primary }}15;
        border-radius: 3px;
    }
    .config-content::-webkit-scrollbar-thumb,
    .config-file-body::-webkit-scrollbar-thumb,
    .command-list::-webkit-scrollbar-thumb {
        background: {{ colors.accent }}30;
        border-radius: 3px;
        transition: background 0.2s ease;
    }
    .config-content::-webkit-scrollbar-thumb:hover,
    .config-file-body::-webkit-scrollbar-thumb:hover,
    .command-list::-webkit-scrollbar-thumb:hover {
        background: {{ colors.accent }}50;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .dashboard-hud, .legend, .config-viewer {
        min-width: 200px;
        padding: 16px;
        }
        .config-viewer {
        left: 20px;
        top: auto;
        bottom: 100px;
        width: calc(100% - 40px);
        max-width: 420px;
        }
        .controls {
        flex-wrap: wrap;
        justify-content: center;
        }
        .node-tooltip {
        max-width: 280px;
        font-size: 0.8em;
        padding: 12px;
        }
        .watermark-content {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        }
        .watermark-links {
        flex-direction: column;
        gap: 8px;
        width: 100%;
        }
        .watermark-link {
        justify-content: center;
        padding: 8px 12px;
        }
        #watermark {
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 40px);
        max-width: 300px;
        }
    }
    </style>
    <!-- prettier-ignore-end -->
</head>

<body>
    <!-- Backdrop -->
    <div class="backdrop" id="backdrop"></div>
    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>
    <!-- Command Palette -->
    <div class="command-palette" id="commandPalette">
        <div class="command-header">
            <i class="fas fa-search"></i>
            <input type="text" class="command-input" id="commandInput" placeholder="Search commands..." />
            <div class="command-shortcut">ESC</div>
        </div>
        <div class="command-list" id="commandList">
            <!-- Commands will be populated dynamically -->
        </div>
    </div>
    <div id="graph-container"></div>
    <!-- Quick Actions Bar -->
    <div class="quick-actions" id="quickActions">
        <div class="quick-action" data-action="command">
            <i class="fas fa-terminal"></i>
            <span>Command</span>
        </div>
        <div class="quick-action" data-action="center">
            <i class="fas fa-bullseye"></i>
            <span>Center</span>
        </div>
        <div class="quick-action" data-action="physics">
            <i class="fas fa-bolt"></i>
            <span>Physics</span>
        </div>
        <div class="quick-action" data-action="fullscreen">
            <i class="fas fa-expand"></i>
            <span>Fullscreen</span>
        </div>
        <div class="quick-action" data-action="help">
            <i class="fas fa-question-circle"></i>
            <span>Help</span>
        </div>
    </div>
    <div id="watermark">
        <div class="watermark-content">
            <div class="watermark-brand">
                <i class="fas fa-cube"></i>
                <span class="brand-text">tfkit</span>
                <span class="version">v{{ version | default('0.0.0') }}</span>
            </div>
            <div class="watermark-links">
                <a href="https://tfkit.netlify.app" target="_blank" class="watermark-link">
                    <i class="fas fa-globe"></i>
                    <span>tfkit</span>
                </a>
                <a href="https://github.com/ivasik-k7/tfkit" target="_blank" class="watermark-link">
                    <i class="fab fa-github"></i>
                    <span>ivasik-k7/tfkit</span>
                </a>
            </div>
        </div>
    </div>
    <div class="dashboard-hud">
        <div class="info-grid">
            <div class="info-card">
                <div class="info-value" id="node-count">0</div>
                <div class="info-label">Nodes</div>
            </div>
            <div class="info-card">
                <div class="info-value" id="edge-count">0</div>
                <div class="info-label">Links</div>
            </div>
            <div class="info-card">
                <div class="info-value" id="component-count">0</div>
                <div class="info-label">Groups</div>
            </div>
        </div>

        <div class="state-section">
            <div class="state-title">
                <i class="fas fa-diagram-project"></i>
                Infrastructure States
            </div>
            <div class="state-flow" id="state-indicators">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <div class="legend">
        <!-- Dependency Metrics -->
        <div class="legend-section">
            <div class="legend-section-title" onclick="toggleLegendSection('metrics')">
                <i class="fas fa-chart-line"></i> Dependency Metrics
                <i class="fas fa-chevron-down" id="metrics-chevron"></i>
            </div>
            <div class="legend-section-content" id="metrics-section">
                <div class="metric-card">
                    <div class="metric-value" id="avg-dependencies">0</div>
                    <div class="metric-label">Avg. Dependencies</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="max-depth">0</div>
                    <div class="metric-label">Max Depth</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="complexity-score">0</div>
                    <div class="metric-label">Complexity</div>
                </div>
            </div>
        </div>

        <!-- Risk Analysis -->
        <div class="legend-section">
            <div class="legend-section-title" onclick="toggleLegendSection('risk')">
                <i class="fas fa-shield-alt"></i> Risk Analysis
                <i class="fas fa-chevron-down" id="risk-chevron"></i>
            </div>
            <div class="legend-section-content" id="risk-section">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Resource Analysis -->
        <div class="legend-section">
            <div class="legend-section-title" onclick="toggleLegendSection('analysis')">
                <i class="fas fa-microscope"></i> Resource Analysis
                <i class="fas fa-chevron-down" id="analysis-chevron"></i>
            </div>
            <div class="legend-section-content" id="analysis-section">
                <div class="analysis-row">
                    <div class="analysis-icon">
                        <i class="fas fa-route"></i>
                    </div>
                    <div class="analysis-content">
                        <div class="analysis-title">Critical Path</div>
                        <div class="analysis-desc" id="critical-path-desc">Not available</div>
                    </div>
                </div>
                <div class="analysis-row">
                    <div class="analysis-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="analysis-content">
                        <div class="analysis-title">Central Nodes</div>
                        <div class="analysis-desc" id="central-nodes-desc">Not available</div>
                    </div>
                </div>
                <div class="analysis-row" onclick="highlightBottleneckNodes()">
                    <div class="analysis-icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="analysis-content">
                        <div class="analysis-title">Bottlenecks</div>
                        <div class="analysis-desc" id="bottleneck-desc">Not available</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="config-viewer" id="configViewer">
        <div class="config-header" onclick="toggleConfigViewer()">
            <div class="config-icon-wrapper">
                <i class="fas fa-cog fa-spin-slow"></i>
            </div>
            <div class="config-header-content">
                <div class="config-title">Configuration</div>
                <div class="config-subtitle">
                    <span id="configCount">0</span> files
                </div>
            </div>
            <div class="config-toggle">
                <i class="fas fa-chevron-down config-chevron" id="configChevron"></i>
            </div>
        </div>
        <div class="config-content" id="configContent">
            <!-- Config files will be populated here -->
        </div>
    </div>

    <div class="controls">
        <button class="control-btn" onclick="resetView()">
            <i class="fas fa-crosshairs"></i> Reset
        </button>
        <button class="control-btn" onclick="togglePhysics()" id="physics-btn">
            <i class="fas fa-bolt"></i> Physics
        </button>
        <button class="control-btn" onclick="centerGraph()">
            <i class="fas fa-bullseye"></i> Center
        </button>
        <button class="control-btn" onclick="toggleAnimations()" id="animations-btn">
            <i class="fas fa-sparkles"></i> Animations
        </button>
        <button class="control-btn">
            <i class="fas fa-filter"></i> Clear Filters
        </button>
    </div>
    <div class="scale-controls">
        <button class="scale-btn" onclick="zoomIn()">
            <i class="fas fa-search-plus"></i>
        </button>
        <button class="scale-btn" onclick="zoomOut()">
            <i class="fas fa-search-minus"></i>
        </button>
    </div>
    <div class="node-tooltip" id="node-tooltip"></div>
    <script>
        class GraphManager {
            constructor(rawDataset, colors) {
                this.rawDataset = rawDataset;
                this.colors = colors;
                this.graphData = this.processGraphData();

                this.simulation = null;
                this.graphG = null;
                this.animationTimer = null;
                this.physicsEnabled = true;
                this.animationsEnabled = true;
                this.currentTransform = d3.zoomIdentity;
                this.highlightedNodes = new Set();
                this.highlightedEdges = new Set();
                this.renderThrottled = false;

                // Build node graph structures
                const { nodeMap, adjacencyList } = this.buildNodeGraph();
                this.nodeMap = nodeMap;
                this.adjacencyList = adjacencyList;

                this.config = this.getDefaultConfig();
                this.nodeConfig = this.getNodeConfigMap();
                this.stateConfig = this.getStateConfigMap();

                // Global references last
                this.zoom = null;
                this.svg = null;
                this.width = null;
                this.height = null;
            }

            processGraphData() {
                return {
                    nodes: (this.rawDataset?.nodes || []).map((node) => {
                        const data = node.data || {};
                        return {
                            id: node.id || "",
                            label: node.name || node.id || "Unknown",
                            type: node.type || "resource",
                            subtype: data.resource_type || null,
                            state: data.state || "unknown",
                            state_reason: null,
                            dependencies_out: data.dependency_count || 0,
                            dependencies_in: data.reference_count || 0,
                            details: {
                                provider: data.provider,
                                module_path: data.module_path,
                                source_file: data.source_file,
                                line_number: data.line_number,
                                depends_on: data.depends_on || [],
                                count: data.count,
                                for_each: data.for_each,
                                lifecycle_rules: data.lifecycle_rules,
                                tags: data.tags || {},
                                attributes: data.attributes || {},
                                resource_type: data.resource_type,
                            },
                            group: node.group || `type:${node.type}`,
                            weight: node.weight || 1.0,
                            visibility: node.visibility !== false,
                        };
                    }),
                    edges: (this.rawDataset?.links || []).map((link) => ({
                        source: link.source || "",
                        target: link.target || "",
                        type: link.link_type || "implicit",
                        strength: link.strength || 0.5,
                        reference_path: link.reference_path || [],
                    })),
                };
            }

            buildNodeGraph() {
                const nodeMap = new Map();
                const adjacencyList = new Map();

                this.graphData.nodes.forEach((node) => {
                    if (node && node.id) {
                        nodeMap.set(node.id, node);
                        adjacencyList.set(node.id, { in: [], out: [] });
                    }
                });

                this.graphData.edges.forEach((edge) => {
                    if (!edge || !edge.source || !edge.target) return;

                    const sourceId =
                        typeof edge.source === "object" ? edge.source.id : edge.source;
                    const targetId =
                        typeof edge.target === "object" ? edge.target.id : edge.target;

                    if (adjacencyList.has(sourceId)) {
                        adjacencyList.get(sourceId).out.push(targetId);
                    }
                    if (adjacencyList.has(targetId)) {
                        adjacencyList.get(targetId).in.push(sourceId);
                    }
                });

                return { nodeMap, adjacencyList };
            }

            getDefaultConfig() {
                return {
                    zoomSpeed: 0.2,
                    physics: {
                        charge: {
                            active: -380,
                            unused: -150,
                            external: -250,
                            orphan: -100,
                            leaf: -200,
                            hub: -400,
                            configuration: -180,
                            dependency: -300,
                            invalid: -100,
                            transient: -200,
                            ephemeral: -150,
                            shared: -350,
                            aggregator: -360,
                            bridge: -320,
                            derived: -280,
                            config_consumer: -250,
                            config_provider: -220,
                            obsolete: -80,
                            stale: -120,
                            unresolved: -150,
                            unknown: -100,
                        },
                        link: {
                            active: 115,
                            unused: 60,
                            external: 140,
                            orphan: 80,
                            leaf: 80,
                            hub: 150,
                            configuration: 70,
                            dependency: 100,
                            invalid: 50,
                            transient: 90,
                            ephemeral: 70,
                            shared: 120,
                            aggregator: 110,
                            bridge: 100,
                            derived: 95,
                            config_consumer: 90,
                            config_provider: 85,
                            obsolete: 40,
                            stale: 50,
                            unresolved: 60,
                            unknown: 50,
                        },
                        collision: {
                            base: 8,
                            module: 12,
                            resource: 10,
                            multiplier: 0.8,
                        },
                        force: {
                            center: 0.1,
                            unusedAttraction: 0.05,
                            stateGrouping: 0.02,
                        },
                    },
                    animation: {
                        particleInterval: 50,
                        transitionDuration: 300,
                        hoverGlow: true,
                    },
                    performance: {
                        debounceDelay: 50,
                        maxParticles: 100,
                        throttleRender: true,
                    },
                };
            }

            getNodeConfigMap() {
                return {
                    // Core Terraform types
                    resource: { icon: "fas fa-cube", color: "#3b82f6", size: "medium" },
                    module: { icon: "fas fa-cubes", color: "#8b5cf6", size: "large" },
                    variable: { icon: "fas fa-code", color: "#10b981", size: "small" },
                    output: { icon: "fas fa-arrow-right", color: "#f59e0b", size: "small" },
                    data: { icon: "fas fa-database", color: "#06b6d4", size: "medium" },
                    provider: { icon: "fas fa-cog", color: "#6b7280", size: "medium" },
                    local: { icon: "fas fa-terminal", color: "#84cc16", size: "small" },
                    terraform: { icon: "fas fa-sitemap", color: "#8b5cf6", size: "medium" },

                    // Major Cloud Providers
                    aws: { icon: "fab fa-aws", color: "#ff9900", size: "medium" },
                    google: { icon: "fab fa-google", color: "#4285f4", size: "medium" },
                    azure: { icon: "fab fa-microsoft", color: "#0078d4", size: "medium" },
                    azurerm: { icon: "fab fa-microsoft", color: "#0078d4", size: "medium" },
                    kubernetes: {
                        icon: "fas fa-dharmachakra",
                        color: "#326ce5",
                        size: "medium",
                    },
                    docker: { icon: "fab fa-docker", color: "#2496ed", size: "medium" },
                    github: { icon: "fab fa-github", color: "#24292e", size: "medium" },

                    // Utility Providers
                    random: { icon: "fas fa-dice", color: "#f59e0b", size: "medium" },
                    null: { icon: "fas fa-ban", color: "#6b7280", size: "medium" },
                    vault: { icon: "fas fa-lock", color: "#000000", size: "medium" },
                    consul: {
                        icon: "fas fa-network-wired",
                        color: "#ca2171",
                        size: "medium",
                    },

                    // AWS Resources - Compute
                    aws_instance: { icon: "fas fa-server", color: "#ff9900", size: "medium" },
                    aws_lambda_function: {
                        icon: "fas fa-bolt",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_ecs_cluster: {
                        icon: "fas fa-cubes",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_ecs_service: {
                        icon: "fas fa-cogs",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_autoscaling_group: {
                        icon: "fas fa-expand-arrows-alt",
                        color: "#ff9900",
                        size: "medium",
                    },

                    // AWS Resources - Networking
                    aws_vpc: {
                        icon: "fas fa-network-wired",
                        color: "#ff9900",
                        size: "large",
                    },
                    aws_subnet: { icon: "fas fa-sitemap", color: "#ff9900", size: "medium" },
                    aws_security_group: {
                        icon: "fas fa-shield-alt",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_internet_gateway: {
                        icon: "fas fa-globe",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_nat_gateway: {
                        icon: "fas fa-exchange-alt",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_route_table: {
                        icon: "fas fa-route",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_lb: {
                        icon: "fas fa-balance-scale",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_elb: {
                        icon: "fas fa-balance-scale",
                        color: "#ff9900",
                        size: "medium",
                    },

                    // AWS Resources - Storage
                    aws_s3_bucket: {
                        icon: "fas fa-archive",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_ebs_volume: { icon: "fas fa-hdd", color: "#ff9900", size: "medium" },
                    aws_efs_file_system: {
                        icon: "fas fa-folder",
                        color: "#ff9900",
                        size: "medium",
                    },

                    // AWS Resources - Database
                    aws_db_instance: {
                        icon: "fas fa-database",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_dynamodb_table: {
                        icon: "fas fa-table",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_elasticache_cluster: {
                        icon: "fas fa-memory",
                        color: "#ff9900",
                        size: "medium",
                    },

                    // AWS Resources - IAM & Security
                    aws_iam_role: {
                        icon: "fas fa-user-lock",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_iam_policy: {
                        icon: "fas fa-file-alt",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_iam_user: { icon: "fas fa-user", color: "#ff9900", size: "medium" },
                    aws_iam_group: { icon: "fas fa-users", color: "#ff9900", size: "medium" },
                    aws_kms_key: { icon: "fas fa-key", color: "#ff9900", size: "medium" },

                    // AWS Resources - Monitoring
                    aws_cloudwatch_log_group: {
                        icon: "fas fa-scroll",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_cloudwatch_metric_alarm: {
                        icon: "fas fa-chart-line",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_sns_topic: { icon: "fas fa-bell", color: "#ff9900", size: "medium" },
                    aws_sqs_queue: { icon: "fas fa-inbox", color: "#ff9900", size: "medium" },

                    // AWS Data Sources
                    aws_availability_zones: {
                        icon: "fas fa-map-marker-alt",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_caller_identity: {
                        icon: "fas fa-id-card",
                        color: "#ff9900",
                        size: "medium",
                    },
                    aws_region: { icon: "fas fa-map", color: "#ff9900", size: "medium" },
                    aws_ami: {
                        icon: "fas fa-compact-disc",
                        color: "#ff9900",
                        size: "medium",
                    },

                    // Google Cloud Resources
                    google_compute_instance: {
                        icon: "fas fa-server",
                        color: "#4285f4",
                        size: "medium",
                    },
                    google_storage_bucket: {
                        icon: "fas fa-archive",
                        color: "#4285f4",
                        size: "medium",
                    },
                    google_sql_database_instance: {
                        icon: "fas fa-database",
                        color: "#4285f4",
                        size: "medium",
                    },

                    // Azure Resources
                    azurerm_virtual_machine: {
                        icon: "fas fa-server",
                        color: "#0078d4",
                        size: "medium",
                    },
                    azurerm_storage_account: {
                        icon: "fas fa-archive",
                        color: "#0078d4",
                        size: "medium",
                    },

                    // Kubernetes Resources
                    kubernetes_pod: { icon: "fas fa-box", color: "#326ce5", size: "medium" },
                    kubernetes_deployment: {
                        icon: "fas fa-layer-group",
                        color: "#326ce5",
                        size: "medium",
                    },
                    kubernetes_service: {
                        icon: "fas fa-plug",
                        color: "#326ce5",
                        size: "medium",
                    },
                    kubernetes_namespace: {
                        icon: "fas fa-folder",
                        color: "#326ce5",
                        size: "medium",
                    },

                    // Random Resources
                    random_pet: { icon: "fas fa-paw", color: "#f59e0b", size: "medium" },
                    random_password: { icon: "fas fa-key", color: "#f59e0b", size: "medium" },
                    random_string: { icon: "fas fa-font", color: "#f59e0b", size: "medium" },
                    random_id: {
                        icon: "fas fa-fingerprint",
                        color: "#f59e0b",
                        size: "medium",
                    },

                    // Null Resources
                    null_resource: { icon: "fas fa-cogs", color: "#6b7280", size: "medium" },
                };
            }

            getStateConfigMap() {
                return {
                    // Active/Healthy States
                    active: {
                        icon: "fas fa-check-circle",
                        color: "#22c55e",
                        stroke: "#22c55e",
                        opacity: 1.0,
                        badge: "success",
                        glow: "rgba(34, 197, 94, 0.4)",
                    },
                    hub: {
                        icon: "fas fa-star",
                        color: "#3b82f6",
                        stroke: "#3b82f6",
                        opacity: 1.0,
                        badge: "info",
                        glow: "rgba(59, 130, 246, 0.4)",
                    },
                    bridge: {
                        icon: "fas fa-link",
                        color: "#06b6d4",
                        stroke: "#06b6d4",
                        opacity: 1.0,
                        badge: "info",
                        glow: "rgba(6, 182, 212, 0.4)",
                    },
                    aggregator: {
                        icon: "fas fa-layer-group",
                        color: "#8b5cf6",
                        stroke: "#8b5cf6",
                        opacity: 1.0,
                        badge: "info",
                        glow: "rgba(139, 92, 246, 0.4)",
                    },

                    // Configuration States
                    configuration: {
                        icon: "fas fa-cog",
                        color: "#6b7280",
                        stroke: "#6b7280",
                        opacity: 0.9,
                        badge: "neutral",
                        glow: "rgba(107, 114, 128, 0.3)",
                    },
                    config_provider: {
                        icon: "fas fa-file-export",
                        color: "#84cc16",
                        stroke: "#84cc16",
                        opacity: 0.9,
                        badge: "success",
                        glow: "rgba(132, 204, 22, 0.3)",
                    },
                    config_consumer: {
                        icon: "fas fa-file-import",
                        color: "#10b981",
                        stroke: "#10b981",
                        opacity: 0.9,
                        badge: "success",
                        glow: "rgba(16, 185, 129, 0.3)",
                    },

                    // Data Flow States
                    external: {
                        icon: "fas fa-cloud-download-alt",
                        color: "#a855f7",
                        stroke: "#a855f7",
                        opacity: 0.9,
                        badge: "info",
                        glow: "rgba(168, 85, 247, 0.3)",
                    },
                    dependency: {
                        icon: "fas fa-project-diagram",
                        color: "#3b82f6",
                        stroke: "#3b82f6",
                        opacity: 0.9,
                        badge: "info",
                        glow: "rgba(59, 130, 246, 0.3)",
                    },
                    derived: {
                        icon: "fas fa-code-branch",
                        color: "#06b6d4",
                        stroke: "#06b6d4",
                        opacity: 0.85,
                        badge: "info",
                        glow: "rgba(6, 182, 212, 0.3)",
                    },

                    // Terminal States
                    leaf: {
                        icon: "fas fa-leaf",
                        color: "#10b981",
                        stroke: "#10b981",
                        opacity: 0.85,
                        badge: "success",
                        glow: "rgba(16, 185, 129, 0.3)",
                    },

                    // Warning States
                    orphan: {
                        icon: "fas fa-unlink",
                        color: "#f59f0b",
                        stroke: "#f59f0b",
                        opacity: 0.75,
                        badge: "warning",
                        glow: "rgba(245, 159, 11, 0)",
                    },
                    unused: {
                        icon: "fas fa-eye-slash",
                        color: "#6b7280",
                        stroke: "#6b7280",
                        opacity: 0.6,
                        badge: "neutral",
                        glow: "rgba(107, 114, 128, 0.2)",
                    },
                    obsolete: {
                        icon: "fas fa-archive",
                        color: "#9ca3af",
                        stroke: "#9ca3af",
                        opacity: 0.5,
                        badge: "neutral",
                        glow: "rgba(156, 163, 175, 0.2)",
                    },
                    stale: {
                        icon: "fas fa-clock",
                        color: "#f59e0b",
                        stroke: "#f59e0b",
                        opacity: 0.65,
                        badge: "warning",
                        glow: "rgba(245, 158, 11, 0.3)",
                    },

                    // Error States
                    invalid: {
                        icon: "fas fa-exclamation-circle",
                        color: "#ef4444",
                        stroke: "#ef4444",
                        opacity: 0.8,
                        badge: "error",
                        glow: "rgba(239, 68, 68, 0.4)",
                    },
                    unresolved: {
                        icon: "fas fa-question-circle",
                        color: "#f87171",
                        stroke: "#f87171",
                        opacity: 0.75,
                        badge: "error",
                        glow: "rgba(248, 113, 113, 0.3)",
                    },

                    // Temporary States
                    transient: {
                        icon: "fas fa-exchange-alt",
                        color: "#a78bfa",
                        stroke: "#a78bfa",
                        opacity: 0.7,
                        badge: "info",
                        glow: "rgba(167, 139, 250, 0.3)",
                    },
                    ephemeral: {
                        icon: "fas fa-ghost",
                        color: "#c4b5fd",
                        stroke: "#c4b5fd",
                        opacity: 0.6,
                        badge: "info",
                        glow: "rgba(196, 181, 253, 0.3)",
                    },

                    // Special States
                    shared: {
                        icon: "fas fa-share-alt",
                        color: "#06b6d4",
                        stroke: "#06b6d4",
                        opacity: 0.9,
                        badge: "info",
                        glow: "rgba(6, 182, 212, 0.3)",
                    },
                    unknown: {
                        icon: "fas fa-question",
                        color: "#9ca3af",
                        stroke: "#9ca3af",
                        opacity: 0.5,
                        badge: "neutral",
                        glow: "rgba(156, 163, 175, 0.2)",
                    },
                };
            }

            getNodeConfig(node) {
                if (!node) return this.nodeConfig.resource;

                // 1. Exact resource subtype match
                if (node.subtype && this.nodeConfig[node.subtype]) {
                    return this.nodeConfig[node.subtype];
                }

                // 2. Provider-specific match
                if (node.type === "provider" && node.subtype) {
                    if (this.nodeConfig[node.subtype]) {
                        return this.nodeConfig[node.subtype];
                    }
                    return this.nodeConfig.provider;
                }

                // 3. Check provider in details
                if (node.details?.provider) {
                    const providerResource = `${node.details.provider}_${node.subtype}`;
                    if (this.nodeConfig[providerResource]) {
                        return this.nodeConfig[providerResource];
                    }
                    if (this.nodeConfig[node.details.provider]) {
                        return this.nodeConfig[node.details.provider];
                    }
                }

                // 4. Pattern-based matching for resource categories
                if (node.subtype) {
                    const resourceType = (node.subtype || "").toLowerCase();

                    if (
                        resourceType.includes("instance") ||
                        resourceType.includes("vm") ||
                        resourceType.includes("server")
                    ) {
                        return {
                            ...this.nodeConfig.resource,
                            icon: "fas fa-server",
                            color: "#3b82f6",
                        };
                    }
                    if (
                        resourceType.includes("db") ||
                        resourceType.includes("database") ||
                        resourceType.includes("sql")
                    ) {
                        return {
                            ...this.nodeConfig.resource,
                            icon: "fas fa-database",
                            color: "#06b6d4",
                        };
                    }
                    if (
                        resourceType.includes("bucket") ||
                        resourceType.includes("storage") ||
                        resourceType.includes("volume")
                    ) {
                        return {
                            ...this.nodeConfig.resource,
                            icon: "fas fa-archive",
                            color: "#8b5cf6",
                        };
                    }
                    if (
                        resourceType.includes("vpc") ||
                        resourceType.includes("subnet") ||
                        resourceType.includes("network")
                    ) {
                        return {
                            ...this.nodeConfig.resource,
                            icon: "fas fa-network-wired",
                            color: "#10b981",
                        };
                    }
                    if (
                        resourceType.includes("security") ||
                        resourceType.includes("firewall") ||
                        resourceType.includes("acl")
                    ) {
                        return {
                            ...this.nodeConfig.resource,
                            icon: "fas fa-shield-alt",
                            color: "#f59e0b",
                        };
                    }
                    if (
                        resourceType.includes("iam") ||
                        resourceType.includes("role") ||
                        resourceType.includes("policy")
                    ) {
                        return {
                            ...this.nodeConfig.resource,
                            icon: "fas fa-user-lock",
                            color: "#ef4444",
                        };
                    }
                }

                // 5. Fallback to type-based config
                return this.nodeConfig[node.type] || this.nodeConfig.resource;
            }

            getStateConfig(state) {
                if (!state) return this.stateConfig.unknown;
                return this.stateConfig[state] || this.stateConfig.unknown;
            }

            init() {
                const container = document.getElementById("graph-container");
                if (!container) return;

                this.width = container.clientWidth;
                this.height = container.clientHeight;

                // Clear previous SVG
                d3.select("#graph-container svg").remove();

                this.svg = d3
                    .select("#graph-container")
                    .append("svg")
                    .attr("width", this.width)
                    .attr("height", this.height)
                    .classed("performance-optimized", true);

                this.setupSVGDefs();
                this.setupZoom();
                this.setupSimulation();
                this.renderGraph();

                // Export for global access
                window.zoom = this.zoom;
                window.svg = this.svg;
                window.width = this.width;
                window.height = this.height;

                // Start animations if enabled
                if (this.animationsEnabled) {
                    this.startLinkAnimation();
                }
            }

            setupSVGDefs() {
                const defs = this.svg.append("defs");

                // Enhanced grid pattern
                const grid_size = 50;
                defs
                    .append("pattern")
                    .attr("id", "grid")
                    .attr("width", grid_size)
                    .attr("height", grid_size)
                    .attr("patternUnits", "userSpaceOnUse")
                    .append("path")
                    .attr("d", `M ${grid_size} 0 L 0 0 0 ${grid_size}`)
                    .attr("fill", "none")
                    .attr("stroke", this.colors.text_secondary)
                    .attr("stroke-opacity", 0.1)
                    .attr("stroke-width", 1);

                // Add SVG filters
                const filters = defs.append("g").attr("class", "filters");

                // Glow filter for resources
                const resourceGlow = filters
                    .append("filter")
                    .attr("id", "resource-glow")
                    .attr("height", "300%")
                    .attr("width", "300%")
                    .attr("x", "-100%")
                    .attr("y", "-100%");

                resourceGlow
                    .append("feGaussianBlur")
                    .attr("stdDeviation", "2")
                    .attr("result", "coloredBlur");

                const resourceGlowMerge = resourceGlow.append("feMerge");
                resourceGlowMerge.append("feMergeNode").attr("in", "coloredBlur");
                resourceGlowMerge.append("feMergeNode").attr("in", "SourceGraphic");

                this.svg
                    .append("rect")
                    .attr("width", "100%")
                    .attr("height", "100%")
                    .attr("fill", "url(#grid)");
            }

            setupZoom() {
                const g = this.svg.append("g");
                this.graphG = g.append("g").classed("performance-optimized", true);

                // Enhanced zoom behavior
                this.zoom = d3
                    .zoom()
                    .scaleExtent([0.05, 8])
                    .wheelDelta((event) => {
                        const delta = (-event.deltaY * (event.deltaMode ? 120 : 1)) / 500;
                        return delta * this.config.zoomSpeed;
                    })
                    .on("zoom", (event) => {
                        this.currentTransform = event.transform;
                        g.attr("transform", event.transform);
                    });

                this.svg.call(this.zoom).call(this.zoom.transform, d3.zoomIdentity);
            }

            setupSimulation() {
                this.simulation = d3
                    .forceSimulation(this.graphData.nodes)
                    .force(
                        "link",
                        d3
                            .forceLink(this.graphData.edges)
                            .id((d) => d.id)
                            .distance((d) => {
                                const source =
                                    typeof d.source === "object"
                                        ? d.source
                                        : this.nodeMap.get(d.source);
                                const target =
                                    typeof d.target === "object"
                                        ? d.target
                                        : this.nodeMap.get(d.target);
                                const sourceState = source?.state || "active";
                                const targetState = target?.state || "active";
                                return Math.min(
                                    this.config.physics.link[sourceState] ||
                                    this.config.physics.link.active,
                                    this.config.physics.link[targetState] ||
                                    this.config.physics.link.active
                                );
                            })
                            .strength(0.2)
                    )
                    .force(
                        "charge",
                        d3
                            .forceManyBody()
                            .strength((d) => {
                                const stateStrength =
                                    this.config.physics.charge[d.state] ||
                                    this.config.physics.charge.active;
                                const dependencyFactor =
                                    1 + ((d.dependencies_out || 0) + (d.dependencies_in || 0)) * 0.1;
                                return stateStrength * dependencyFactor;
                            })
                            .distanceMax(400)
                    )
                    .force(
                        "center",
                        d3
                            .forceCenter(this.width / 2, this.height / 2)
                            .strength(this.config.physics.force.center)
                    )
                    .force(
                        "collision",
                        d3
                            .forceCollide()
                            .radius((d) => {
                                const baseRadius =
                                    d.type === "module"
                                        ? this.config.physics.collision.module
                                        : d.type === "resource"
                                            ? this.config.physics.collision.resource
                                            : this.config.physics.collision.base;
                                const dependencyCount =
                                    (d.dependencies_out || 0) + (d.dependencies_in || 0);
                                return (
                                    baseRadius +
                                    Math.min(
                                        dependencyCount * this.config.physics.collision.multiplier,
                                        6
                                    )
                                );
                            })
                            .strength(0.8)
                    )
                    .alphaDecay(0.0228)
                    .velocityDecay(0.4);

                // Performance-optimized simulation tick
                this.simulation.on("tick", () => {
                    if (this.config.performance.throttleRender && this.renderThrottled)
                        return;
                    this.renderThrottled = true;

                    requestAnimationFrame(() => {
                        this.updateGraphPositions();
                        this.renderThrottled = false;
                    });
                });
            }

            renderGraph() {
                this.renderLinks();
                this.renderNodes();
            }

            renderLinks() {
                this.graphG
                    .append("g")
                    .selectAll("line")
                    .data(this.graphData.edges)
                    .join("line")
                    .attr("class", "link")
                    .attr("data-source", (d) =>
                        typeof d.source === "object" ? d.source.id : d.source
                    )
                    .attr("data-target", (d) =>
                        typeof d.target === "object" ? d.target.id : d.target
                    )
                    .style("stroke-width", 1.5)
                    .style("opacity", 0.75);
            }

            renderNodes() {
                const node = this.graphG
                    .append("g")
                    .selectAll("g")
                    .data(this.graphData.nodes)
                    .join("g")
                    .attr("class", (d) => `node ${d.type} ${d.state}`)
                    .attr("data-id", (d) => d.id)
                    .call(
                        d3
                            .drag()
                            .on("start", (event, d) => this.dragstarted(event, d))
                            .on("drag", (event, d) => this.dragged(event, d))
                            .on("end", (event, d) => this.dragended(event, d))
                    )
                    .on("mouseover", (event, d) => this.showTooltip(event, d))
                    .on("mouseout", (event, d) => this.hideTooltip(event, d))
                    .on("click", (event, d) => this.highlightConnected(event, d));

                this.renderNodeShapes(node);
                this.renderNodeIcons(node);
                this.renderNodeLabels(node);
            }

            renderNodeShapes(node) {
                node
                    .append("path")
                    .attr("class", (d) => `node-shape ${d.type} ${d.state || ""}`)
                    .attr("d", (d) => {
                        const config = this.getNodeConfig(d);
                        const baseSize =
                            config.size === "large" ? 16 : config.size === "small" ? 10 : 13;
                        const dependencyCount =
                            (d.dependencies_out || 0) + (d.dependencies_in || 0);
                        const size = baseSize + Math.min(dependencyCount * 0.6, 6);
                        return this.hexagonPath(size);
                    })
                    .style("fill", (d) => {
                        const state = this.getStateConfig(d.state);
                        return state.color;
                    })
                    .style("stroke", (d) => {
                        const state = this.getStateConfig(d.state);
                        return state.stroke;
                    })
                    .style("stroke-width", (d) => {
                        return ["orphan", "invalid", "unresolved"].includes(d.state)
                            ? "2px"
                            : "1px";
                    })
                    .style("opacity", (d) => {
                        const state = this.getStateConfig(d.state);
                        return state.opacity;
                    })
                    .style("cursor", "pointer")
                    .style("stroke-dasharray", (d) => {
                        return ["unused", "obsolete", "stale"].includes(d.state)
                            ? "3,3"
                            : "none";
                    });
            }

            renderNodeIcons(node) {
                node
                    .append("foreignObject")
                    .attr("width", 24)
                    .attr("height", 24)
                    .attr("x", -12)
                    .attr("y", -15)
                    .append("xhtml:div")
                    .attr("class", "node-icon-container")
                    .style("width", "100%")
                    .style("height", "100%")
                    .style("display", "flex")
                    .style("align-items", "center")
                    .style("justify-content", "center")
                    .style("pointer-events", "none")
                    .html((d) => {
                        const config = this.getNodeConfig(d);
                        const state = this.getStateConfig(d.state);
                        const fontSize =
                            config.size === "large"
                                ? "14px"
                                : config.size === "small"
                                    ? "10px"
                                    : "12px";
                        const iconClass = config.icon;

                        let badgeHtml = "";
                        if (state.badge && state.badge !== "success") {
                            const badgeColor =
                                state.badge === "warning"
                                    ? "#f59e0b"
                                    : state.badge === "error"
                                        ? "#ef4444"
                                        : state.badge === "info"
                                            ? "#3b82f6"
                                            : "#6b7280";
                            badgeHtml = `<div class="state-badge" style="
                        position: absolute;
                        top: -4px;
                        right: -4px;
                        width: 8px;
                        height: 8px;
                        border-radius: 50%;
                        background: ${badgeColor};
                        border: 1px solid white;
                        box-shadow: 0 0 2px rgba(0,0,0,0.3);
                    "></div>`;
                        }

                        return `
                    <div style="position: relative;">
                        <i class="${iconClass}" style="font-size: ${fontSize}; color: white;"></i>
                        ${badgeHtml}
                    </div>
                `;
                    });
            }

            renderNodeLabels(node) {
                node
                    .append("text")
                    .attr("dx", (d) => {
                        const radius =
                            d.type === "module" ? 14 : d.type === "resource" ? 11 : 9;
                        const dependencyCount =
                            (d.dependencies_out || 0) + (d.dependencies_in || 0);
                        return radius + Math.min(dependencyCount * 0.6, 6) + 4;
                    })
                    .attr("dy", 4)
                    .text((d) => {
                        const maxLength = d.type === "module" ? 25 : 18;
                        const label = d.label || d.name || d.id || "Unknown";
                        return label.length > maxLength
                            ? label.substring(0, maxLength) + "..."
                            : label;
                    })
                    .style("fill", this.colors.text_primary)
                    .style("font-size", (d) => (d.type === "module" ? "12px" : "11px"))
                    .style("font-weight", "500")
                    .style("pointer-events", "none")
                    .style("text-shadow", `0 1px 4px ${this.colors.bg_primary}`);
            }

            hexagonPath(size) {
                const points = [];
                for (let i = 0; i < 6; i++) {
                    const angle = (i * Math.PI) / 3;
                    points.push([size * Math.sin(angle), size * Math.cos(angle)]);
                }
                return `M${points.map((p) => p.join(",")).join("L")}Z`;
            }

            updateGraphPositions() {
                if (!this.graphG) return;

                const link = this.graphG.selectAll(".link");
                const node = this.graphG.selectAll(".node");

                link
                    .attr("x1", (d) => d.source.x)
                    .attr("y1", (d) => d.source.y)
                    .attr("x2", (d) => d.target.x)
                    .attr("y2", (d) => d.target.y);

                node.attr("transform", (d) => `translate(${d.x},${d.y})`);
            }

            // Event handlers
            dragstarted(event, d) {
                if (!event.active && this.simulation)
                    this.simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            dragended(event, d) {
                if (!event.active && this.simulation) this.simulation.alphaTarget(0);
            }

            showTooltip(event, d) {
                // Calculate position near cursor
                const rect = event.currentTarget.getBoundingClientRect();
                const position = {
                    x: rect.right + 15,
                    y: rect.top,
                };

                // Show with delay
                if (window.terraformViewer) {
                    window.terraformViewer.showWithDelay(d, position);
                }

                // Enhanced hover effect
                const state = this.getStateConfig(d.state);
                d3.select(event.currentTarget)
                    .select("path")
                    .style("filter", `drop-shadow(0 0 15px ${state.glow})`);
            }

            hideTooltip(event, d) {
                // Hide with delay
                if (window.terraformViewer) {
                    window.terraformViewer.hideWithDelay();
                }

                // Reset node styling
                if (d && !this.highlightedNodes.has(d.id)) {
                    const state = this.getStateConfig(d.state);
                    d3.select(event.currentTarget)
                        .select("path")
                        .style("filter", `drop-shadow(0 0 8px ${state.glow})`);
                }
            }

            // Enhanced highlight system
            highlightConnected(event, d) {
                if (!d) return;
                event.stopPropagation();

                if (this.highlightedNodes.has(d.id)) {
                    this.clearHighlight();
                    return;
                }

                this.clearHighlight();
                this.highlightedNodes.add(d.id);

                // Get connected nodes from the edge data
                const edges = this.graphData.edges.filter((edge) => {
                    const sourceId =
                        typeof edge.source === "object" ? edge.source.id : edge.source;
                    const targetId =
                        typeof edge.target === "object" ? edge.target.id : edge.target;
                    return sourceId === d.id || targetId === d.id;
                });

                // Add connected nodes and edges to highlight sets
                edges.forEach((edge) => {
                    const sourceId =
                        typeof edge.source === "object" ? edge.source.id : edge.source;
                    const targetId =
                        typeof edge.target === "object" ? edge.target.id : edge.target;
                    this.highlightedNodes.add(sourceId);
                    this.highlightedNodes.add(targetId);
                    this.highlightedEdges.add(`${sourceId}->${targetId}`);
                });

                // Apply highlights
                if (!this.graphG) return;

                d3.selectAll(".node")
                    .transition()
                    .duration(300)
                    .style("opacity", (n) => (this.highlightedNodes.has(n.id) ? 1 : 0.2));

                d3.selectAll(".link")
                    .transition()
                    .duration(300)
                    .style("stroke-opacity", (edge) => {
                        const sourceId =
                            typeof edge.source === "object" ? edge.source.id : edge.source;
                        const targetId =
                            typeof edge.target === "object" ? edge.target.id : edge.target;
                        const edgeKey = `${sourceId}->${targetId}`;
                        return this.highlightedEdges.has(edgeKey) ? 1 : 0.1;
                    })
                    .style("stroke", (edge) => {
                        const sourceId =
                            typeof edge.source === "object" ? edge.source.id : edge.source;
                        const targetId =
                            typeof edge.target === "object" ? edge.target.id : edge.target;
                        const edgeKey = `${sourceId}->${targetId}`;
                        const target = this.nodeMap.get(targetId);
                        const state = target
                            ? this.getStateConfig(target.state)
                            : this.stateConfig.unknown;
                        return this.highlightedEdges.has(edgeKey)
                            ? state.color
                            : this.colors.text_secondary;
                    });

                // Restart animations for highlighted edges
                if (this.animationsEnabled) {
                    this.stopLinkAnimation();
                    this.startLinkAnimation();
                }
            }

            clearHighlight() {
                this.highlightedNodes.clear();
                this.highlightedEdges.clear();

                if (!this.graphG) return;

                d3.selectAll(".node").transition().duration(300).style("opacity", 1);

                d3.selectAll(".link")
                    .transition()
                    .duration(300)
                    .style("stroke-opacity", 0.4)
                    .style("stroke", this.colors.text_secondary);

                if (this.animationsEnabled) {
                    this.stopLinkAnimation();
                }
            }

            startLinkAnimation() {
                if (!this.graphG) return;
                d3.selectAll(".link").classed("highlight", (d) => {
                    const sourceId = typeof d.source === "object" ? d.source.id : d.source;
                    const targetId = typeof d.target === "object" ? d.target.id : d.target;
                    return this.highlightedEdges.has(`${sourceId}->${targetId}`);
                });
            }

            stopLinkAnimation() {
                if (!this.graphG) return;
                d3.selectAll(".link").classed("highlight", false);
            }

            // Control functions
            zoomHandler(direction) {
                if (!this.svg || !this.zoom) return;
                const zoomAmount = direction === "in" ? 1.2 : 1 / 1.2;
                this.svg.transition().duration(300).call(this.zoom.scaleBy, zoomAmount);
            }

            zoomIn() {
                this.zoomHandler("in");
            }
            zoomOut() {
                this.zoomHandler("out");
            }
            resetZoom() {
                if (!this.svg || !this.zoom) return;
                this.svg
                    .transition()
                    .duration(500)
                    .call(this.zoom.transform, d3.zoomIdentity);
            }

            centerGraph() {
                if (!this.svg || !this.zoom || !this.width || !this.height) return;
                const initialScale = 1;
                const x = this.width / 2;
                const y = this.height / 2;

                const transform = d3.zoomIdentity
                    .translate(x, y)
                    .scale(initialScale)
                    .translate(-x, -y);

                this.svg.transition().duration(500).call(this.zoom.transform, transform);
            }

            resetView() {
                this.resetZoom();
                this.clearHighlight();
                if (!this.physicsEnabled) this.togglePhysics();
            }

            togglePhysics() {
                this.physicsEnabled = !this.physicsEnabled;
                const btn = document.getElementById("physics-btn");
                if (btn) {
                    btn.innerHTML = this.physicsEnabled
                        ? '<i class="fas fa-bolt"></i> Physics'
                        : '<i class="fas fa-bolt-slash"></i> Physics';
                }

                if (this.simulation) {
                    if (this.physicsEnabled) {
                        this.simulation.alpha(0.3).restart();
                    } else {
                        this.simulation.stop();
                    }
                }
            }

            toggleAnimations() {
                this.animationsEnabled = !this.animationsEnabled;
                const btn = document.getElementById("animations-btn");
                if (btn) {
                    if (this.animationsEnabled) {
                        btn.innerHTML = '<i class="fas fa-sparkles"></i> Animations';
                        this.startLinkAnimation();
                    } else {
                        btn.innerHTML = '<i class="fas fa-ban"></i> Animations';
                        this.stopLinkAnimation();
                    }
                }
            }

            destroy() {
                if (this.simulation) {
                    this.simulation.stop();
                }
                if (this.animationTimer) {
                    clearTimeout(this.animationTimer);
                }
            }
        }
    </script>
    <script>
        class CommandPalette {
            constructor(options = {}) {
                this.config = {
                    enableBacktickKey: true,
                    maxHistorySize: 10,
                    searchDebounce: 100, // Reduced for better responsiveness
                    toastDuration: 3000,
                    enableVirtualScroll: true,
                    virtualScrollThreshold: 30, // Lower threshold
                    enableCommandHistory: true,
                    enableCategories: false, // Disable categories during search for performance
                    pausePhysics: true, // New: control whether to pause physics
                    pauseAnimations: true, // New: control whether to pause animations
                    useRequestAnimationFrame: true, // New: use rAF for smooth animations
                    ...options,
                };

                this.backdrop = document.getElementById("backdrop");
                this.commandPalette = document.getElementById("commandPalette");
                this.commandInput = document.getElementById("commandInput");
                this.commandList = document.getElementById("commandList");
                this.toastContainer = document.getElementById("toastContainer");
                this.quickActions = document.getElementById("quickActions");

                if (!this.commandPalette || !this.backdrop || !this.commandInput) {
                    console.warn("Command palette essential elements not found in DOM");
                    return;
                }

                this.selectedCommandIndex = 0;
                this.isFullscreen = false;
                this.commandHistory = [];
                this.previousFocusElement = null;
                this._hadPhysics = false;
                this._hadAnimations = false;
                this.isOpen = false;

                this.animationFrameId = null;
                this.lastRenderTime = 0;
                this.renderThrottleMs = 16; // ~60fps

                this.commands = {
                    view: [
                        {
                            id: "toggle-fullscreen",
                            title: "Toggle Fullscreen",
                            description: "Enter or exit fullscreen mode",
                            icon: "fas fa-expand",
                            shortcut: "F11",
                            category: "view",
                            action: () => this.toggleFullscreen(),
                        },
                        {
                            id: "reset-view",
                            title: "Reset View",
                            description: "Reset zoom, position and filters",
                            icon: "fas fa-sync-alt",
                            shortcut: "R",
                            category: "view",
                            action: () => this.safeExecute(resetView, "Reset View"),
                        },
                        {
                            id: "center-graph",
                            title: "Center Graph",
                            description: "Center the graph in view",
                            icon: "fas fa-bullseye",
                            shortcut: "C",
                            category: "view",
                            action: () => this.safeExecute(centerGraph, "Center Graph"),
                        },
                    ],
                    behavior: [
                        {
                            id: "toggle-physics",
                            title: "Toggle Physics",
                            description: "Enable/disable graph physics",
                            icon: "fas fa-bolt",
                            shortcut: "P",
                            category: "behavior",
                            action: () => this.safeExecute(togglePhysics, "Toggle Physics"),
                        },
                        {
                            id: "toggle-animations",
                            title: "Toggle Animations",
                            description: "Enable/disable graph animations",
                            icon: "fas fa-sparkles",
                            shortcut: "A",
                            category: "behavior",
                            action: () => this.safeExecute(toggleAnimations, "Toggle Animations"),
                        },
                    ],
                    data: [
                        {
                            id: "clear-filters",
                            title: "Clear Filters",
                            description: "Remove all active filters",
                            icon: "fas fa-filter",
                            shortcut: "F",
                            category: "data",
                            action: () => this.safeExecute(clearFilters, "Clear Filters"),
                        },
                    ],
                    help: [
                        {
                            id: "show-help",
                            title: "Show Help",
                            description: "Display keyboard shortcuts and tips",
                            icon: "fas fa-question-circle",
                            shortcut: "H",
                            category: "help",
                            action: () => this.showHelp(),
                        },
                    ],
                };

                this.allCommands = this.flattenCommands();

                this.boundHandleKeyboard = this.handleKeyboard.bind(this);
                this.boundFilterCommands = this.debounce(
                    this.filterCommands.bind(this),
                    this.config.searchDebounce
                );
                this.boundHandleCommandNavigation = this.handleCommandNavigation.bind(this);
                this.boundHandleBackdropClick = this.hideCommandPalette.bind(this);
                this.boundHandleQuickAction = this.handleQuickAction.bind(this);

                this.boundOptimizedRender = this.optimizedRender.bind(this);

                this.setupEventListeners();
            }

            flattenCommands() {
                return Object.values(this.commands).flat();
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            throttle(func, limit) {
                let inThrottle;
                return function (...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => (inThrottle = false), limit);
                    }
                };
            }

            safeExecute(fn, commandName) {
                try {
                    if (typeof fn === "function") {
                        if (
                            this.config.useRequestAnimationFrame &&
                            !fn.name.includes("toggle")
                        ) {
                            requestAnimationFrame(() => fn());
                        } else {
                            fn();
                        }
                        return true;
                    } else {
                        console.warn(`Command "${commandName}" function not found`);
                        this.showToast(
                            "Command Error",
                            `${commandName} function is not available`,
                            "warning"
                        );
                        return false;
                    }
                } catch (error) {
                    console.error(`Error executing command "${commandName}":`, error);
                    this.showToast(
                        "Execution Error",
                        `Failed to execute ${commandName}`,
                        "error"
                    );
                    return false;
                }
            }

            setupEventListeners() {
                const passiveOptions = { passive: true };

                document.addEventListener("keydown", this.boundHandleKeyboard);

                if (this.commandInput) {
                    this.commandInput.addEventListener(
                        "input",
                        this.boundFilterCommands,
                        passiveOptions
                    );
                    this.commandInput.addEventListener(
                        "keydown",
                        this.boundHandleCommandNavigation
                    );
                }

                if (this.quickActions) {
                    this.quickActions.addEventListener(
                        "click",
                        this.boundHandleQuickAction,
                        passiveOptions
                    );
                }

                if (this.backdrop) {
                    this.backdrop.addEventListener(
                        "click",
                        this.boundHandleBackdropClick,
                        passiveOptions
                    );
                }

                this.commandPalette.addEventListener("keydown", (e) => {
                    if (e.key === "Escape") {
                        this.hideCommandPalette();
                    }
                });
            }

            handleKeyboard(event) {
                if (
                    event.target.tagName === "INPUT" ||
                    event.target.tagName === "TEXTAREA"
                ) {
                    return;
                }

                if (this.isOpen && event.key !== "Escape") {
                    return;
                }

                if (event.ctrlKey || event.metaKey || event.altKey) {
                    if ((event.ctrlKey || event.metaKey) && event.key === "k") {
                        event.preventDefault();
                        this.showCommandPalette();
                    }
                    return;
                }

                switch (event.key) {
                    case "Escape":
                        if (this.isOpen) {
                            event.preventDefault();
                            this.hideCommandPalette();
                        }
                        break;
                    case "F11":
                        event.preventDefault();
                        this.toggleFullscreen();
                        break;
                    case "k":
                        if (event.ctrlKey || event.metaKey) {
                            event.preventDefault();
                            this.showCommandPalette();
                        }
                        break;
                    case "/":
                        if (!event.ctrlKey && !event.metaKey) {
                            event.preventDefault();
                            this.showCommandPalette();
                        }
                        break;
                    case "`":
                        if (
                            this.config.enableBacktickKey &&
                            !event.ctrlKey &&
                            !event.metaKey &&
                            !event.altKey
                        ) {
                            event.preventDefault();
                            this.showCommandPalette();
                        }
                        break;
                    case "r":
                    case "R":
                        if (!this.isOpen) {
                            event.preventDefault();
                            this.safeExecute(resetView, "Reset View");
                        }
                        break;
                    case "p":
                    case "P":
                        if (!this.isOpen) {
                            event.preventDefault();
                            this.safeExecute(togglePhysics, "Toggle Physics");
                        }
                        break;
                    case "c":
                    case "C":
                        if (!this.isOpen) {
                            event.preventDefault();
                            this.safeExecute(centerGraph, "Center Graph");
                        }
                        break;
                    case "f":
                    case "F":
                        if (!this.isOpen) {
                            event.preventDefault();
                            this.safeExecute(clearFilters, "Clear Filters");
                        }
                        break;
                    case "a":
                    case "A":
                        if (!this.isOpen) {
                            event.preventDefault();
                            this.safeExecute(toggleAnimations, "Toggle Animations");
                        }
                        break;
                    case "h":
                    case "H":
                        if (!this.isOpen) {
                            event.preventDefault();
                            this.showHelp();
                        }
                        break;
                }
            }

            showCommandPalette() {
                if (!this.commandPalette || !this.backdrop || this.isOpen) {
                    return;
                }

                this.isOpen = true;

                requestAnimationFrame(() => {
                    try {
                        this.previousFocusElement = document.activeElement;

                        if (this.config.pausePhysics) {
                            this._hadPhysics =
                                typeof physicsEnabled !== "undefined" && physicsEnabled === true;
                            if (
                                this._hadPhysics &&
                                typeof simulation !== "undefined" &&
                                simulation
                            ) {
                                simulation.alphaTarget(0); // Reduce simulation activity
                                simulation.velocityDecay(0.8); // Increase friction
                            }
                        }

                        if (this.config.pauseAnimations) {
                            this._hadAnimations =
                                typeof animationTimer !== "undefined" && animationTimer !== null;
                            if (this._hadAnimations) {
                                this.safeExecute(stopLinkAnimation, "Stop Animations");
                            }
                        }
                    } catch (err) {
                        console.warn("Error adjusting background processes:", err);
                    }

                    this.backdrop.classList.add("show");
                    this.commandPalette.classList.add("show");

                    this.commandPalette.setAttribute("aria-hidden", "false");
                    this.backdrop.setAttribute("aria-hidden", "false");
                    document.body.classList.add("command-palette-open");

                    this.commandInput.value = "";

                    setTimeout(() => {
                        this.commandInput.focus();
                        this.filterCommands();
                    }, 50);
                });
            }

            hideCommandPalette() {
                if (!this.commandPalette || !this.backdrop || !this.isOpen) return;

                this.isOpen = false;

                requestAnimationFrame(() => {
                    this.backdrop.classList.remove("show");
                    this.commandPalette.classList.remove("show");

                    this.commandPalette.setAttribute("aria-hidden", "true");
                    this.backdrop.setAttribute("aria-hidden", "true");
                    document.body.classList.remove("command-palette-open");

                    if (this.commandInput) {
                        this.commandInput.value = "";
                    }
                    this.selectedCommandIndex = 0;

                    if (this.animationFrameId) {
                        cancelAnimationFrame(this.animationFrameId);
                        this.animationFrameId = null;
                    }

                    this.restoreBackgroundProcesses();

                    if (this.previousFocusElement && this.previousFocusElement.focus) {
                        setTimeout(() => {
                            this.previousFocusElement.focus();
                        }, 100);
                    }
                });
            }

            restoreBackgroundProcesses() {
                try {
                    if (
                        this.config.pausePhysics &&
                        this._hadPhysics &&
                        typeof simulation !== "undefined" &&
                        simulation
                    ) {
                        simulation.alphaTarget(0.3);
                        simulation.velocityDecay(0.4);
                        simulation.alpha(0.3).restart();
                    }
                } catch (err) {
                    console.warn("Error restoring physics:", err);
                }

                try {
                    if (
                        this.config.pauseAnimations &&
                        this._hadAnimations &&
                        typeof animationsEnabled !== "undefined" &&
                        animationsEnabled
                    ) {
                        setTimeout(() => {
                            this.safeExecute(startLinkAnimation, "Start Animations");
                        }, 100);
                    }
                } catch (err) {
                    console.warn("Error restoring animations:", err);
                }
            }

            filterCommands() {
                if (!this.commandInput || !this.commandList) return;

                const query = this.commandInput.value.toLowerCase().trim();

                if (this.config.useRequestAnimationFrame) {
                    if (this.animationFrameId) {
                        cancelAnimationFrame(this.animationFrameId);
                    }
                    this.animationFrameId = requestAnimationFrame(() => {
                        this.performFiltering(query);
                    });
                } else {
                    this.performFiltering(query);
                }
            }

            performFiltering(query) {
                const now = performance.now();
                if (now - this.lastRenderTime < this.renderThrottleMs) {
                    return;
                }

                let filteredCommands = this.allCommands;

                if (query) {
                    filteredCommands = this.allCommands.filter(
                        (cmd) =>
                            cmd.title.toLowerCase().includes(query) ||
                            cmd.description.toLowerCase().includes(query) ||
                            (cmd.shortcut && cmd.shortcut.toLowerCase().includes(query))
                    );
                }

                this.optimizedRender(filteredCommands, query);
                this.lastRenderTime = now;
            }

            optimizedRender(commands, query = "") {
                if (!this.commandList) return;

                const fragment = document.createDocumentFragment();
                this.selectedCommandIndex = 0;

                if (commands.length === 0) {
                    const noResults = document.createElement("div");
                    noResults.className = "command-no-results";
                    noResults.innerHTML = `
        <div class="no-results-icon">
          <i class="fas fa-search"></i>
        </div>
        <div class="no-results-text">
          <div class="no-results-title">No commands found</div>
          <div class="no-results-description">Try a different search term</div>
        </div>
      `;
                    fragment.appendChild(noResults);
                } else {
                    const commandsToRender =
                        this.config.enableVirtualScroll &&
                            commands.length > this.config.virtualScrollThreshold
                            ? commands.slice(0, this.config.virtualScrollThreshold)
                            : commands;

                    commandsToRender.forEach((command, index) => {
                        const isSelected = index === 0;
                        const item = this.createCommandItem(command, isSelected, query);
                        fragment.appendChild(item);
                    });

                    if (
                        this.config.enableVirtualScroll &&
                        commands.length > this.config.virtualScrollThreshold
                    ) {
                        const moreItem = document.createElement("div");
                        moreItem.className = "command-more-results";
                        moreItem.textContent = `... and ${commands.length - this.config.virtualScrollThreshold
                            } more commands`;
                        fragment.appendChild(moreItem);
                    }
                }

                this.commandList.innerHTML = "";
                this.commandList.appendChild(fragment);
            }

            createCommandItem(command, isSelected, query = "") {
                const item = document.createElement("div");
                item.className = `command-item ${isSelected ? "selected" : ""}`;
                item.setAttribute("role", "option");
                item.setAttribute("aria-selected", isSelected);

                const title = this.simpleHighlight(command.title, query);
                const description = this.simpleHighlight(command.description, query);

                item.innerHTML = `
      <div class="command-icon">
        <i class="${command.icon}"></i>
      </div>
      <div class="command-content">
        <div class="command-title">${title}</div>
        <div class="command-description">${description}</div>
      </div>
      <div class="command-shortcut">${command.shortcut}</div>
    `;

                item.addEventListener("click", () => this.executeCommand(command), {
                    passive: true,
                });
                return item;
            }

            simpleHighlight(text, query) {
                if (!query) return text;

                const index = text.toLowerCase().indexOf(query);
                if (index === -1) return text;

                const before = text.substring(0, index);
                const match = text.substring(index, index + query.length);
                const after = text.substring(index + query.length);

                return `${before}<mark>${match}</mark>${after}`;
            }

            handleCommandNavigation(event) {
                const items = this.commandList.querySelectorAll(".command-item");
                if (items.length === 0) return;

                switch (event.key) {
                    case "ArrowDown":
                        event.preventDefault();
                        this.selectedCommandIndex = Math.min(
                            this.selectedCommandIndex + 1,
                            items.length - 1
                        );
                        this.updateCommandSelection();
                        break;
                    case "ArrowUp":
                        event.preventDefault();
                        this.selectedCommandIndex = Math.max(this.selectedCommandIndex - 1, 0);
                        this.updateCommandSelection();
                        break;
                    case "Enter":
                        event.preventDefault();
                        if (items[this.selectedCommandIndex]) {
                            requestAnimationFrame(() => {
                                items[this.selectedCommandIndex].click();
                            });
                        }
                        break;
                }
            }

            updateCommandSelection() {
                const items = this.commandList.querySelectorAll(".command-item");

                requestAnimationFrame(() => {
                    items.forEach((item, index) => {
                        const isSelected = index === this.selectedCommandIndex;
                        item.classList.toggle("selected", isSelected);
                        item.setAttribute("aria-selected", isSelected);

                        if (isSelected) {
                            item.scrollIntoView({
                                block: "nearest",
                                behavior: items.length > 10 ? "auto" : "smooth",
                            });
                        }
                    });
                });
            }

            executeCommand(command) {
                if (this.config.enableCommandHistory) {
                    this.addToHistory(command);
                }

                const success = command.action();

                if (success !== false) {
                    setTimeout(() => {
                        this.hideCommandPalette();
                        this.showToast("Command Executed", command.title, "success");
                    }, 50);
                }
            }

            addToHistory(command) {
                this.commandHistory.unshift({
                    id: command.id,
                    title: command.title,
                    timestamp: Date.now(),
                });

                if (this.commandHistory.length > this.config.maxHistorySize) {
                    this.commandHistory = this.commandHistory.slice(
                        0,
                        this.config.maxHistorySize
                    );
                }
            }

            handleQuickAction(event) {
                const action = event.target.closest(".quick-action");
                if (!action) return;

                const actionType = action.dataset.action;

                requestAnimationFrame(() => {
                    switch (actionType) {
                        case "command":
                            this.showCommandPalette();
                            break;
                        case "center":
                            this.safeExecute(centerGraph, "Center Graph");
                            break;
                        case "physics":
                            this.safeExecute(togglePhysics, "Toggle Physics");
                            break;
                        case "fullscreen":
                            this.toggleFullscreen();
                            break;
                        case "help":
                            this.showHelp();
                            break;
                    }
                });
            }

            toggleFullscreen() {
                const updateGraph = () => {
                    const container = document.getElementById("graph-container");
                    if (!container) return;

                    setTimeout(() => {
                        try {
                            if (window.simulation) {
                                simulation.alpha(0.3).restart();
                            }

                            const width = container.clientWidth;
                            const height = container.clientHeight;

                            if (window.svg) {
                                requestAnimationFrame(() => {
                                    window.svg
                                        .attr("width", width)
                                        .attr("height", height)
                                        .attr("viewBox", [0, 0, width, height]);

                                    if (window.zoom) {
                                        window.zoom.extent([
                                            [0, 0],
                                            [width, height],
                                        ]);
                                        window.svg.call(window.zoom.transform, d3.zoomIdentity);
                                    }

                                    if (window.simulation) {
                                        simulation.force(
                                            "center",
                                            d3.forceCenter(width / 2, height / 2)
                                        );
                                        simulation.alpha(0.3).restart();
                                    }
                                });
                            }
                        } catch (error) {
                            console.error("Error updating graph dimensions:", error);
                        }
                    }, 100);
                };

                if (!document.fullscreenElement) {
                    document.documentElement
                        .requestFullscreen()
                        .then(() => {
                            this.isFullscreen = true;
                            updateGraph();
                        })
                        .catch((err) => {
                            console.error("Fullscreen error:", err);
                            this.showToast(
                                "Fullscreen Error",
                                "Failed to enter fullscreen mode",
                                "error"
                            );
                        });
                } else {
                    document.exitFullscreen().then(() => {
                        this.isFullscreen = false;
                        updateGraph();
                    });
                }
            }

            destroy() {
                this.isOpen = false;

                document.removeEventListener("keydown", this.boundHandleKeyboard);

                if (this.commandInput) {
                    this.commandInput.removeEventListener("input", this.boundFilterCommands);
                    this.commandInput.removeEventListener(
                        "keydown",
                        this.boundHandleCommandNavigation
                    );
                }

                if (this.quickActions) {
                    this.quickActions.removeEventListener(
                        "click",
                        this.boundHandleQuickAction
                    );
                }

                if (this.backdrop) {
                    this.backdrop.removeEventListener("click", this.boundHandleBackdropClick);
                }

                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                }

                this.restoreBackgroundProcesses();

                this.backdrop = null;
                this.commandPalette = null;
                this.commandInput = null;
                this.commandList = null;
                this.toastContainer = null;
                this.quickActions = null;
            }

            setHighPerformanceMode(enable = true) {
                this.config.pausePhysics = enable;
                this.config.pauseAnimations = enable;
                this.config.useRequestAnimationFrame = enable;
                this.config.searchDebounce = enable ? 50 : 100;
                return this;
            }

            setLowPerformanceMode(enable = true) {
                this.config.pausePhysics = !enable;
                this.config.pauseAnimations = !enable;
                this.config.useRequestAnimationFrame = !enable;
                this.config.searchDebounce = enable ? 150 : 100;
                return this;
            }
        }
    </script>
    <script>
        class TerraformObjectViewer {
            constructor(options = {}) {
                this.config = {
                    container: options.container || "#terraform-object-viewer",
                    animationDuration: options.animationDuration || 200,
                    hoverDelay: options.hoverDelay || 150,
                    hideDelay: options.hideDelay || 200,
                    ...options,
                };

                this.state = {
                    isVisible: false,
                    currentData: null,
                    position: { x: 0, y: 0 },
                    hoverTimer: null,
                    hideTimer: null,
                };

                this.elements = {};
                this.init();
            }

            init() {
                this.createContainer();
                this.bindEvents();
            }

            createContainer() {
                let container = document.querySelector(this.config.container);

                if (!container) {
                    container = document.createElement("div");
                    container.id = this.config.container.replace("#", "");
                    container.className = "terraform-object-viewer";
                    document.body.appendChild(container);
                }

                this.elements.container = container;
                container.innerHTML = this.getTemplate();

                this.elements.content = container.querySelector(".tov-content");
                this.elements.title = container.querySelector(".tov-title");
                this.elements.subtitle = container.querySelector(".tov-subtitle");
                this.elements.icon = container.querySelector(".tov-icon");
            }

            getTemplate() {
                return `
                    <div class="tov-tooltip">
                        <div class="tov-header">
                            <div class="tov-icon"></div>
                            <div class="tov-title-group">
                                <h3 class="tov-title">Object Details</h3>
                                <div class="tov-subtitle"></div>
                            </div>
                        </div>
                        <div class="tov-content"></div>
                    </div>
                `;
            }

            bindEvents() {
                // Close when clicking outside
                document.addEventListener("click", () => {
                    this.hide();
                });

                // Prevent tooltip from closing when clicking inside
                this.elements.container?.addEventListener("click", (e) => {
                    e.stopPropagation();
                });
            }

            calculatePositionFromElement(element) {
                const rect = element.getBoundingClientRect();
                return {
                    x: rect.right + 10,
                    y: rect.top,
                };
            }

            show(data, position = null, targetElement = null) {
                this.clearTimers();

                if (this.state.isVisible && this.state.currentData?.id === data.id) {
                    return;
                }

                this.state.currentData = data;
                this.state.isVisible = true;

                if (!position && targetElement) {
                    position = this.calculatePositionFromElement(targetElement);
                }

                this.calculatePosition(position);
                this.renderContent(data);

                this.elements.container.classList.add("tov-visible");
            }

            showWithDelay(data, position = null, targetElement = null) {
                this.clearTimers();

                this.state.hoverTimer = setTimeout(() => {
                    this.show(data, position, targetElement);
                }, this.config.hoverDelay);
            }

            calculatePosition(position) {
                if (!position) {
                    position = { x: 20, y: 20 };
                }

                const tooltip = this.elements.container.querySelector(".tov-tooltip");
                if (!tooltip) return;

                const wasVisible = this.state.isVisible;
                tooltip.style.visibility = "hidden";
                tooltip.style.display = "block";
                this.elements.container.classList.add("tov-visible");

                const tooltipRect = tooltip.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                let adjustedX = position.x;
                let adjustedY = position.y;

                if (adjustedX + tooltipRect.width > viewportWidth) {
                    adjustedX = viewportWidth - tooltipRect.width - 10;
                }

                if (adjustedX < 10) {
                    adjustedX = 10;
                }

                if (adjustedY + tooltipRect.height > viewportHeight) {
                    adjustedY = viewportHeight - tooltipRect.height - 10;
                }

                if (adjustedY < 10) {
                    adjustedY = 10;
                }

                if (!wasVisible) {
                    this.elements.container.classList.remove("tov-visible");
                }
                tooltip.style.visibility = "";
                tooltip.style.display = "";

                this.state.position = { x: adjustedX, y: adjustedY };
                tooltip.style.left = `${adjustedX}px`;
                tooltip.style.top = `${adjustedY}px`;
            }

            renderContent(data) {
                if (!this.elements.content) return;

                const content = this.generateContent(data);
                this.elements.content.innerHTML = content;

                this.updateHeader(data);
            }

            updateHeader(data) {
                const nodeConfig = getNodeConfig(data);
                const stateConfig = getStateConfig(data.state);

                if (this.elements.icon) {
                    this.elements.icon.innerHTML = `<i class="${nodeConfig.icon}"></i>`;
                    this.elements.icon.style.color = nodeConfig.color;

                    // Add enhanced icon styling
                    this.elements.icon.style.background = `${nodeConfig.color}15`;
                    this.elements.icon.style.border = `1px solid ${nodeConfig.color}30`;
                    this.elements.icon.style.borderRadius = "8px";
                    this.elements.icon.style.padding = "6px";
                }

                if (this.elements.title) {
                    const titleText =
                        data.label || data.name || data.id || "Unnamed Resource";
                    this.elements.title.textContent = titleText;

                    this.elements.title.title = titleText;
                }

                if (this.elements.subtitle) {
                    const state = data.state || "unknown";
                    const type = data.type || data.subtype || "unknown";

                    this.elements.subtitle.innerHTML = `
                        <span class="node-state ${state}">${this.formatStateLabel(
                        state
                    )}</span>
                        <span class="tov-type ${type}">${this.formatTypeLabel(
                        type
                    )}</span>
                    `;
                }
            }

            formatStateLabel(state) {
                const stateLabels = {
                    active: "Active",
                    hub: "Hub",
                    bridge: "Bridge",
                    aggregator: "Aggregator",
                    configuration: "Config",
                    config_provider: "Config Provider",
                    config_consumer: "Config Consumer",
                    external: "External",
                    dependency: "Dependency",
                    derived: "Derived",
                    leaf: "Leaf",
                    orphan: "Orphan",
                    unused: "Unused",
                    obsolete: "Obsolete",
                    stale: "Stale",
                    invalid: "Invalid",
                    unresolved: "Unresolved",
                    transient: "Transient",
                    ephemeral: "Ephemeral",
                    shared: "Shared",
                    unknown: "Unknown",
                };
                return stateLabels[state] || this.capitalizeFirst(state) || "Unknown";
            }

            formatTypeLabel(type) {
                const typeLabels = {
                    terraform: "Terraform",
                    provider: "Provider",
                    variable: "Variable",
                    local: "Local",
                    module: "Module",
                    data: "Data",
                    resource: "Resource",
                    output: "Output",
                    input: "Input",
                    import: "Import",
                    check: "Check",
                    assertion: "Assertion",
                    aws: "AWS",
                    azure: "Azure",
                    google: "Google",
                    kubernetes: "K8s",
                    docker: "Docker",
                    null: "Null",
                    random: "Random",
                    tls: "TLS",
                    time: "Time",
                };
                return typeLabels[type] || this.capitalizeFirst(type) || "Unknown";
            }

            capitalizeFirst(str) {
                if (!str) return "";
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            generateContent(data) {
                const sections = [];

                // Common sections for all types
                sections.push(this.createDependenciesSection(data));

                // Type-specific content generation
                switch (data.type) {
                    case "terraform":
                        sections.push(this.createTerraformSection(data));
                        break;
                    case "provider":
                        sections.push(this.createProviderSection(data));
                        break;
                    case "variable":
                        sections.push(this.createVariableSection(data));
                        break;
                    case "local":
                        sections.push(this.createLocalSection(data));
                        break;
                    case "module":
                        sections.push(this.createModuleSection(data));
                        break;
                    case "data":
                        sections.push(this.createDataSection(data));
                        break;
                    case "output":
                        sections.push(this.createOutputSection(data));
                        break;
                    case "resource":
                        sections.push(this.createResourceSection(data));
                        break;
                    default:
                        sections.push(this.createBasicInfoSection(data));
                }

                if (data.details?.source_file || data.details?.line_number) {
                    sections.push(this.createLocationSection(data));
                }

                return sections.join("");
            }

            createTerraformSection(data) {
                const details = data.details || {};
                const attributes = details.attributes || {};

                return `
                    <div class="tooltip-section">
                        <div class="tooltip-label">
                            <i class="fas fa-sitemap"></i>
                            Terraform Configuration
                        </div>
                        ${attributes.required_version
                        ? `
                        <div class="tooltip-stat">
                            <span>Required Version:</span>
                            <span class="tov-code">${attributes.required_version}</span>
                        </div>
                        `
                        : ""
                    }
                        ${this.createRequiredProvidersSection(
                        attributes.required_providers
                    )}
                        ${this.createBackendSection(attributes.backend)}
                        ${this.createCloudSection(attributes.cloud)}
                    </div>
                `;
            }

            createRequiredProvidersSection(requiredProviders) {
                if (!requiredProviders || Object.keys(requiredProviders).length === 0)
                    return "";

                const providers = Object.entries(requiredProviders)
                    .map(
                        ([name, config]) => `
                    <div class="tooltip-stat nested">
                        <span>${name}:</span>
                        <span class="tov-code">${config.source}@${config.version}</span>
                    </div>
                `
                    )
                    .join("");

                return `
                    <div class="tooltip-stat">
                        <span><i class="fas fa-plug"></i> Providers:</span>
                        <span>${Object.keys(requiredProviders).length}</span>
                    </div>
                    <div class="nested-section">
                        ${providers}
                    </div>
                `;
            }

            createBackendSection(backend) {
                if (!backend) return "";

                const backendType = Object.keys(backend)[0];
                const config = backend[backendType];

                return `
                    <div class="tooltip-stat">
                        <span><i class="fas fa-database"></i> Backend:</span>
                        <span class="tov-code">${backendType}</span>
                    </div>
                    ${config
                        ? `
                    <div class="nested-section">
                        ${Object.entries(config)
                            .map(
                                ([key, value]) => `
                            <div class="tooltip-stat nested">
                                <span>${key}:</span>
                                <span class="tov-code">${value}</span>
                            </div>
                        `
                            )
                            .join("")}
                    </div>
                    `
                        : ""
                    }
                `;
            }

            createCloudSection(cloud) {
                if (!cloud) return "";

                return `
                    <div class="tooltip-stat">
                        <span><i class="fas fa-cloud"></i> Cloud:</span>
                        <span>Terraform Cloud</span>
                    </div>
                    ${cloud.organization
                        ? `
                    <div class="nested-section">
                        <div class="tooltip-stat nested">
                            <span>Organization:</span>
                            <span class="tov-code">${cloud.organization}</span>
                        </div>
                        ${cloud.workspaces
                            ? `
                        <div class="tooltip-stat nested">
                            <span>Workspace:</span>
                            <span class="tov-code">${cloud.workspaces[0]?.name || "N/A"
                            }</span>
                        </div>
                        `
                            : ""
                        }
                    </div>
                    `
                        : ""
                    }
                `;
            }

            createProviderSection(data) {
                const details = data.details || {};
                const attributes = data.data?.attributes || details.attributes || {};
                const providerData = data.data || {};

                // Common provider attributes to display
                const providerAttributes = {
                    // Core provider info
                    Provider: attributes.provider || data.provider || providerData.provider,
                    Alias: attributes.alias,
                    Region: attributes.region || details.region || providerData.region,
                    Version: attributes.version || details.version || providerData.version,
                    Source: data.source || attributes.source || providerData.source,

                    // AWS specific
                    "Account ID": attributes.account_id || attributes.aws_account_id,
                    Profile: attributes.profile,
                    "Role ARN": attributes.role_arn,
                    "Assume Role": attributes.assume_role,

                    // Azure specific
                    "Subscription ID": attributes.subscription_id,
                    "Client ID": attributes.client_id,
                    "Tenant ID": attributes.tenant_id,

                    // GCP specific
                    Project: attributes.project || attributes.gcp_project,
                    Zone: attributes.zone,

                    // Generic cloud
                    Endpoint: attributes.endpoint,
                    "Skip Credentials Validation": attributes.skip_credentials_validation,
                    "Skip Region Validation": attributes.skip_region_validation,

                    // Configuration
                    Insecure: attributes.insecure,
                    "Use HTTP": attributes.use_http,

                    // Additional metadata
                    "Config Name": attributes.config_name,
                    "Shared Credentials File": attributes.shared_credentials_file,
                };

                const attributeEntries = Object.entries(providerAttributes).filter(
                    ([key, value]) => value !== undefined && value !== null && value !== ""
                );

                return `
                    <div class="tooltip-section">
                        <div class="tooltip-label">
                            <i class="fas fa-cog"></i>
                            Provider Configuration
                        </div>
                        <div class="tooltip-stat">
                            <span>ID:</span>
                            <span class="tov-code">${data.id || "N/A"}</span>
                        </div>

                        ${attributeEntries
                        .map(
                            ([key, value]) => `
                            <div class="tooltip-stat">
                                <span>${this.formatProviderKey(key)}:</span>
                                <span class="tov-code">${this.formatProviderValue(
                                key,
                                value
                            )}</span>
                            </div>
                        `
                        )
                        .join("")}

                        <!-- Additional provider metadata -->
                        ${providerData.source_file
                        ? `
                        <div class="tooltip-stat">
                            <span>Source File:</span>
                            <span class="tov-code">${providerData.source_file}</span>
                        </div>
                        `
                        : ""
                    }
                        
                        ${providerData.line_number
                        ? `
                        <div class="tooltip-stat">
                            <span>Line Number:</span>
                            <span class="tov-code">${providerData.line_number}</span>
                        </div>
                        `
                        : ""
                    }

                    </div>
                `;
            }

            formatProviderKey(key) {
                return key.replace(/_/g, " ").replace(/\b\w/g, (l) => l.toUpperCase());
            }

            formatProviderValue(key, value) {
                if (typeof value === "boolean") {
                    return value ? "Yes" : "No";
                }

                if (value === null || value === undefined) {
                    return "N/A";
                }

                if (typeof value === "object") {
                    return JSON.stringify(value);
                }

                return value;
            }

            // Method to display any additional attributes not in the predefined list
            renderAdditionalAttributes(attributes, excludedKeys) {
                if (!attributes || typeof attributes !== "object") {
                    return "";
                }

                const additionalAttrs = Object.entries(attributes)
                    .filter(
                        ([key, value]) =>
                            !excludedKeys.includes(key) &&
                            value !== undefined &&
                            value !== null &&
                            value !== "" &&
                            !key.startsWith("_") // Skip internal/metadata attributes
                    )
                    .map(
                        ([key, value]) => `
                        <div class="tooltip-stat">
                            <span>${this.formatProviderKey(key)}:</span>
                            <span class="tov-code">${this.formatProviderValue(
                            key,
                            value
                        )}</span>
                        </div>
                    `
                    )
                    .join("");

                return additionalAttrs;
            }

            createVariableSection(data) {
                const details = data.details || {};
                const attributes = details.attributes || {};

                return `
                    <div class="tooltip-section">
                        <div class="tooltip-label">
                            <i class="fas fa-code"></i>
                            Variable Configuration
                        </div>
                        <div class="tooltip-stat">
                            <span>ID:</span>
                            <span class="tov-code">${data.id || "N/A"}</span>
                        </div>
                        ${attributes.type || data.type
                        ? `
                        <div class="tooltip-stat">
                            <span>Type:</span>
                            <span class="tov-code">${attributes.type || data.type
                        }</span>
                        </div>
                        `
                        : ""
                    }
                        ${attributes.default !== undefined &&
                        attributes.default !== null
                        ? `
                        <div class="tooltip-stat">
                            <span>Default:</span>
                            <span class="tov-code">${this.formatValue(
                            attributes.default
                        )}</span>
                        </div>
                        `
                        : ""
                    }
                        ${attributes.description
                        ? `
                        <div class="tooltip-stat">
                            <span>Description:</span>
                            <span class="tov-code">${attributes.description}</span>
                        </div>
                        `
                        : ""
                    }
                        ${attributes.sensitive !== undefined
                        ? `
                        <div class="tooltip-stat">
                            <span>Sensitive:</span>
                            <span class="tov-code">${attributes.sensitive ? "Yes" : "No"
                        }</span>
                        </div>
                        `
                        : ""
                    }
                        ${attributes.nullable !== undefined
                        ? `
                        <div class="tooltip-stat">
                            <span>Nullable:</span>
                            <span class="tov-code">${attributes.nullable ? "Yes" : "No"
                        }</span>
                        </div>
                        `
                        : ""
                    }
                    </div>
                `;
            }

            createLocalSection(data) {
                const details = data.details || {};
                const attributes = details.attributes || {};

                return `
                    <div class="tooltip-section">
                        <div class="tooltip-label">
                            <i class="fas fa-terminal"></i>
                            Local Value
                        </div>
                        <div class="tooltip-stat">
                            <span>ID:</span>
                            <span class="tov-code">${data.id || "N/A"}</span>
                        </div>
          
                        ${attributes.value !== undefined
                        ? `
                        <div class="tooltip-stat">
                            <span>Value:</span>
                            <span class="tov-code">${this.formatLocalValue(
                            attributes.value
                        )}</span>
                        </div>
                        `
                        : ""
                    }
                        ${data.expression
                        ? `
                        <div class="tooltip-stat">
                            <span>Expression:</span>
                            <span class="tov-code">${data.expression}</span>
                        </div>
                        `
                        : ""
                    }
                    </div>
                `;
            }

            createModuleSection(data) {
                const details = data.details || {};
                const attributes = data.data?.attributes || details.attributes || {};

                return `
                    <div class="tooltip-section">
                        <div class="tooltip-label">
                            <i class="fas fa-cubes"></i>
                            Module Configuration
                        </div>
                        <div class="tooltip-stat">
                            <span>ID:</span>
                            <span class="tov-code">${data.id || "N/A"}</span>
                        </div>

                        ${attributes.module_source || data.source
                        ? `
                        <div class="tooltip-stat">
                            <span>Source:</span>
                            <span class="tov-code">${attributes.module_source || data.source
                        }</span>
                        </div>
                        `
                        : ""
                    }
                        ${attributes.module_version || data.version
                        ? `
                        <div class="tooltip-stat">
                            <span>Version:</span>
                            <span class="tov-code">${attributes.module_version || data.version
                        }</span>
                        </div>
                        `
                        : ""
                    }
                        ${attributes.namespace
                        ? `
                        <div class="tooltip-stat">
                            <span>Namespace:</span>
                            <span class="tov-code">${attributes.namespace}</span>
                        </div>
                        `
                        : ""
                    }
                        ${attributes.module_name
                        ? `
                        <div class="tooltip-stat">
                            <span>Module Name:</span>
                            <span class="tov-code">${attributes.module_name}</span>
                        </div>
                        `
                        : ""
                    }
                        ${attributes.source_type
                        ? `
                        <div class="tooltip-stat">
                            <span>Source Type:</span>
                            <span class="tov-code">${attributes.source_type}</span>
                        </div>
                        `
                        : ""
                    }
                        ${data.data?.module_path
                        ? `
                        <div class="tooltip-stat">
                            <span>Path:</span>
                            <span class="tov-code">${Array.isArray(data.data.module_path)
                            ? data.data.module_path.join("  ")
                            : data.data.module_path
                        }</span>
                        </div>
                        `
                        : ""
                    }
                        ${data.data?.source_file
                        ? `
                        <div class="tooltip-stat">
                            <span>Source File:</span>
                            <span class="tov-code">${data.data.source_file}</span>
                        </div>
                        `
                        : ""
                    }
                        ${data.data?.line_number
                        ? `
                        <div class="tooltip-stat">
                            <span>Line Number:</span>
                            <span class="tov-code">${data.data.line_number}</span>
                        </div>
                        `
                        : ""
                    }
                    </div>
                `;
            }

            createDataSection(data) {
                const details = data.details || {};

                return `
                    <div class="tooltip-section">
                        <div class="tooltip-label">
                            <i class="fas fa-database"></i>
                            Data Source
                        </div>
                        <div class="tooltip-stat">
                            <span>ID:</span>
                            <span class="tov-code">${data.id || "N/A"}</span>
                        </div>
                        <div class="tooltip-stat">
                            <span>Type:</span>
                            <span class="tov-code">${data.subtype || details.resource_type || "N/A"
                    }</span>
                        </div>
           
                        ${details.provider
                        ? `
                        <div class="tooltip-stat">
                            <span>Provider:</span>
                            <span class="tov-code">${details.provider}</span>
                        </div>
                        `
                        : ""
                    }
                        ${data.mode
                        ? `
                        <div class="tooltip-stat">
                            <span>Mode:</span>
                            <span class="tov-code">${data.mode}</span>
                        </div>
                        `
                        : ""
                    }
                    </div>
                `;
            }

            createOutputSection(data) {
                const details = data.details || {};
                const attributes = details.attributes || {};

                return `
                    <div class="tooltip-section">
                        <div class="tooltip-label">
                            <i class="fas fa-arrow-right"></i>
                            Output Configuration
                        </div>
                        <div class="tooltip-stat">
                            <span>ID:</span>
                            <span class="tov-code">${data.id || "N/A"}</span>
                        </div>
        
                        ${attributes.description || data.description
                        ? `
                        <div class="tooltip-stat">
                            <span>Description:</span>
                            <span class="tov-code">${attributes.description || data.description
                        }</span>
                        </div>
                        `
                        : ""
                    }
                        ${attributes.sensitive !== undefined
                        ? `
                        <div class="tooltip-stat">
                            <span>Sensitive:</span>
                            <span class="tov-code">${attributes.sensitive ? "Yes" : "No"
                        }</span>
                        </div>
                        `
                        : ""
                    }
                        ${data.value !== undefined
                        ? `
                        <div class="tooltip-stat">
                            <span>Value:</span>
                            <span class="tov-code">${this.formatValue(
                            data.value
                        )}</span>
                        </div>
                        `
                        : ""
                    }
                        ${data.depends_on
                        ? `
                        <div class="tooltip-stat">
                            <span>Depends On:</span>
                            <span class="tov-code">${Array.isArray(data.depends_on)
                            ? data.depends_on.length
                            : 0
                        } resources</span>
                        </div>
                        `
                        : ""
                    }
                    </div>
                `;
            }

            createResourceSection(data) {
                const details = data.details || {};
                const attributes = details.attributes || {};

                return `
                    <div class="tooltip-section">
                        <div class="tooltip-label">
                            <i class="fas fa-cube"></i>
                            Resource Configuration
                        </div>
                        <div class="tooltip-stat">
                            <span>ID:</span>
                            <span class="tov-code">${data.id || "N/A"}</span>
                        </div>
                        <div class="tooltip-stat">
                            <span>Type:</span>
                            <span class="tov-code">${data.subtype || details.resource_type || "N/A"
                    }</span>
                        </div>
     
                        ${details.provider || data.provider
                        ? `
                        <div class="tooltip-stat">
                            <span>Provider:</span>
                            <span class="tov-code">${details.provider || data.provider
                        }</span>
                        </div>
                        `
                        : ""
                    }
                        ${data.mode
                        ? `
                        <div class="tooltip-stat">
                            <span>Mode:</span>
                            <span class="tov-code">${data.mode}</span>
                        </div>
                        `
                        : ""
                    }
                        ${data.instances !== undefined
                        ? `
                        <div class="tooltip-stat">
                            <span>Instances:</span>
                            <span class="tov-code">${data.instances}</span>
                        </div>
                        `
                        : ""
                    }
                        ${this.createResourceConfigSection(details)}
                    </div>
                `;
            }

            createResourceConfigSection(details) {
                const items = [];

                if (details.count !== null && details.count !== undefined) {
                    items.push(`
                        <div class="tooltip-stat">
                            <span><i class="fas fa-hashtag"></i> Count:</span>
                            <span class="tov-code">${details.count}</span>
                        </div>
                    `);
                }

                if (details.for_each && Object.keys(details.for_each).length > 0) {
                    items.push(`
                        <div class="tooltip-stat">
                            <span><i class="fas fa-repeat"></i> For Each:</span>
                            <span>${Object.keys(details.for_each).length
                        } items</span>
                        </div>
                    `);
                }

                if (
                    details.lifecycle_rules &&
                    Object.keys(details.lifecycle_rules).length > 0
                ) {
                    items.push(`
                        <div class="tooltip-stat">
                            <span><i class="fas fa-recycle"></i> Lifecycle:</span>
                            <span>${Object.keys(details.lifecycle_rules).length
                        } rules</span>
                        </div>
                    `);
                }

                if (details.depends_on && details.depends_on.length > 0) {
                    items.push(`
                        <div class="tooltip-stat">
                            <span><i class="fas fa-link"></i> Depends On:</span>
                            <span>${details.depends_on.length} resources</span>
                        </div>
                    `);
                }

                return items.join("");
            }

            createBasicInfoSection(data) {
                return `
                    <div class="tooltip-section">
                        <div class="tooltip-label">
                            <i class="fas fa-info-circle"></i>
                            Basic Information
                        </div>
                        <div class="tooltip-stat">
                            <span>ID:</span>
                            <span class="tov-code">${this.truncateText(
                    data.id,
                    30
                )}</span>
                        </div>
                        <div class="tooltip-stat">
                            <span>Type:</span>
                            <span>${data.type}</span>
                        </div>
                        ${data.subtype
                        ? `
                        <div class="tooltip-stat">
                            <span>Resource:</span>
                            <span>${data.subtype}</span>
                        </div>
                        `
                        : ""
                    }
                        ${data.details?.provider
                        ? `
                        <div class="tooltip-stat">
                            <span>Provider:</span>
                            <span>${data.details.provider}</span>
                        </div>
                        `
                        : ""
                    }
                    </div>
                `;
            }

            createDependenciesSection(data) {
                const hasIncoming = (data.dependencies_in || 0) > 0;
                const hasOutgoing = (data.dependencies_out || 0) > 0;
                const totalDeps =
                    (data.dependencies_in || 0) + (data.dependencies_out || 0);

                return `
                        <div class="tooltip-section">
                            <div class="tooltip-label">
                                <i class="fas fa-code-branch fa-sm"></i>
                                Connections
                            </div>
                            <div class="tooltip-stat-compact">
                                <div class="dep-item ${hasIncoming ? "dep-active" : "dep-inactive"
                    }">
                                    <i class="fas fa-sign-in-alt fa-xs"></i>
                                    <span class="dep-label">Inbound</span>
                                    <span class="dep-count ${hasIncoming ? "dep-count-active" : ""
                    }">${data.dependencies_in || 0}</span>
                                </div>
                                <div class="dep-item ${hasOutgoing ? "dep-active" : "dep-inactive"
                    }">
                                    <i class="fas fa-sign-out-alt fa-xs"></i>
                                    <span class="dep-label">Outbound</span>
                                    <span class="dep-count ${hasOutgoing ? "dep-count-active" : ""
                    }">${data.dependencies_out || 0}</span>
                                </div>
                            </div>
                        </div>
                    `;
            }

            createLocationSection(data) {
                const details = data.details;
                return `
                    <div class="tooltip-section">
                        <div class="tooltip-label">
                            <i class="fas fa-file-code"></i>
                            Source
                        </div>
                        ${details.source_file
                        ? `
                        <div class="tooltip-stat">
                            <span>File:</span>
                            <span class="source-file">${details.source_file
                            .split("/")
                            .pop()}</span>
                        </div>
                        `
                        : ""
                    }
                        ${details.line_number
                        ? `
                        <div class="tooltip-stat">
                            <span>Line:</span>
                            <span class="source-line">${details.line_number}</span>
                        </div>
                        `
                        : ""
                    }
                    </div>
                `;
            }

            formatValue(value) {
                if (value === null || value === undefined) return "null";
                if (typeof value === "boolean") return value ? "true" : "false";
                if (Array.isArray(value))
                    return `[${value.map((v) => this.formatValue(v)).join(", ")}]`;
                if (typeof value === "object") return JSON.stringify(value);
                return String(value);
            }

            formatLocalValue(value) {
                if (value === null || value === undefined) return "null";
                if (typeof value === "string" && value.length > 50) {
                    return value.substring(0, 50) + "...";
                }
                return this.formatValue(value);
            }

            formatComplexValue(value, depth) {
                if (depth > 2) return "...";
                if (Array.isArray(value)) {
                    return `[${value
                        .map((v) => this.formatComplexValue(v, depth + 1))
                        .join(", ")}]`;
                }
                if (typeof value === "object" && value !== null) {
                    const entries = Object.entries(value).slice(0, 3);
                    const items = entries
                        .map(([k, v]) => `${k}: ${this.formatComplexValue(v, depth + 1)}`)
                        .join(", ");
                    return `{${items}${Object.keys(value).length > 3 ? ", ..." : ""}}`;
                }
                return this.truncateText(String(value), 20);
            }

            truncateText(text, maxLength) {
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength) + "...";
            }

            formatStateLabel(state) {
                return state
                    .replace(/_/g, " ")
                    .split(" ")
                    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(" ");
            }

            hide() {
                if (!this.state.isVisible) return;

                this.clearTimers();
                this.elements.container.classList.remove("tov-visible");
                this.state.isVisible = false;
                this.state.currentData = null;
            }

            hideWithDelay() {
                this.clearTimers();
                this.state.hideTimer = setTimeout(() => {
                    this.hide();
                }, this.config.hideDelay);
            }

            clearTimers() {
                if (this.state.hoverTimer) {
                    clearTimeout(this.state.hoverTimer);
                    this.state.hoverTimer = null;
                }
                if (this.state.hideTimer) {
                    clearTimeout(this.state.hideTimer);
                    this.state.hideTimer = null;
                }
            }

            cancelHide() {
                this.clearTimers();
            }

            destroy() {
                this.clearTimers();
                this.elements.container?.remove();
            }
        }
    </script>
    <script>
        const analyticsData = {{ analytics_data| safe }};

        function safeGet(obj, path, defaultValue = null) {
            if (!obj) return defaultValue;
            return path
                .split(".")
                .reduce(
                    (acc, key) => (acc && acc[key] !== undefined ? acc[key] : defaultValue),
                    obj
                );
        }

        function initializeAnalyticsUI() {
            if (!analyticsData) {
                console.warn("No analytics data available");
                return;
            }

            updateMainMetrics();
            updateStateIndicators();
            updateRiskAnalysis();
            updateAnalysisDescriptions();
        }

        function updateMainMetrics() {
            document.getElementById("node-count").textContent = safeGet(
                analyticsData,
                "total_nodes",
                0
            );
            document.getElementById("edge-count").textContent = safeGet(
                analyticsData,
                "total_edges",
                0
            );
            document.getElementById("component-count").textContent = safeGet(
                analyticsData,
                "total_components",
                0
            );

            document.getElementById("avg-dependencies").textContent = safeGet(
                analyticsData,
                "avg_in_degree",
                0
            ).toFixed(1);
            document.getElementById("max-depth").textContent = safeGet(
                analyticsData,
                "diameter",
                0
            );
            document.getElementById("complexity-score").textContent = safeGet(
                analyticsData,
                "cyclomatic_complexity",
                0
            );
        }

        function updateStateIndicators() {
            const container = document.getElementById("state-indicators");
            if (!container) return;

            const stateDistribution = safeGet(analyticsData, "state_distribution", {});
            const totalNodes = safeGet(analyticsData, "total_nodes", 1);

            if (Object.keys(stateDistribution).length === 0) {
                container.innerHTML = `
                <div class="state-item state-unknown">
                    <div class="state-header">
                    <div class="state-name">
                        <div class="state-icon">
                        <i class="fas fa-question"></i>
                        </div>
                        No State Data
                    </div>
                    </div>
                </div>
                `;
                return;
            }

            container.innerHTML = Object.entries(stateDistribution)
                .filter(([state, count]) => count > 0)
                .map(([state, count]) => {
                    const percentage = ((count / totalNodes) * 100).toFixed(1);
                    const isCritical = ["hub", "bridge", "bottleneck"].includes(state);

                    return `
                    <div class="state-item state-${state}" onclick="filterByState('${state}')">
                    <div class="state-header">
                        <div class="state-name">
                        <div class="state-icon" style="background: ${getStateColor(
                        state
                    )}20; color: ${getStateColor(state)};">
                            <i class="${getStateIcon(state)}"></i>
                        </div>
                        ${formatStateName(state)}
                        </div>
                        <div class="state-count">${count}</div>
                    </div>
                    <div class="state-info">
                        <div class="state-metric">
                        <i class="fas fa-percentage"></i>
                        ${percentage}%
                        </div>
                        ${isCritical
                            ? `
                        <div class="state-metric">
                        <i class="fas fa-exclamation-triangle"></i>
                        Critical
                        </div>
                        `
                            : ""
                        }
                    </div>
                    </div>
                `;
                })
                .join("");
        }

        function updateRiskAnalysis() {
            const container = document.getElementById("risk-section");
            if (!container) return;

            const riskDistribution = safeGet(analyticsData, "risk_distribution", {});

            if (Object.keys(riskDistribution).length === 0) {
                container.innerHTML = `
                <div class="analysis-row">
                    <div class="analysis-icon">
                    <i class="fas fa-question"></i>
                    </div>
                    <div class="analysis-content">
                    <div class="analysis-title">No Risk Data</div>
                    <div class="analysis-desc">Risk analysis unavailable</div>
                    </div>
                </div>
                `;
                return;
            }

            container.innerHTML = Object.entries(riskDistribution)
                .map(([riskLevel, count]) => {
                    const color = getRiskColor(riskLevel);
                    const icon = getRiskIcon(riskLevel);

                    return `
                    <div class="analysis-row" onclick="filterByRisk('${riskLevel}')">
                    <div class="analysis-icon" style="background: ${color}20; color: ${color};">
                        <i class="${icon}"></i>
                    </div>
                    <div class="analysis-content">
                        <div class="analysis-title">${formatRiskName(
                        riskLevel
                    )}</div>
                        <div class="analysis-desc">${count} nodes</div>
                    </div>
                    <div class="analysis-action">
                        <i class="fas fa-eye"></i>
                    </div>
                    </div>
                `;
                })
                .join("");
        }

        function updateAnalysisDescriptions() {
            const longestPaths = safeGet(analyticsData, "longest_paths", []);
            const criticalPathDesc =
                longestPaths.length > 0
                    ? `${longestPaths[0].length} nodes, ${safeGet(
                        longestPaths[0],
                        "risk_level",
                        "unknown"
                    )} risk`
                    : "Not available";
            document.getElementById("critical-path-desc").textContent = criticalPathDesc;

            // Central Nodes
            const hubNodes = safeGet(analyticsData, "hub_nodes", []);
            document.getElementById("central-nodes-desc").textContent =
                hubNodes.length > 0 ? `${hubNodes.length} hubs` : "Not available";

            const bottleneckNodes = safeGet(analyticsData, "bottleneck_nodes", []);
            document.getElementById("bottleneck-desc").textContent =
                bottleneckNodes.length > 0
                    ? `${bottleneckNodes.length} nodes`
                    : "Not available";
        }

        function getStateIcon(state) {
            const iconMap = {
                active: "fas fa-check-circle",
                hub: "fas fa-star",
                bridge: "fas fa-link",
                aggregator: "fas fa-layer-group",
                config_provider: "fas fa-file-export",
                leaf: "fas fa-leaf",
                orphan: "fas fa-unlink",
                unknown: "fas fa-question",
            };
            return iconMap[state] || "fas fa-cube";
        }

        function getStateColor(state) {
            const colorMap = {
                active: "#22c55e",
                hub: "#3b82f6",
                bridge: "#06b6d4",
                aggregator: "#8b5cf6",
                config_provider: "#84cc16",
                leaf: "#10b981",
                orphan: "#f59e0b",
            };
            return colorMap[state] || "#6b7280";
        }

        function formatStateName(state) {
            return state
                .split("_")
                .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                .join(" ");
        }

        function getRiskColor(riskLevel) {
            const colorMap = {
                high: "#ef4444",
                moderate: "#f59e0b",
                low: "#10b981",
                safe: "#3b82f6",
            };
            return colorMap[riskLevel] || "#6b7280";
        }

        function getRiskIcon(riskLevel) {
            const iconMap = {
                high: "fas fa-exclamation-triangle",
                moderate: "fas fa-exclamation-circle",
                low: "fas fa-info-circle",
                safe: "fas fa-check-circle",
            };
            return iconMap[riskLevel] || "fas fa-question";
        }

        function formatRiskName(riskLevel) {
            return riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1) + " Risk";
        }
    </script>
    <script>
        const rawDataset = {{ dataset| safe }};
        const colors = {{ theme_colors }}

        let terraformViewer;
        let graphManager;
        let resizeTimer;
        let isInitialized = false;

        const handleResize = () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (graphManager && isInitialized) {
                    graphManager.init();
                }
            }, 100);
        };

        const handleClickOutside = (event) => {
            if (!event.target.closest('.node') && !event.target.closest('.control-panel')) {
                graphManager?.clearHighlight();
            }
        };

        const initializeAnalyticsThrottled = () => {
            if (typeof initializeAnalyticsUI === 'function') {
                requestAnimationFrame(() => {
                    setTimeout(initializeAnalyticsUI, 100);
                });
            }
        };

        const initializeComponents = () => {
            if (isInitialized) return;

            try {
                graphManager = new GraphManager(rawDataset, colors);
                window.graphManager = graphManager;

                if ('requestIdleCallback' in window) {
                    requestIdleCallback(() => {
                        const commandPalette = new CommandPalette();
                        window.commandPalette = commandPalette;
                    });
                } else {
                    const commandPalette = new CommandPalette();
                    window.commandPalette = commandPalette;
                }

                terraformViewer = new TerraformObjectViewer({
                    container: '#terraform-object-viewer',
                    hoverDelay: 200,
                    hideDelay: 300,
                    usePassiveEvents: true
                });
                window.terraformViewer = terraformViewer;

                graphManager.init();

                isInitialized = true;

                setTimeout(initializeAnalyticsThrottled, 500);

            } catch (error) {
                console.error('Failed to initialize components:', error);
            }
        };

        const createSafeGlobalFunction = (fn, fallback = () => { }) => {
            return (...args) => {
                try {
                    return fn(...args);
                } catch (error) {
                    console.warn('Function execution failed:', error);
                    return fallback();
                }
            };
        };

        window.resetView = createSafeGlobalFunction(() => graphManager?.resetView());
        window.zoomIn = createSafeGlobalFunction(() => graphManager?.zoomIn());
        window.zoomOut = createSafeGlobalFunction(() => graphManager?.zoomOut());
        window.resetZoom = createSafeGlobalFunction(() => graphManager?.resetZoom());
        window.centerGraph = createSafeGlobalFunction(() => graphManager?.centerGraph());
        window.togglePhysics = createSafeGlobalFunction(() => graphManager?.togglePhysics());
        window.toggleAnimations = createSafeGlobalFunction(() => graphManager?.toggleAnimations());
        window.clearHighlight = createSafeGlobalFunction(() => graphManager?.clearHighlight());

        const setupEventListeners = () => {
            const passiveOptions = { passive: true };
            const captureOptions = { capture: true, passive: true };

            window.addEventListener('resize', handleResize, passiveOptions);
            document.addEventListener('click', handleClickOutside, captureOptions);
        };

        const teardownEventListeners = () => {
            window.removeEventListener('resize', handleResize);
            document.removeEventListener('click', handleClickOutside);
        };

        const initializeWhenReady = () => {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp, { once: true });
            } else {
                // Use setTimeout to yield to browser for initial rendering
                setTimeout(initializeApp, 0);
            }
        };

        const initializeApp = () => {
            setupEventListeners();
            initializeComponents();
        };

        const cleanup = () => {
            teardownEventListeners();
            clearTimeout(resizeTimer);

            if (graphManager) {
                graphManager.destroy?.();
            }

            window.graphManager = null;
            window.commandPalette = null;
            window.terraformViewer = null;

            isInitialized = false;
        };

        const handleVisibilityChange = () => {
            if (document.hidden) {
                graphManager?.setLowPerformanceMode?.(true);
            } else {
                graphManager?.setHighPerformanceMode?.(true);
            }
        };

        document.addEventListener('visibilitychange', handleVisibilityChange, { passive: true });

        window.addEventListener('beforeunload', cleanup, { passive: true });
        window.addEventListener('pagehide', cleanup, { passive: true });

        const monitorPerformance = () => {
            if ('performance' in window) {
                const perfObserver = new PerformanceObserver((list) => {
                    list.getEntries().forEach((entry) => {
                        if (entry.duration > 100) {
                            console.warn('Long task detected:', entry);
                        }
                    });
                });

                try {
                    perfObserver.observe({ entryTypes: ['longtask'] });
                } catch (e) {
                }
            }
        };

        initializeWhenReady();

        monitorPerformance();
    </script>
</body>

</html>